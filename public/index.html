<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FIRST-FIN Platform — Integrated</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #070d1a;
  --surface:  #0d1526;
  --surface2: #111d36;
  --border:   rgba(30,90,246,0.18);
  --border2:  rgba(30,90,246,0.35);
  --primary:  #1e5af6;
  --primary2: #2d6cff;
  --amber:    #f59e0b;
  --green:    #10b981;
  --red:      #ef4444;
  --text:     #e2e8f0;
  --muted:    #64748b;
  --card:     #0d1526;
}
/* ── LIGHT MODE ── */
body.light-mode {
  --bg:       #f0f4fa;
  --surface:  #ffffff;
  --surface2: #e8eef7;
  --border:   rgba(30,90,246,0.15);
  --border2:  rgba(30,90,246,0.30);
  --primary:  #1e5af6;
  --primary2: #2d6cff;
  --amber:    #c47600;
  --green:    #0a8f6a;
  --red:      #dc2626;
  --text:     #0f172a;
  --muted:    #64748b;
  --card:     #ffffff;
}
body.light-mode .platform-header { background: linear-gradient(135deg,#1a3a8f 0%,#1e5af6 100%); }
body.light-mode .total-bar { color: white; }
body.light-mode .payment-table th { background: var(--primary); }
body.light-mode select option { background: #ffffff; color: #0f172a; }
body.light-mode .data-table th { background: var(--primary); }
body.light-mode .programs-table th { background: rgba(30,90,246,.12); }
body.light-mode .otd-box { background: linear-gradient(135deg,var(--primary),#1248cc); }
body.light-mode .lc-header.eligible { background: linear-gradient(135deg,#057a50,#0ea572); }
body.light-mode .lc-header.credit  { background: linear-gradient(135deg,#1a3a8f,#1e5af6); }
body.light-mode .compare-vehicle-card { background: linear-gradient(135deg,#1a3a8f,#1e5af6); color: white; }
body.light-mode #toast { box-shadow: 0 4px 20px rgba(0,0,0,.2); }
body.light-mode .lender-header-box { background: linear-gradient(135deg,#f0f4fa,#e8eef7); }

*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;transition:background .3s,color .3s;}

/* ── NAV ── */
.platform-header{background:linear-gradient(135deg,#050b18 0%,#0a1530 100%);border-bottom:1px solid var(--border2);padding:0 20px;display:flex;align-items:center;gap:20px;height:60px;position:sticky;top:0;z-index:1000;}
.platform-logo{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:3px;background:linear-gradient(90deg,var(--primary),var(--amber));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap;}
.platform-logo span{color:var(--amber);-webkit-text-fill-color:var(--amber);}
.logo-sub{font-size:10px;color:var(--muted);letter-spacing:2px;font-weight:500;margin-top:-6px;}
.main-nav{display:flex;gap:4px;flex:1;margin-left:20px;}
.nav-btn{padding:8px 16px;background:none;border:1px solid transparent;border-radius:6px;color:var(--muted);font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;letter-spacing:1px;cursor:pointer;transition:all .2s;text-transform:uppercase;white-space:nowrap;}
.nav-btn:hover{background:rgba(30,90,246,0.1);color:var(--text);border-color:var(--border);}
.nav-btn.active{background:rgba(30,90,246,0.15);color:var(--primary);border-color:var(--border2);}
.nav-btn.compare-btn{background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(30,90,246,0.15));color:var(--amber);border-color:rgba(245,158,11,0.3);}
.nav-btn.compare-btn:hover,.nav-btn.compare-btn.active{background:linear-gradient(135deg,rgba(245,158,11,0.25),rgba(30,90,246,0.25));}
.header-actions{display:flex;gap:8px;margin-left:auto;}
.hbtn{padding:7px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;}
.hbtn:hover{background:var(--primary);border-color:var(--primary);color:white;}
.hbtn.theme-toggle{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.4);color:var(--amber);font-weight:700;letter-spacing:.5px;}
.hbtn.theme-toggle:hover{background:var(--amber);color:#000;}
body.light-mode .hbtn.theme-toggle{background:rgba(30,90,246,.1);border-color:rgba(30,90,246,.4);color:var(--primary);}
body.light-mode .hbtn.theme-toggle:hover{background:var(--primary);color:white;}

/* ── SECTIONS ── */
.section{display:none;padding:20px;min-height:calc(100vh - 60px);}
.section.active{display:block;}

/* ── CARDS ── */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:16px;}
.card-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;color:var(--primary);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.card-title.amber{color:var(--amber);}
.card-title.green{color:var(--green);}

/* ── GRID LAYOUTS ── */
.deal-grid{display:grid;grid-template-columns:1fr 1.2fr;gap:16px;}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
.four-col{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;}

/* ── FORM ELEMENTS ── */
.fgroup{margin-bottom:10px;}
.fgroup label{display:block;font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;}
.fgroup input,.fgroup select,.fgroup textarea{width:100%;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Outfit',sans-serif;font-size:13px;transition:border .2s;}
.fgroup input:focus,.fgroup select:focus,.fgroup textarea:focus{outline:none;border-color:var(--primary);background:rgba(30,90,246,0.05);}
.fgroup input[readonly]{background:#060c18;color:var(--amber);font-weight:700;border-color:rgba(245,158,11,0.2);}
select option{background:#0d1526;color:var(--text);}

/* ── BUTTONS ── */
.btn{padding:9px 18px;border:none;border-radius:6px;font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;letter-spacing:.5px;text-transform:uppercase;}
.btn-primary{background:var(--primary);color:white;}
.btn-primary:hover{background:var(--primary2);transform:translateY(-1px);}
.btn-success{background:var(--green);color:white;}
.btn-success:hover{opacity:.9;}
.btn-amber{background:var(--amber);color:#000;}
.btn-amber:hover{opacity:.9;}
.btn-danger{background:var(--red);color:white;}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted);}
.btn-ghost:hover{border-color:var(--primary);color:var(--text);}
.btn-full{width:100%;padding:11px;}
.btn-sm{padding:6px 12px;font-size:11px;}
.btn-bridge{background:linear-gradient(135deg,var(--amber),#e07b00);color:#000;font-weight:800;font-size:13px;padding:12px 24px;border-radius:8px;letter-spacing:1px;}
.btn-bridge:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(245,158,11,0.4);}

/* ── PAYMENT GRID ── */
.payment-wrap{overflow-x:auto;}
.payment-table{width:100%;border-collapse:collapse;font-size:13px;}
.payment-table th{background:var(--primary);color:white;padding:10px 8px;text-align:center;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:1px;}
.payment-table td{padding:11px 8px;text-align:center;border-bottom:1px solid var(--border);}
.payment-table tr:hover td{background:rgba(30,90,246,0.06);}
.payment-val{font-weight:800;color:var(--amber);font-size:15px;}
.otd-box{background:linear-gradient(135deg,var(--primary),#0f3db8);border-radius:8px;padding:18px;text-align:center;margin-top:12px;}
.otd-label{font-size:12px;opacity:.8;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;}
.otd-amount{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:2px;}

/* ── PRODUCT BOXES ── */
.product-box{background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--green);border-radius:8px;padding:14px;margin-bottom:10px;}
.product-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.product-name{font-weight:700;font-size:13px;}
.product-impact{font-size:11px;color:var(--green);}
.product-price{width:120px;padding:7px 10px;background:var(--bg);border:1px solid var(--green);border-radius:6px;font-size:15px;font-weight:700;text-align:right;color:var(--green);font-family:'Outfit',sans-serif;}

/* ── COMPARISON ROW ── */
.comp-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);}
.comp-row:last-child{border:none;}
.comp-label{color:var(--muted);font-size:12px;font-weight:600;}
.comp-value{font-weight:700;color:var(--text);}

/* ── MANAGER TABS ── */
.mgr-tabs{display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap;}
.mgr-tab{padding:8px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;color:var(--muted);transition:all .2s;font-family:'Outfit',sans-serif;text-transform:uppercase;letter-spacing:.5px;}
.mgr-tab:hover{border-color:var(--primary);color:var(--text);}
.mgr-tab.active{background:rgba(30,90,246,0.15);border-color:var(--border2);color:var(--primary);}
.mgr-content{display:none;}
.mgr-content.active{display:block;}

/* ── CALC ROWS ── */
.cline{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);font-size:13px;}
.cline:last-child{border:none;}
.cl-label{color:var(--muted);}
.cl-value{font-weight:700;}
.total-bar{background:linear-gradient(135deg,var(--green),#0a9d6a);color:white;padding:14px;border-radius:8px;text-align:center;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;margin-top:12px;}

/* ── INVENTORY TABLE ── */
.inv-search{display:flex;gap:10px;margin-bottom:16px;}
.inv-search input{flex:1;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Outfit',sans-serif;font-size:13px;}
.inv-search input:focus{outline:none;border-color:var(--primary);}
.inv-count{background:var(--primary);color:white;padding:6px 14px;border-radius:6px;font-size:12px;font-weight:700;white-space:nowrap;align-self:center;}
.data-table{width:100%;border-collapse:collapse;font-size:12px;}
.data-table th{background:var(--primary);color:white;padding:10px 8px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.8px;position:sticky;top:0;z-index:5;}
.data-table td{padding:9px 8px;border-bottom:1px solid var(--border);color:var(--text);}
.data-table tr:hover td{background:rgba(30,90,246,0.07);cursor:pointer;}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;}
.badge-clean{background:rgba(16,185,129,.15);color:var(--green);}
.badge-avg{background:rgba(245,158,11,.15);color:var(--amber);}
.badge-rough{background:rgba(239,68,68,.15);color:var(--red);}
.table-wrap{max-height:70vh;overflow-y:auto;border:1px solid var(--border);border-radius:8px;}

/* ── LENDER TABS ── */
.lender-tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px;background:var(--surface2);padding:10px;border-radius:8px;border:1px solid var(--border);}
.ltab{padding:7px 12px;background:none;border:1px solid var(--border);border-radius:5px;cursor:pointer;font-size:11px;font-weight:700;color:var(--muted);transition:all .2s;font-family:'Outfit',sans-serif;white-space:nowrap;}
.ltab:hover{background:rgba(30,90,246,0.1);color:var(--text);}
.ltab.active{background:var(--primary);color:white;border-color:var(--primary);}
.ltab.compare-ltab{background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(30,90,246,.1));color:var(--amber);border-color:rgba(245,158,11,.3);}
.ltab.compare-ltab.active{background:linear-gradient(135deg,var(--amber),#e07b00);color:#000;}
.lcontent{display:none;}
.lcontent.active{display:block;}

/* ── LENDER INFO ── */
.lender-header-box{background:linear-gradient(135deg,#050b18,#0a1835);border:1px solid var(--border2);border-left:4px solid var(--primary);border-radius:8px;padding:18px;margin-bottom:18px;}
.lender-name-big{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:white;margin-bottom:6px;}
.lender-contact-row{display:flex;gap:20px;flex-wrap:wrap;font-size:12px;color:var(--muted);}
.lender-contact-row span{color:var(--amber);}
.programs-table{width:100%;border-collapse:collapse;font-size:11px;margin-bottom:20px;}
.programs-table th{background:rgba(30,90,246,.25);color:var(--primary);padding:9px 8px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:.8px;}
.programs-table td{padding:8px;border-bottom:1px solid var(--border);}
.programs-table tr:hover td{background:rgba(30,90,246,.05);}
.warning-box{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.3);border-radius:6px;padding:12px;margin-bottom:14px;font-size:12px;color:var(--amber);}

/* ── APPROVAL CHECKER ── */
.checker-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:18px;margin-top:16px;}
.checker-title{font-weight:700;font-size:14px;margin-bottom:14px;color:var(--text);}
.v-details-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin:14px 0;}
.vd-item{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px;}
.vd-item .vd-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
.vd-item .vd-value{font-size:13px;font-weight:700;}
.val-row{display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--surface);border-radius:6px;margin-bottom:6px;}
.val-req{font-weight:600;font-size:12px;}
.val-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.status-pill{padding:5px 14px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap;}
.pill-pass{background:rgba(16,185,129,.15);color:var(--green);}
.pill-fail{background:rgba(239,68,68,.15);color:var(--red);}
.pill-na{background:rgba(100,116,139,.15);color:var(--muted);}
.decision-box{margin-top:14px;padding:16px;border-radius:8px;text-align:center;font-weight:800;font-size:16px;letter-spacing:1px;}
.decision-approved{background:rgba(16,185,129,.12);border:2px solid var(--green);color:var(--green);}
.decision-rejected{background:rgba(239,68,68,.1);border:2px solid var(--red);color:var(--red);}
.decision-credit{background:rgba(30,90,246,.1);border:2px solid var(--primary);color:var(--primary);}
.ltv-result-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-top:14px;}
.ltv-bar-wrap{background:var(--bg);border-radius:6px;height:8px;overflow:hidden;margin:8px 0 4px;}
.ltv-bar{height:8px;border-radius:6px;transition:width .5s ease;}
.ltv-ok{background:linear-gradient(90deg,var(--green),#34d399);}
.ltv-warn{background:linear-gradient(90deg,var(--amber),#fbbf24);}
.ltv-over{background:linear-gradient(90deg,var(--red),#f87171);}

/* ── COMPARE ENGINE ── */
.compare-input-bar{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:20px;}
.compare-vehicle-card{background:linear-gradient(135deg,#070d1a,#0a1530);border:1px solid var(--border2);border-radius:10px;padding:18px;margin-bottom:20px;}
.compare-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:14px;margin-bottom:14px;}
.lender-card{border:2px solid var(--green);border-radius:10px;overflow:hidden;background:var(--surface);transition:transform .2s;}
.lender-card:hover{transform:translateY(-3px);}
.lender-card.credit-based{border-color:var(--primary);}
.lender-card.ineligible{border-color:var(--border);opacity:.55;}
.lc-header{padding:12px 15px;display:flex;justify-content:space-between;align-items:center;}
.lc-header.eligible{background:linear-gradient(135deg,#065f46,#10b981);}
.lc-header.credit{background:linear-gradient(135deg,#1e3a8a,#1e5af6);}
.lc-header.ineligible{background:#1a1f2e;}
.lc-name{font-size:13px;font-weight:800;color:white;}
.lc-check{font-size:18px;}
.lc-body{padding:14px;}
.lc-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px;}
.lc-row:last-child{border:none;}
.lc-lbl{color:var(--muted);font-weight:600;}
.lc-val{font-weight:800;}
.lc-val.green{color:var(--green);}
.lc-val.blue{color:var(--primary);}
.lc-val.red{color:var(--red);}
.fail-reason{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--red);background:rgba(239,68,68,.08);border-radius:5px;padding:5px 8px;margin-top:4px;}
.section-label{font-size:12px;font-weight:800;letter-spacing:1px;padding:9px 14px;border-radius:6px;margin-bottom:10px;display:flex;align-items:center;gap:8px;text-transform:uppercase;}
.section-label.eligible{background:rgba(16,185,129,.1);color:var(--green);}
.section-label.ineligible{background:var(--surface2);color:var(--muted);margin-top:18px;}
.count-pill{padding:2px 10px;border-radius:10px;font-size:11px;}
.count-pill.green{background:var(--green);color:white;}
.count-pill.gray{background:var(--muted);color:white;}
.summary-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;}
.sum-pill{padding:7px 16px;border-radius:20px;font-size:12px;font-weight:700;}
.sum-green{background:rgba(16,185,129,.12);color:var(--green);}
.sum-red{background:rgba(239,68,68,.12);color:var(--red);}
.sum-blue{background:rgba(30,90,246,.12);color:var(--primary);}
.compare-placeholder{text-align:center;padding:60px 20px;color:var(--muted);}
.placeholder-icon{font-size:60px;margin-bottom:16px;}
.placeholder-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:var(--primary);margin-bottom:8px;}

/* ── ANALYTICS ── */
.stat-hero{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.stat-card{background:linear-gradient(135deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:10px;padding:18px;text-align:center;}
.stat-number{font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:2px;color:var(--amber);}
.stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px;}
.penetration-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.pen-card{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;text-align:center;}
.pen-pct{font-family:'Bebas Neue',sans-serif;font-size:30px;color:var(--primary);}
.pen-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.pen-sub{font-size:11px;color:var(--green);margin-top:3px;}

/* ── CHECKLIST ── */
.chk-item{display:flex;align-items:center;gap:10px;padding:9px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;margin-bottom:6px;}
.chk-item input[type=checkbox]{width:16px;height:16px;cursor:pointer;accent-color:var(--green);}
.chk-item label{font-size:12px;color:var(--text);cursor:pointer;flex:1;}

/* ── CRM TABLE ── */
.crm-status{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;border:none;font-family:'Outfit',sans-serif;cursor:pointer;}

/* ── TOAST ── */
#toast{position:fixed;bottom:24px;right:24px;background:var(--green);color:white;padding:13px 20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:9999;opacity:0;transform:translateY(10px);transition:all .3s;font-weight:700;font-size:13px;pointer-events:none;}
#toast.show{opacity:1;transform:translateY(0);}

/* ── MODALS ── */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:5000;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal-box{background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:28px;width:90%;max-width:700px;max-height:85vh;overflow-y:auto;}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--primary);margin-bottom:18px;}
.modal-close{float:right;font-size:26px;cursor:pointer;color:var(--muted);line-height:1;background:none;border:none;}
.modal-close:hover{color:var(--text);}

/* ── QUICK REF TABLE ── */
.qr-table{width:100%;border-collapse:collapse;font-size:11px;}
.qr-table th{background:var(--primary);color:white;padding:9px 6px;text-align:left;font-weight:600;text-transform:uppercase;letter-spacing:.5px;}
.qr-table td{padding:8px 6px;border-bottom:1px solid var(--border);}
.qr-table tr:hover td{background:rgba(30,90,246,.05);}

/* ── MINI TOOLS ── */
.mini-calc{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:12px;}
.mini-title{font-weight:700;font-size:13px;color:var(--amber);margin-bottom:10px;}
.calc-result{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;margin-top:10px;font-weight:700;font-size:15px;color:var(--green);text-align:center;}

/* ── SETTINGS ── */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}


/* ── PRESENTATION MODE ── */
#presentationOverlay{display:none;position:fixed;inset:0;background:linear-gradient(135deg,#020812 0%,#050f28 50%,#020812 100%);z-index:9000;flex-direction:column;align-items:center;justify-content:center;padding:40px;}
#presentationOverlay.open{display:flex;}
.pres-dealership{font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;letter-spacing:4px;color:rgba(245,158,11,.7);text-transform:uppercase;margin-bottom:20px;}
.pres-vehicle{font-family:'Bebas Neue',sans-serif;font-size:clamp(36px,6vw,72px);letter-spacing:4px;color:white;text-align:center;margin-bottom:8px;line-height:1;}
.pres-sub{font-size:14px;color:rgba(255,255,255,.4);letter-spacing:3px;text-transform:uppercase;margin-bottom:50px;}
.pres-payment-ladder{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:50px;}
.pres-pmt-card{background:rgba(255,255,255,.04);border:1px solid rgba(30,90,246,.3);border-radius:14px;padding:24px 30px;text-align:center;min-width:160px;}
.pres-pmt-card.featured{background:linear-gradient(135deg,rgba(30,90,246,.2),rgba(245,158,11,.1));border-color:var(--amber);transform:scale(1.08);}
.pres-term{font-size:11px;color:rgba(255,255,255,.5);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;}
.pres-amount{font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:2px;}
.pres-pmt-card.featured .pres-amount{color:var(--amber);}
.pres-pmt-card:not(.featured) .pres-amount{color:white;}
.pres-monthly{font-size:11px;color:rgba(255,255,255,.4);margin-top:4px;}
.pres-footer{font-size:11px;color:rgba(255,255,255,.3);text-align:center;}
.pres-close{position:fixed;top:24px;right:24px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:white;padding:10px 18px;cursor:pointer;font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;letter-spacing:1px;z-index:9001;}
.pres-close:hover{background:rgba(239,68,68,.3);border-color:var(--red);}
.pres-obo{font-size:12px;color:rgba(255,255,255,.35);margin-top:6px;}
.pres-down-note{font-size:11px;color:rgba(245,158,11,.6);margin-top:4px;}

/* ── BEACON LENDER BADGES ── */
.beacon-lender-row{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:8px;}
.bln-title{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.bln-badges{display:flex;flex-wrap:wrap;gap:6px;}
.bln-badge{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.5px;white-space:nowrap;}
.bln-green{background:rgba(16,185,129,.15);color:var(--green);border:1px solid rgba(16,185,129,.3);}
.bln-amber{background:rgba(245,158,11,.12);color:var(--amber);border:1px solid rgba(245,158,11,.25);}
.bln-red{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2);}
.bln-blue{background:rgba(30,90,246,.12);color:var(--primary);border:1px solid rgba(30,90,246,.25);}

/* ── DEAL SCENARIOS ── */
.scenario-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:0 20px 20px;}
.scenario-card{background:var(--surface);border:2px solid var(--border);border-radius:10px;padding:16px;transition:border .2s;}
.scenario-card.has-data{border-color:var(--border2);}
.scenario-card.active-scenario{border-color:var(--amber);}
.sc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.sc-label-input{background:none;border:none;border-bottom:1px solid var(--border);color:var(--amber);font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;width:130px;padding:2px 0;outline:none;}
.sc-label-input:focus{border-bottom-color:var(--amber);}
.sc-badge{font-size:10px;color:var(--muted);font-weight:600;letter-spacing:1px;text-transform:uppercase;}
.sc-data{font-size:11px;color:var(--muted);line-height:1.8;min-height:70px;}
.sc-data strong{color:var(--text);}
.sc-data .sc-payment{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--green);letter-spacing:1px;display:block;margin-bottom:2px;}
.sc-actions{display:flex;gap:6px;margin-top:10px;}

/* ── RATE COMPARISON ROW ── */
.rate-compare-card{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-top:12px;}
.rc-title{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;}
.rate-compare-table{width:100%;border-collapse:collapse;font-size:12px;}
.rate-compare-table th{padding:8px 6px;text-align:center;font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);}
.rate-compare-table td{padding:8px 6px;text-align:center;border-bottom:1px solid var(--border);}
.rate-compare-table td:first-child{text-align:left;color:var(--muted);font-weight:600;}
.rate-compare-table tr:last-child td{border:none;}
.rc-buy{color:var(--green);font-weight:800;}
.rc-contract{color:var(--amber);font-weight:800;}
.rc-max{color:var(--red);font-weight:800;}
.rc-rate-inputs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}

/* ── COMMISSION CALCULATOR ── */
.comm-result-box{background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(30,90,246,.06));border:1px solid rgba(16,185,129,.25);border-radius:8px;padding:14px;margin-top:12px;}
.comm-big{font-family:'Bebas Neue',sans-serif;font-size:38px;color:var(--green);letter-spacing:2px;}
.comm-breakdown{font-size:11px;color:var(--muted);margin-top:4px;}

/* ── PRINT WORKSHEET ── */
@media print{
  body *{display:none;}
  #printWorksheet,#printWorksheet *{display:block!important;}
  #printWorksheet{position:fixed;inset:0;padding:20px;font-family:'Outfit',sans-serif;font-size:11px;color:#000;background:white;}
  .pw-header{text-align:center;border-bottom:3px solid #1e5af6;padding-bottom:12px;margin-bottom:16px;}
  .pw-title{font-size:24px;font-weight:900;letter-spacing:2px;color:#1e5af6;}
  .pw-sub{font-size:10px;color:#666;letter-spacing:2px;margin-top:2px;}
  .pw-grid{display:grid!important;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
  .pw-section{border:1px solid #ddd;border-radius:6px;padding:10px;}
  .pw-section-title{font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:1px;color:#1e5af6;margin-bottom:8px;border-bottom:1px solid #eee;padding-bottom:4px;}
  .pw-row{display:flex!important;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f5f5f5;font-size:10px;}
  .pw-row strong{font-weight:700;}
  .pw-payment-grid{display:grid!important;grid-template-columns:repeat(5,1fr);gap:0;border:1px solid #ddd;border-radius:6px;overflow:hidden;margin-bottom:16px;}
  .pw-pg-cell{padding:8px 4px;text-align:center;border-right:1px solid #ddd;border-bottom:1px solid #ddd;font-size:10px;}
  .pw-pg-cell.header{background:#1e5af6;color:white;font-weight:700;font-size:9px;letter-spacing:.5px;}
  .pw-pg-cell:nth-child(5n){border-right:none;}
  .pw-pg-cell.payment{font-weight:800;color:#1e5af6;}
  .pw-sig{display:grid!important;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;}
  .pw-sig-line{border-top:1px solid #000;padding-top:6px;font-size:9px;color:#666;}
  .pw-otd{text-align:center;background:#f0f4fa;border:2px solid #1e5af6;border-radius:8px;padding:12px;margin-bottom:12px;}
  .pw-otd-amount{font-size:28px;font-weight:900;color:#1e5af6;}
  .pw-disclaimer{font-size:8px;color:#999;text-align:center;margin-top:12px;border-top:1px solid #eee;padding-top:8px;}
}
#printWorksheet{display:none;}

/* ── LENDER RATE EDITOR ── */
.lre-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.lre-card{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;}
.lre-name{font-weight:800;font-size:13px;color:var(--primary);margin-bottom:10px;}
.lre-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}


/* ══════════════════════════════════════════════
   SARAH SECTION STYLES
══════════════════════════════════════════════ */
/* Conversation list */
.conv-item{background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;overflow:hidden;transition:border-color .2s;}
.conv-item:hover{border-color:var(--border2);}
.conv-header{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer;}
.conv-header:hover{background:rgba(30,90,246,.04);}
.conv-avatar{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--primary2));display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.conv-info{flex:1;min-width:0;}
.conv-name{font-weight:700;font-size:13px;color:var(--text);}
.conv-phone{font-size:11px;color:var(--muted);margin-top:1px;}
.conv-meta{font-size:11px;color:var(--muted);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.conv-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0;}
.conv-time{font-size:10px;color:var(--muted);}
.conv-badge{padding:3px 8px;border-radius:10px;font-size:10px;font-weight:700;}
.badge-active{background:rgba(16,185,129,.15);color:var(--green);border:1px solid rgba(16,185,129,.3);}
.badge-converted{background:rgba(30,90,246,.12);color:var(--primary);border:1px solid rgba(30,90,246,.2);}
.badge-stopped{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2);}

/* Message thread */
.conv-thread{display:none;padding:0 16px 16px;border-top:1px solid var(--border);}
.conv-thread.open{display:block;}
.msg-bubble{padding:10px 14px;border-radius:10px;margin:6px 0;max-width:80%;font-size:12px;line-height:1.5;}
.msg-bubble.user{background:rgba(30,90,246,.12);border:1px solid rgba(30,90,246,.2);margin-left:auto;text-align:right;}
.msg-bubble.assistant{background:var(--surface2);border:1px solid var(--border);}
.msg-role{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px;}
.msg-bubble.user .msg-role{color:var(--primary);}
.msg-bubble.assistant .msg-role{color:var(--cyan,#06b6d4);}
.msg-time{font-size:10px;color:var(--muted);margin-top:4px;}
.reply-bar{display:flex;gap:8px;margin-top:12px;}
.reply-input-field{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:10px 14px;font-size:13px;font-family:'Outfit',sans-serif;}
.reply-input-field:focus{outline:none;border-color:var(--primary);}

/* Appointment / callback cards */
.appt-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:10px;}
.appt-top{display:flex;justify-content:space-between;align-items:flex-start;cursor:pointer;}
.appt-name{font-weight:700;font-size:13px;color:var(--text);}
.appt-vehicle{font-size:11px;color:var(--primary);margin-top:2px;}
.appt-detail{font-size:11px;color:var(--muted);padding-top:10px;border-top:1px solid var(--border);margin-top:10px;display:none;line-height:2;}
.appt-detail.open{display:block;}
.detail-label{color:var(--muted);font-weight:600;}
.detail-val{color:var(--text);}

/* Bulk SMS */
.bulk-zone{border:2px dashed var(--border);border-radius:10px;padding:30px;text-align:center;cursor:pointer;transition:border-color .2s,background .2s;}
.bulk-zone:hover,.bulk-zone.drag-over{border-color:var(--primary);background:rgba(30,90,246,.04);}
.bulk-progress{background:var(--surface2);border:1px solid var(--border);border-radius:8px;overflow:hidden;height:10px;margin:8px 0;}
.bulk-progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--green));transition:width .5s;}
.status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;}
.status-running{background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse-green 1.5s infinite;}
.status-paused{background:var(--amber);}
.status-stopped{background:var(--red);}

/* Sarah stats hero */
.sarah-stat-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:16px;}
.sarah-stat{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;text-align:center;}
.sarah-stat-num{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:2px;}
.sarah-stat-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px;}

/* Analytics insight cards */
.insight-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.insight-card{border-radius:10px;padding:18px;}
.insight-big{font-family:'Bebas Neue',sans-serif;font-size:40px;letter-spacing:2px;line-height:1;}
.insight-label{font-size:11px;opacity:.8;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;}
.insight-sub{font-size:11px;opacity:.7;margin-top:4px;}

/* Phone input formatter */
.phone-fmt{font-family:'JetBrains Mono',monospace;letter-spacing:.5px;}

@media(max-width:900px){
  .sarah-stat-grid{grid-template-columns:repeat(3,1fr);}
  .insight-grid{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:600px){
  .sarah-stat-grid{grid-template-columns:repeat(2,1fr);}
  .insight-grid{grid-template-columns:1fr;}
}

@media(max-width:900px){
  .deal-grid{grid-template-columns:1fr;}
  .stat-hero,.penetration-grid{grid-template-columns:1fr 1fr;}
  .compare-input-bar{grid-template-columns:1fr 1fr;}
  .four-col,.three-col{grid-template-columns:1fr 1fr;}
  .scenario-strip{grid-template-columns:1fr 1fr;}
  .lre-grid{grid-template-columns:1fr;}
  .rc-rate-inputs{grid-template-columns:1fr 1fr;}
}
@media(max-width:600px){
  .main-nav{display:none;}
  .stat-hero,.penetration-grid,.two-col,.three-col,.four-col{grid-template-columns:1fr;}
  .scenario-strip{grid-template-columns:1fr;}
  .pres-payment-ladder{flex-direction:column;align-items:center;}
}

/* ══════════════════════════════════════════════
   MOBILE HAMBURGER MENU
══════════════════════════════════════════════ */
.hamburger{
  display:none;
  flex-direction:column;
  justify-content:center;
  gap:5px;
  width:40px;height:40px;
  padding:8px;
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:8px;
  cursor:pointer;
  flex-shrink:0;
  z-index:1001;
}
.hamburger span{
  display:block;width:100%;height:2px;
  background:var(--text);border-radius:2px;
  transition:all .25s ease;
}
.hamburger.open span:nth-child(1){ transform:translateY(7px) rotate(45deg); }
.hamburger.open span:nth-child(2){ opacity:0; transform:scaleX(0); }
.hamburger.open span:nth-child(3){ transform:translateY(-7px) rotate(-45deg); }

/* Slide-down mobile menu */
.mobile-menu{
  display:none;
  position:fixed;
  top:60px;left:0;right:0;
  background:var(--surface);
  border-bottom:1px solid var(--border2);
  box-shadow:0 8px 32px rgba(0,0,0,.4);
  z-index:1000;
  padding:12px;
  flex-direction:column;
  gap:4px;
  max-height:calc(100vh - 60px);
  overflow-y:auto;
}
.mobile-menu.open{ display:flex; }
.mobile-menu-section{
  font-size:10px;font-weight:700;letter-spacing:2px;
  color:var(--muted);text-transform:uppercase;
  padding:8px 10px 4px;
}
.mobile-nav-btn{
  display:flex;align-items:center;gap:10px;
  padding:12px 14px;border-radius:8px;
  font-size:14px;font-weight:600;color:var(--text);
  background:transparent;border:none;cursor:pointer;
  transition:background .15s;text-align:left;width:100%;
}
.mobile-nav-btn:hover,.mobile-nav-btn.active{
  background:rgba(30,90,246,.12);color:var(--primary);
}
.mobile-action-btn{
  display:flex;align-items:center;gap:10px;
  padding:11px 14px;border-radius:8px;
  font-size:13px;font-weight:600;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);cursor:pointer;transition:background .15s;
  text-align:left;width:100%;
}
.mobile-action-btn:hover{ background:var(--border); }
.mobile-menu-divider{
  height:1px;background:var(--border);margin:6px 0;
}
/* Overlay backdrop */
.mobile-menu-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.5);z-index:999;
}
.mobile-menu-overlay.open{ display:block; }

@media(max-width:768px){
  .hamburger{ display:flex; }
  .main-nav{ display:none !important; }
  .header-actions{ display:none !important; }
  .platform-header{
    padding:0 14px;
    height:60px;
    display:flex;align-items:center;
    justify-content:space-between;
  }
  /* Make sections full width with less padding */
  .section{ padding:12px; }
  /* Lender table — horizontal scroll container */
  .lender-results-table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  /* Deal desk header row */
  .deal-output-header{ font-size:11px; }
  /* Tighten cards on mobile */
  .card{ padding:14px; }
  .card-title{ font-size:13px; }
  /* Bigger tap targets on inputs */
  input,select,textarea{ font-size:16px !important; } /* prevents iOS zoom */
}

@media print{
  .platform-header,.header-actions{display:none!important;}
  #section-lenders,#section-compare,#section-analytics,#section-inventory{display:none!important;}
  #section-deal{display:block!important;}
  body{background:white;color:#000;}
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- ═══ DT SYNC ═══ -->
<section id="section-dtsync" class="section">
<style>
.dt-stat-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:20px;}
.dt-stat{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;text-align:center;}
.dt-stat .val{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--primary);line-height:1;}
.dt-stat .lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-top:3px;}
.dt-progress-bg{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin:10px 0 6px;}
.dt-progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--green));border-radius:4px;transition:width .4s;}
.dt-feed{height:260px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--surface);}
.dt-feed-row{display:flex;justify-content:space-between;align-items:flex-start;padding:9px 14px;border-bottom:1px solid var(--border);font-size:12px;animation:dtFade .3s ease;}
.dt-feed-row:last-child{border-bottom:none;}
@keyframes dtFade{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.dt-feed-name{font-weight:600;}
.dt-feed-detail{color:var(--muted);font-size:11px;}
.dt-badge-src{font-size:10px;padding:2px 8px;border-radius:20px;background:rgba(16,185,129,.15);color:var(--green);font-weight:700;white-space:nowrap;}
.dt-badge-co{background:rgba(139,92,246,.15);color:#8b5cf6;}
.dt-log{height:260px;overflow-y:auto;background:#040810;border:1px solid var(--border);border-radius:8px;padding:12px;font-family:'Courier New',monospace;font-size:11px;}
.dt-log-line{color:#7dd3fc;line-height:1.7;white-space:pre-wrap;}
.dt-log-line.ok{color:#86efac;}
.dt-log-line.err{color:#fca5a5;}
.dt-setup{background:rgba(30,90,246,.07);border:1px solid rgba(30,90,246,.25);border-radius:10px;padding:16px 20px;margin-bottom:20px;font-size:13px;line-height:1.8;}
.dt-setup strong{color:#93c5fd;}
.dt-setup code{background:rgba(30,90,246,.15);padding:1px 7px;border-radius:4px;font-size:11px;color:#c4b5fd;}
.dt-bridge-row{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 20px;margin-bottom:20px;}
.dt-dot{width:10px;height:10px;border-radius:50%;background:#374151;flex-shrink:0;}
.dt-dot.green{background:#10b981;box-shadow:0 0 8px #10b981;}
.dt-dot.red{background:#ef4444;box-shadow:0 0 8px #ef4444;}
.dt-dot.yellow{background:#f59e0b;box-shadow:0 0 8px #f59e0b;}
.dt-bridge-label{display:flex;align-items:center;gap:10px;font-size:13px;}
.dt-ctrl-row{display:flex;gap:8px;flex-wrap:wrap;}
.dt-btn{padding:8px 18px;border-radius:7px;border:none;cursor:pointer;font-weight:700;font-size:12px;font-family:'Outfit',sans-serif;transition:opacity .15s;}
.dt-btn:disabled{opacity:.35;cursor:not-allowed;}
.dt-btn.start{background:var(--green);color:#000;}
.dt-btn.stop{background:var(--red);color:#fff;}
.dt-btn.crm{background:var(--primary);color:#fff;}
.dt-btn.export{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
.dt-btn.clear{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
.dt-crm-toast{position:fixed;bottom:24px;right:24px;background:var(--green);color:#000;font-weight:700;font-size:13px;padding:10px 20px;border-radius:10px;z-index:9999;display:none;}
</style>

<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
  <div>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:4px;background:linear-gradient(90deg,#10b981,#1e5af6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">DT SYNC</div>
    <div style="font-size:11px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;">Dealertrack Auto-Scraper &middot; Pushes directly to CRM</div>
  </div>
</div>

<div class="dt-setup" id="dt-setup-box">
  <strong>One-time setup:</strong><br>
  1. Install: <code>pip install playwright flask flask-cors &amp;&amp; python -m playwright install chromium</code><br>
  2. Open Chrome: <code>chrome.exe --remote-debugging-port=9222 --user-data-dir="C:\chrome-dt-session"</code><br>
  3. Log into Dealertrack &rarr; go to <strong>Status</strong> page<br>
  4. In a second terminal: <code>python dealertrack_scraper.py</code><br>
  5. Click <strong>Start Scraper</strong> below
</div>

<div class="dt-bridge-row">
  <div class="dt-bridge-label">
    <div class="dt-dot" id="dt-dot"></div>
    <span id="dt-bridge-label">Checking bridge on localhost:5001...</span>
  </div>
  <div class="dt-ctrl-row">
    <button class="dt-btn start" id="dt-btn-start" onclick="dtStart()" disabled>&#9654; Start Scraper</button>
    <button class="dt-btn stop"  id="dt-btn-stop"  onclick="dtStop()"  disabled>&#9209; Stop</button>
    <button class="dt-btn crm"   id="dt-btn-crm"   onclick="dtPushCRM()" disabled>&#128101; Push to CRM</button>
    <button class="dt-btn export" onclick="dtExportCSV()">&#8595; CSV</button>
    <button class="dt-btn clear"  onclick="dtClear()">&#128465; Clear</button>
  </div>
</div>

<div class="card" style="padding:16px 20px;margin-bottom:16px;">
  <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;">
    <span id="dt-prog-label">Waiting to start...</span>
    <span id="dt-prog-pct" style="font-weight:700;color:var(--primary);">0%</span>
  </div>
  <div class="dt-progress-bg"><div class="dt-progress-fill" id="dt-prog-fill" style="width:0%"></div></div>
  <div style="font-size:11px;color:var(--muted);" id="dt-prog-msg">&mdash;</div>
</div>

<div class="dt-stat-row">
  <div class="dt-stat"><div class="val" id="dt-s-total">0</div><div class="lbl">Contacts</div></div>
  <div class="dt-stat"><div class="val" id="dt-s-deals">0</div><div class="lbl">Deals Done</div></div>
  <div class="dt-stat"><div class="val" id="dt-s-remain">&mdash;</div><div class="lbl">Remaining</div></div>
  <div class="dt-stat"><div class="val" id="dt-s-crm" style="color:var(--green);">0</div><div class="lbl">In CRM</div></div>
</div>

<div class="two-col" style="margin-bottom:16px;">
  <div>
    <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:8px;">Captured Contacts</div>
    <div class="dt-feed" id="dt-feed">
      <div style="padding:20px;text-align:center;color:var(--muted);font-size:12px;" id="dt-feed-empty">No contacts yet</div>
    </div>
  </div>
  <div>
    <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:8px;">Live Log</div>
    <div class="dt-log" id="dt-log"><div class="dt-log-line">Waiting for bridge on localhost:5001...</div></div>
  </div>
</div>

<div class="dt-crm-toast" id="dt-crm-toast"></div>
</section>

<script>
  if(typeof pdfjsLib !== 'undefined'){
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
</script>
</head>
<body>

<!-- ═══ LOGIN OVERLAY ═══ -->
<div id="ff-login-overlay" style="display:flex;position:fixed;inset:0;z-index:99999;background:#070d1a;align-items:center;justify-content:center;font-family:'Outfit',sans-serif;">
  <div style="width:380px;max-width:90vw;background:#0d1526;border:1px solid rgba(30,90,246,0.25);border-radius:16px;padding:40px 32px;text-align:center;">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:6px;background:linear-gradient(135deg,#1e5af6,#60a5fa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">FIRST&#8209;FIN</div>
    <div style="font-size:11px;color:#64748b;letter-spacing:3px;text-transform:uppercase;margin-bottom:28px;">DEALER PLATFORM</div>
    <div id="ff-login-error" style="display:none;background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);color:#fca5a5;padding:10px;border-radius:8px;font-size:13px;margin-bottom:16px;"></div>
    <form id="ff-login-form" onsubmit="FF.handleLogin(event)" style="display:block;">
      <input id="ff-login-email" type="email" placeholder="Email" autocomplete="email" required style="width:100%;box-sizing:border-box;padding:12px 14px;margin-bottom:12px;background:#070d1a;border:1px solid rgba(30,90,246,0.2);border-radius:8px;color:#e2e8f0;font-size:14px;font-family:'Outfit',sans-serif;">
      <input id="ff-login-password" type="password" placeholder="Password" autocomplete="current-password" required style="width:100%;box-sizing:border-box;padding:12px 14px;margin-bottom:18px;background:#070d1a;border:1px solid rgba(30,90,246,0.2);border-radius:8px;color:#e2e8f0;font-size:14px;font-family:'Outfit',sans-serif;">
      <button id="ff-login-btn" type="submit" style="width:100%;padding:13px;background:linear-gradient(135deg,#1e5af6,#2d6cff);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif;">Sign In</button>
      <div style="margin-top:18px;font-size:13px;color:#64748b;">No account? <a href="#" onclick="FF.toggleAuthMode();return false;" style="color:#60a5fa;text-decoration:none;font-weight:600;">Create one</a></div>
    </form>
    <form id="ff-reg-form" onsubmit="FF.handleRegister(event)" style="display:none;">
      <input id="ff-reg-name" type="text" placeholder="Your name" required style="width:100%;box-sizing:border-box;padding:12px 14px;margin-bottom:12px;background:#070d1a;border:1px solid rgba(30,90,246,0.2);border-radius:8px;color:#e2e8f0;font-size:14px;font-family:'Outfit',sans-serif;">
      <input id="ff-reg-email" type="email" placeholder="Email" autocomplete="email" required style="width:100%;box-sizing:border-box;padding:12px 14px;margin-bottom:12px;background:#070d1a;border:1px solid rgba(30,90,246,0.2);border-radius:8px;color:#e2e8f0;font-size:14px;font-family:'Outfit',sans-serif;">
      <input id="ff-reg-password" type="password" placeholder="Password (6+ chars)" required style="width:100%;box-sizing:border-box;padding:12px 14px;margin-bottom:18px;background:#070d1a;border:1px solid rgba(30,90,246,0.2);border-radius:8px;color:#e2e8f0;font-size:14px;font-family:'Outfit',sans-serif;">
      <button id="ff-reg-btn" type="submit" style="width:100%;padding:13px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Outfit',sans-serif;">Create Account</button>
      <div style="margin-top:18px;font-size:13px;color:#64748b;">Already have an account? <a href="#" onclick="FF.toggleAuthMode();return false;" style="color:#60a5fa;text-decoration:none;font-weight:600;">Sign in</a></div>
    </form>
  </div>
</div>

<!-- ═══ PLATFORM HEADER ═══ -->
<header class="platform-header">
  <div>
    <div class="platform-logo">FIRST&#8209;FIN<span> ◆</span> DEALER</div>
    <div class="logo-sub">PLATFORM v1.0</div>
  </div>
  <nav class="main-nav">
    <button class="nav-btn active" onclick="showSection('deal',this)">🗂️ Deal Desk</button>
    <button class="nav-btn" onclick="showSection('inventory',this)">📦 Inventory</button>
    <button class="nav-btn" onclick="showSection('lenders',this)">🏦 Lenders</button>
    <button class="nav-btn" onclick="showSection('sarah')" id="nav-sarah">💬 SARAH</button>
    <button class="nav-btn compare-btn" onclick="showSection('compare',this)">⚡ Compare All</button>
    <button class="nav-btn" onclick="showSection('analytics',this)">📊 Analytics</button>
    <button class="nav-btn" onclick="showSection('dtsync',this)" style="background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(30,90,246,.15));color:#10b981;border-color:rgba(16,185,129,.3);">📥 DT Sync</button>
  </nav>
  <button class="hamburger" id="hamburgerBtn" onclick="toggleMobileMenu()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <div class="header-actions">
    <button class="hbtn" onclick="openPresentation()" style="background:linear-gradient(135deg,rgba(30,90,246,.2),rgba(245,158,11,.15));border-color:rgba(30,90,246,.4);color:white;font-weight:700;">🎯 Present</button>
    <button class="hbtn" onclick="saveDeal()">💾 Save</button>
    <button class="hbtn amber" onclick="openModal('emailModal')">📧 Email</button>
    <button class="hbtn theme-toggle" id="darkModeBtn" onclick="toggleDarkMode()">☀️ Light</button>
    <button class="hbtn" onclick="openModal('lenderRateModal');buildLenderRateEditor()">✏️ Rates</button>
    <button class="hbtn" onclick="openModal('settingsModal')">⚙️ Settings</button>
    <button class="hbtn" onclick="if(confirm('Sign out?')){FF.logout();location.reload();}" style="color:#ef4444;" title="Sign Out">🚪</button>
  </div>
</header>

<!-- ═══ MOBILE MENU ═══ -->
<div class="mobile-menu-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>
<div class="mobile-menu" id="mobileMenu">
  <div class="mobile-menu-section">Navigate</div>
  <button class="mobile-nav-btn" onclick="mobileNav('deal')">🗂️ Deal Desk</button>
  <button class="mobile-nav-btn" onclick="mobileNav('inventory')">📦 Inventory</button>
  <button class="mobile-nav-btn" onclick="mobileNav('lenders')">🏦 Lenders</button>
  <button class="mobile-nav-btn" onclick="mobileNav('sarah')">💬 Sarah AI</button>
  <button class="mobile-nav-btn" onclick="mobileNav('compare')">⚡ Compare All</button>
  <button class="mobile-nav-btn" onclick="mobileNav('analytics')">📊 Analytics</button>
  <button class="mobile-nav-btn" onclick="mobileNav('dtsync')">📥 DT Sync</button>
  <div class="mobile-menu-divider"></div>
  <div class="mobile-menu-section">Actions</div>
  <button class="mobile-action-btn" onclick="closeMobileMenu();openPresentation()">🎯 Customer Presentation</button>
  <button class="mobile-action-btn" onclick="closeMobileMenu();saveDeal()">💾 Save Deal</button>
  <button class="mobile-action-btn" onclick="closeMobileMenu();openModal('emailModal')">📧 Email Worksheet</button>
  <button class="mobile-action-btn" onclick="closeMobileMenu();openModal('lenderRateModal');buildLenderRateEditor()">✏️ Edit Rates</button>
  <button class="mobile-action-btn" onclick="closeMobileMenu();toggleDarkMode()">☀️ Toggle Light/Dark</button>
  <button class="mobile-action-btn" onclick="closeMobileMenu();openModal('settingsModal')">⚙️ Settings</button>
</div>

<!-- ═══ DEAL DESK ═══ -->
<section id="section-deal" class="section active">
  <div class="deal-grid">

    <!-- LEFT PANEL -->
    <div>
      <!-- Vehicle Info -->
      <div class="card">
        <div class="card-title">🚘 Vehicle Information</div>
        <div class="fgroup">
          <label>Vehicle Description</label>
          <input type="text" id="vehicleDesc" placeholder="2023 Ford F-150 SuperCrew..." oninput="autoMatchStock()">
        </div>
        <div class="two-col">
          <div class="fgroup">
            <label>Stock #</label>
            <select id="stockNum" onchange="loadVehicleFromStock()">
              <option value="">— Select Stock # —</option>
            </select>
          </div>
          <div class="fgroup">
            <label>VIN (Last 8)</label>
            <input type="text" id="vin" placeholder="XXXXXXXX" maxlength="8">
          </div>
        </div>
        <div class="three-col">
          <div class="fgroup">
            <label>Odometer (km)</label>
            <input type="number" id="odometer" placeholder="0">
          </div>
          <div class="fgroup">
            <label>Condition</label>
            <select id="condition">
              <option value="Clean">Clean</option>
              <option value="Average" selected>Average</option>
              <option value="Rough">Rough</option>
            </select>
          </div>
          <div class="fgroup">
            <label>Type / Trim</label>
            <input type="text" id="vehicleType" placeholder="4WD SuperCrew">
          </div>
        </div>
      </div>

      <!-- Customer Info -->
      <div class="card">
        <div class="card-title amber">👤 Customer Information</div>
        <div class="two-col">
          <div class="fgroup">
            <label>Customer Name</label>
            <input type="text" id="custName" placeholder="First Last">
          </div>
          <div class="fgroup">
            <label>Phone</label>
            <input type="text" id="custPhone" placeholder="(587) 000-0000">
          </div>
        </div>
        <div class="two-col">
          <div class="fgroup">
            <label>Email</label>
            <input type="email" id="custEmail" placeholder="customer@email.com">
          </div>
          <div class="fgroup">
            <label>Beacon Score</label>
            <input type="number" id="creditScore" placeholder="650" oninput="assessRisk()">
          </div>
        </div>
        <div class="two-col">
          <div class="fgroup">
            <label>Monthly Income</label>
            <input type="number" id="monthlyIncome" placeholder="0" oninput="calculatePTI()">
          </div>
          <div class="fgroup">
            <label>Existing Obligations/mo</label>
            <input type="number" id="existingPayments" placeholder="0" oninput="calculatePTI()">
          </div>
        </div>
        <div id="beaconLenderRow" class="beacon-lender-row" style="display:none;">
          <div class="bln-title">🏦 Lender Match — Based on Beacon + Vehicle</div>
          <div class="bln-badges" id="beaconBadges"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="btn btn-success btn-sm" onclick="addToCRM()">➕ Add to CRM</button>
          <button class="btn btn-primary btn-sm" onclick="runBeaconMatch()">🏦 Check Lenders</button>
        </div>
      </div>

      <!-- Deal Structure -->
      <div class="card">
        <div class="card-title">💰 Deal Structure</div>
        <div class="two-col">
          <div class="fgroup">
            <label>Selling Price ($)</label>
            <input type="number" id="sellingPrice" value="35000" oninput="calculate()">
          </div>
          <div class="fgroup">
            <label>Doc Fee ($)</label>
            <input type="number" id="docFee" value="998" oninput="calculate()">
          </div>
        </div>
        <div class="two-col">
          <div class="fgroup">
            <label>Trade Allowance ($)</label>
            <input type="number" id="tradeAllow" value="0" oninput="calculate()">
          </div>
          <div class="fgroup">
            <label>Trade Payoff ($)</label>
            <input type="number" id="tradePayoff" value="0" oninput="calculate()">
          </div>
        </div>
        <div class="two-col">
          <div class="fgroup">
            <label>APR (%)</label>
            <input type="number" id="apr" value="8.99" step="0.01" oninput="calculate()">
          </div>
          <div class="fgroup">
            <label>GST Rate (%)</label>
            <input type="number" id="gstRate" value="5" step="0.1" oninput="calculate()">
          </div>
        </div>
        <div class="two-col">
          <div class="fgroup">
            <label>GST Amount</label>
            <input type="text" id="gstAmount" readonly>
          </div>
          <div class="fgroup">
            <label style="display:flex;align-items:center;gap:6px;">
              Final Down Payment ($)
              <span style="font-size:9px;font-weight:700;background:rgba(245,158,11,.15);color:var(--amber);border:1px solid rgba(245,158,11,.3);border-radius:3px;padding:1px 5px;letter-spacing:.5px;">CHOSEN</span>
            </label>
            <input type="number" id="finalDown" value="0" placeholder="0" oninput="calculate()"
              style="border-color:rgba(245,158,11,.4);background:rgba(245,158,11,.04);">
          </div>
        </div>
        <div class="otd-box">
          <div class="otd-label">Total Out-the-Door</div>
          <div class="otd-amount" id="totalOTD">$0.00</div>
        </div>
        <div style="display:flex;gap:10px;margin-top:8px;">
          <div style="flex:1;background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.25);border-radius:8px;padding:10px 14px;text-align:center;">
            <div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--amber);text-transform:uppercase;">Down Payment</div>
            <div style="font-size:18px;font-weight:800;color:var(--amber);margin-top:2px;" id="finalDownDisplay">$0</div>
          </div>
          <div style="flex:1;background:rgba(30,90,246,.07);border:1px solid rgba(30,90,246,.25);border-radius:8px;padding:10px 14px;text-align:center;">
            <div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--primary);text-transform:uppercase;">Amount to Finance</div>
            <div style="font-size:18px;font-weight:800;color:var(--primary);margin-top:2px;" id="financeAmountDisplay">$0</div>
          </div>
        </div>
        <button class="btn btn-bridge" style="width:100%;margin-top:12px;" onclick="bridgeToCompare()">⚡ CHECK ALL LENDERS FOR THIS DEAL</button>
      </div>

      <!-- Trade Analysis -->
      <div class="card">
        <div class="card-title amber">🔄 Trade Analysis</div>
        <div class="two-col">
          <div class="fgroup">
            <label>ACV / Market Value ($)</label>
            <input type="number" id="acv" value="0" oninput="calculateTrade()">
          </div>
          <div class="fgroup">
            <label>Condition Adjustment</label>
            <select id="conditionAdj" onchange="calculateTrade()">
              <option value="0">Good — $0</option>
              <option value="300">Fair — ($300)</option>
              <option value="1000">Poor — ($1,000)</option>
            </select>
          </div>
        </div>
        <div class="two-col">
          <div class="fgroup">
            <label>Safety Inspection ($)</label>
            <input type="number" id="safetyInspect" value="150" oninput="calculateTrade()">
          </div>
          <div class="fgroup">
            <label>Reconditioning ($)</label>
            <input type="number" id="reconditionCost" value="500" oninput="calculateTrade()">
          </div>
        </div>
        <div class="fgroup"><label>Total Recon Cost</label><input type="text" id="totalRecon" readonly></div>
        <div class="fgroup"><label>Adjusted ACV</label><input type="text" id="adjustedACV" readonly></div>
        <div class="fgroup">
          <label>Trade Equity / Deficit</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="text" id="tradeEquity" readonly style="flex:1;">
            <button class="btn btn-amber btn-sm" onclick="carryTradeEquity()" title="Apply trade allowance to Deal Structure" style="white-space:nowrap;">→ Apply to Deal</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div>
      <!-- Payment Grid -->
      <div class="card">
        <div class="card-title">📋 Payment Grid</div>
        <div class="payment-wrap">
          <table class="payment-table">
            <thead>
              <tr>
                <th>Down Payment</th>
                <th>48 Months</th>
                <th>60 Months</th>
                <th>72 Months</th>
                <th>84 Months</th>
              </tr>
            </thead>
            <tbody id="paymentGrid">
              <tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px;">Enter deal details to calculate payments</td></tr>
            </tbody>
          </table>
        </div>
        <div class="rate-compare-card">
          <div class="rc-title">📊 Rate Comparison — Same Deal, 3 Rates</div>
          <div class="rc-rate-inputs">
            <div class="fgroup" style="margin:0;"><label>Buy Rate (%)</label><input type="number" id="rc_buy" value="6.50" step="0.01" oninput="updateRateComparison()"></div>
            <div class="fgroup" style="margin:0;"><label>Contract Rate (%)</label><input type="number" id="rc_contract" value="8.99" step="0.01" oninput="updateRateComparison()"></div>
            <div class="fgroup" style="margin:0;"><label>Max Rate (%)</label><input type="number" id="rc_max" value="12.99" step="0.01" oninput="updateRateComparison()"></div>
          </div>
          <table class="rate-compare-table">
            <thead><tr><th>Term</th><th class="rc-buy">Buy Rate</th><th class="rc-contract">Contract</th><th class="rc-max">Max Rate</th><th style="color:var(--muted);">Reserve/mo</th></tr></thead>
            <tbody id="rateCompareBody"><tr><td colspan="5" style="text-align:center;color:var(--muted);padding:12px;">Enter deal details above</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- F&I Products -->
      <div class="card">
        <div class="card-title green">🛡️ F&I Protection Package</div>

        <!-- Payment Impact FIRST — what the customer sees -->
        <div style="background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(30,90,246,.06));border:1px solid rgba(16,185,129,.25);border-radius:10px;padding:16px;margin-bottom:16px;">
          <div style="font-size:11px;font-weight:800;color:var(--green);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;">📋 Monthly Payment @ 72 Months</div>
          <div class="comp-row"><span class="comp-label">Vehicle Only</span><span class="comp-value" id="basePayment72">$0.00</span></div>
          <div class="comp-row"><span class="comp-label">+ GAP Insurance</span><span class="comp-value" id="withGap">$0.00</span></div>
          <div class="comp-row"><span class="comp-label">+ GAP + Warranty</span><span class="comp-value" id="withGapVsc">$0.00</span></div>
          <div class="comp-row"><span class="comp-label">+ All Protection</span><span class="comp-value" id="withAllProtection">$0.00</span></div>
          <div class="comp-row" style="border:none;padding-top:10px;margin-top:4px;border-top:2px solid rgba(16,185,129,.2);">
            <span class="comp-label" style="font-weight:800;color:var(--amber);font-size:13px;">FULLY LOADED</span>
            <span class="comp-value" style="color:var(--amber);font-size:18px;font-weight:900;" id="fullProtection">$0.00</span>
          </div>
        </div>

        <!-- Product Sell Price Entry — clean, no cost visible -->
        <div class="product-box">
          <div class="product-header">
            <span class="product-name">Vehicle Service Contract (VSC)</span>
            <span class="product-impact" id="vscImpact" style="color:var(--green);">+$0.00/mo</span>
          </div>
          <div class="fgroup" style="margin:0;">
            <label>Customer Price ($)</label>
            <input type="number" class="product-price" id="vscPrice" value="0" oninput="calculate()" style="width:100%;">
          </div>
        </div>
        <div class="product-box">
          <div class="product-header">
            <span class="product-name">GAP Insurance</span>
            <span class="product-impact" id="gapImpact" style="color:var(--green);">+$0.00/mo</span>
          </div>
          <div class="fgroup" style="margin:0;">
            <label>Customer Price ($)</label>
            <input type="number" class="product-price" id="gapPrice" value="0" oninput="calculate()" style="width:100%;">
          </div>
        </div>
        <div class="product-box">
          <div class="product-header">
            <span class="product-name">Tire & Wheel Protection</span>
            <span class="product-impact" id="twImpact" style="color:var(--green);">+$0.00/mo</span>
          </div>
          <div class="fgroup" style="margin:0;">
            <label>Customer Price ($)</label>
            <input type="number" class="product-price" id="twPrice" value="0" oninput="calculate()" style="width:100%;">
          </div>
        </div>
        <div class="product-box">
          <div class="product-header">
            <span class="product-name">Wear Appearance (WA)</span>
            <span class="product-impact" id="waImpact" style="color:var(--green);">+$0.00/mo</span>
          </div>
          <div class="fgroup" style="margin:0;">
            <label>Customer Price ($)</label>
            <input type="number" class="product-price" id="waPrice" value="0" oninput="calculate()" style="width:100%;">
          </div>
        </div>
      </div>

      <!-- Manager View -->
      <div class="card">
        <div class="card-title amber">🔒 Manager View</div>
        <div class="mgr-tabs">
          <button class="mgr-tab active" onclick="showMgrTab('profit',this)">💵 Gross Profit</button>
          <button class="mgr-tab" onclick="showMgrTab('reserve',this)">🏦 Reserve</button>
          <button class="mgr-tab" onclick="showMgrTab('subprime',this)">⚠️ Subprime</button>
          <button class="mgr-tab" onclick="showMgrTab('checklist',this)">✅ Checklist</button>
          <button class="mgr-tab" onclick="showMgrTab('tools',this)">🛠️ Tools</button>
          <button class="mgr-tab" onclick="showMgrTab('commission',this)">💵 Commission</button>
        </div>

        <div id="mgr-profit" class="mgr-content active">
          <div class="fgroup"><label>Unit Cost / ACV ($)</label><input type="number" id="unitAcv" value="0" oninput="calculateProfit()"></div>
          <div class="fgroup"><label>Recon ($)</label><input type="number" id="recon" value="0" oninput="calculateProfit()"></div>
          <div class="fgroup"><label>Lot Pack ($)</label><input type="number" id="lotPack" value="250" oninput="calculateProfit()"></div>

          <div style="font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin:12px 0 8px;padding-top:10px;border-top:1px solid var(--border);">F&I Product Costs</div>
          <div class="two-col">
            <div class="fgroup"><label>VSC Cost ($)</label><input type="number" id="vscCost" value="0" oninput="calculateProfit()"></div>
            <div class="fgroup"><label>GAP Cost ($)</label><input type="number" id="gapCost" value="0" oninput="calculateProfit()"></div>
          </div>
          <div class="two-col">
            <div class="fgroup"><label>T&W Cost ($)</label><input type="number" id="twCost" value="0" oninput="calculateProfit()"></div>
            <div class="fgroup"><label>WA Cost ($)</label><input type="number" id="waCost" value="0" oninput="calculateProfit()"></div>
          </div>

          <div style="margin-top:10px;">
          <div class="cline"><span class="cl-label">Total Cost</span><span class="cl-value" id="totalCost">$0</span></div>
          <div class="cline"><span class="cl-label">Front Gross</span><span class="cl-value" id="frontGross">$0</span></div>
          <div class="cline"><span class="cl-label">VSC Profit</span><span class="cl-value" id="vscProfit">$0</span></div>
          <div class="cline"><span class="cl-label">GAP Profit</span><span class="cl-value" id="gapProfit">$0</span></div>
          <div class="cline"><span class="cl-label">T&W Profit</span><span class="cl-value" id="twProfit">$0</span></div>
          <div class="cline"><span class="cl-label">WA Profit</span><span class="cl-value" id="waProfit">$0</span></div>
          <div class="cline"><span class="cl-label">F&I Reserve</span><span class="cl-value" style="color:var(--green);">$500</span></div>
          <div class="cline"><span class="cl-label">Front %</span><span class="cl-value" id="fePercent">0%</span></div>
          <div class="cline"><span class="cl-label">Back %</span><span class="cl-value" id="bePercent">0%</span></div>
          </div>
          <div class="total-bar" id="totalGross">TOTAL GROSS: $0</div>
          <div style="text-align:center;margin-top:8px;font-size:12px;color:var(--muted);">PVR: <strong style="color:var(--amber);" id="pvr">$0</strong></div>
        </div>

        <div id="mgr-reserve" class="mgr-content">
          <div class="two-col">
            <div class="fgroup"><label>Contract Rate (%)</label><input type="number" id="contractRate" value="8.99" step="0.01" oninput="calculateReserve()"></div>
            <div class="fgroup"><label>Buy Rate (%)</label><input type="number" id="buyRate" value="6.50" step="0.01" oninput="calculateReserve()"></div>
          </div>
          <div class="two-col">
            <div class="fgroup"><label>Bank Split (%)</label><input type="number" id="bankSplit" value="75" oninput="calculateReserve()"></div>
            <div class="fgroup"><label>Term (months)</label><input type="number" id="reserveTerm" value="72" oninput="calculateReserve()"></div>
          </div>
          <div class="cline"><span class="cl-label">Rate Spread</span><span class="cl-value" id="rateSpread">0.00%</span></div>
          <div class="cline"><span class="cl-label" style="color:var(--green);">Estimated Reserve</span><span class="cl-value" style="color:var(--green);font-size:18px;" id="reserveProfit">$0</span></div>
        </div>

        <div id="mgr-subprime" class="mgr-content">
          <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.3);border-radius:8px;padding:14px;margin-bottom:14px;font-size:12px;color:var(--amber);">
            ⚠️ Subprime analysis helps ensure deal structure meets lender requirements.
          </div>
          <div class="two-col">
            <div class="fgroup"><label>Advance ($)</label><input type="number" id="subAdvance" value="0" oninput="calculateSubprime()"></div>
            <div class="fgroup"><label>NADA Book ($)</label><input type="number" id="subNada" value="0" oninput="calculateSubprime()"></div>
          </div>
          <div class="fgroup"><label>PTI Limit (%)</label><input type="number" id="ptiLimit" value="20" step="0.1" oninput="calculatePTI()"></div>
          <div class="cline"><span class="cl-label">Deal LTV</span><span class="cl-value" id="dealLTV">0%</span></div>
          <div class="cline"><span class="cl-label">PTI</span><span class="cl-value" id="ptiResult">0%</span></div>
          <div class="cline"><span class="cl-label">PTI Status</span><span class="cl-value" id="ptiStatus">—</span></div>
          <div class="cline"><span class="cl-label">Beacon Risk</span><span class="cl-value" id="refiRisk">—</span></div>
          <div class="cline"><span class="cl-label">Reserve Status</span><span class="cl-value" id="reserveStatus">—</span></div>
        </div>

        <div id="mgr-checklist" class="mgr-content">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">📋 Customer Documents</div>
          <div class="chk-item"><input type="checkbox" id="chk1"><label for="chk1">Government-issued ID (front & back)</label></div>
          <div class="chk-item"><input type="checkbox" id="chk2"><label for="chk2">SIN / Insurance Number</label></div>
          <div class="chk-item"><input type="checkbox" id="chk3"><label for="chk3">Proof of Income (recent pay stubs)</label></div>
          <div class="chk-item"><input type="checkbox" id="chk4"><label for="chk4">Bank Statement (last 3 months)</label></div>
          <div class="chk-item"><input type="checkbox" id="chk5"><label for="chk5">Proof of Residence</label></div>
          <div class="chk-item"><input type="checkbox" id="chk6"><label for="chk6">Insurance — Binder confirmed</label></div>
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin:10px 0 6px;">📝 Contract</div>
          <div class="chk-item"><input type="checkbox" id="chk7"><label for="chk7">Credit Application signed</label></div>
          <div class="chk-item"><input type="checkbox" id="chk8"><label for="chk8">Retail Installment Contract signed</label></div>
          <div class="chk-item"><input type="checkbox" id="chk9"><label for="chk9">Disclosure of Terms reviewed</label></div>
          <div class="chk-item"><input type="checkbox" id="chk10"><label for="chk10">Trade Documentation (if applicable)</label></div>
          <div class="chk-item"><input type="checkbox" id="chk11"><label for="chk11">Registration / Transfer Forms</label></div>
          <div class="chk-item"><input type="checkbox" id="chk12"><label for="chk12">GAP/VSC/Product Forms signed</label></div>
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin:10px 0 6px;">📤 Submission</div>
          <div class="chk-item"><input type="checkbox" id="chk13"><label for="chk13">All documents scanned & uploaded</label></div>
          <div class="chk-item"><input type="checkbox" id="chk14"><label for="chk14">Contract submitted to lender</label></div>
          <div class="chk-item"><input type="checkbox" id="chk15"><label for="chk15">Funding approval received</label></div>
        </div>

        <div id="mgr-tools" class="mgr-content">
          <div class="mini-calc">
            <div class="mini-title">🔢 Quick Payment Calculator</div>
            <div class="two-col">
              <div class="fgroup"><label>Amount ($)</label><input type="number" id="toolAmount" value="30000"></div>
              <div class="fgroup"><label>Rate (%)</label><input type="number" id="toolRate" value="8.99" step="0.01"></div>
            </div>
            <div class="fgroup"><label>Term (months)</label><input type="number" id="toolTerm" value="72"></div>
            <button class="btn btn-primary btn-full" onclick="quickCalc()">Calculate</button>
            <div class="calc-result" id="quickResult">$0.00 / month</div>
          </div>
          <div class="mini-calc">
            <div class="mini-title">💰 Reverse Calculator (Find Max Amount)</div>
            <div class="two-col">
              <div class="fgroup"><label>Target Payment ($)</label><input type="number" id="revPayment" value="500"></div>
              <div class="fgroup"><label>Rate (%)</label><input type="number" id="revRate" value="8.99" step="0.01"></div>
            </div>
            <div class="fgroup"><label>Term (months)</label><input type="number" id="revTerm" value="72"></div>
            <button class="btn btn-success btn-full" onclick="reverseCalc()">Calculate</button>
            <div class="calc-result" id="reverseResult">Max: $0</div>
          </div>
          <div class="mini-calc">
            <div class="mini-title">📈 Profit Margin</div>
            <div class="two-col">
              <div class="fgroup"><label>Cost ($)</label><input type="number" id="mCost" value="1000"></div>
              <div class="fgroup"><label>Sell ($)</label><input type="number" id="mSell" value="1500"></div>
            </div>
            <button class="btn btn-amber btn-full" onclick="calcMargin()">Calculate</button>
            <div class="calc-result" id="marginResult">$0 profit — 0%</div>
          </div>
        </div>

        <div id="mgr-commission" class="mgr-content">
          <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:6px;padding:10px;margin-bottom:12px;font-size:11px;color:var(--amber);">💡 Enter cost data in Gross Profit tab first — commission pulls live numbers.</div>
          <div class="two-col">
            <div class="fgroup"><label>Front Split (%)</label><input type="number" id="commFrontPct" value="25" step="1" oninput="calcCommission()"></div>
            <div class="fgroup"><label>Back Split (%)</label><input type="number" id="commBackPct" value="30" step="1" oninput="calcCommission()"></div>
          </div>
          <div class="fgroup"><label>Flat / Bonus ($)</label><input type="number" id="commFlat" value="0" oninput="calcCommission()"></div>
          <div class="comm-result-box">
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Estimated Commission</div>
            <div class="comm-big" id="commTotal">$0</div>
            <div class="comm-breakdown" id="commBreakdown">—</div>
          </div>
          <button class="btn btn-success btn-full" style="margin-top:10px;" onclick="calcCommission()">🔄 Recalculate</button>
        </div>

      </div>

      <!-- Log Deal -->
      <div style="display:flex;gap:10px;margin-bottom:16px;">
        <button class="btn btn-success" style="flex:1;padding:12px;" onclick="logDeal()">📊 LOG THIS DEAL</button>
        <button class="btn btn-ghost" style="flex:1;padding:12px;" onclick="openModal('lenderParserModal')">🏦 PASTE LENDER APPROVAL</button>
        <button class="btn btn-primary" style="padding:12px 16px;" onclick="printWorksheet()" title="Print Deal Worksheet">🖨️ Worksheet</button>
      </div>
    </div>
  </div>

  <!-- DEAL SCENARIOS — full width below the two-col grid -->
  <div class="scenario-strip">
    <div class="scenario-card" id="sc0">
      <div class="sc-header">
        <input class="sc-label-input" id="sc0label" value="SCENARIO A" placeholder="Label">
        <span class="sc-badge" id="sc0badge">Empty</span>
      </div>
      <div class="sc-data" id="sc0data" style="color:var(--muted);font-style:italic;">No deal saved yet.</div>
      <div class="sc-actions">
        <button class="btn btn-amber btn-sm" onclick="saveScenario(0)">💾 Save</button>
        <button class="btn btn-primary btn-sm" onclick="loadScenario(0)">📂 Load</button>
        <button class="btn btn-ghost btn-sm" onclick="clearScenario(0)">✕</button>
      </div>
    </div>
    <div class="scenario-card" id="sc1">
      <div class="sc-header">
        <input class="sc-label-input" id="sc1label" value="SCENARIO B" placeholder="Label">
        <span class="sc-badge" id="sc1badge">Empty</span>
      </div>
      <div class="sc-data" id="sc1data" style="color:var(--muted);font-style:italic;">No deal saved yet.</div>
      <div class="sc-actions">
        <button class="btn btn-amber btn-sm" onclick="saveScenario(1)">💾 Save</button>
        <button class="btn btn-primary btn-sm" onclick="loadScenario(1)">📂 Load</button>
        <button class="btn btn-ghost btn-sm" onclick="clearScenario(1)">✕</button>
      </div>
    </div>
    <div class="scenario-card" id="sc2">
      <div class="sc-header">
        <input class="sc-label-input" id="sc2label" value="SCENARIO C" placeholder="Label">
        <span class="sc-badge" id="sc2badge">Empty</span>
      </div>
      <div class="sc-data" id="sc2data" style="color:var(--muted);font-style:italic;">No deal saved yet.</div>
      <div class="sc-actions">
        <button class="btn btn-amber btn-sm" onclick="saveScenario(2)">💾 Save</button>
        <button class="btn btn-primary btn-sm" onclick="loadScenario(2)">📂 Load</button>
        <button class="btn btn-ghost btn-sm" onclick="clearScenario(2)">✕</button>
      </div>
    </div>
  </div>

</section>

<!-- ═══ INVENTORY ═══ -->
<section id="section-inventory" class="section">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
      <div class="card-title" style="margin:0;border:none;padding:0;">📦 Vehicle Inventory</div>
      <div style="display:flex;gap:10px;align-items:center;">
        <span class="inv-count" id="invCount">0 vehicles</span>
        <button class="btn btn-amber btn-sm" onclick="openModal('csvImportModal')">📤 Import CSV</button>
      </div>
    </div>
    <div class="inv-search">
      <input type="text" id="invSearch" placeholder="🔍 Search by Stock #, Make, Model, Year, Price..." oninput="filterInventory()">
    </div>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>Stock #</th><th>Year</th><th>Make</th><th>Model</th><th>Type</th>
            <th>Mileage</th><th>Price</th><th>Condition</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ═══ LENDERS ═══ -->
<section id="section-lenders" class="section">
  <div class="lender-tabs">
    <button class="ltab active" onclick="showLenderTab('lq-autocapital',this)">AutoCapital</button>
    <button class="ltab" onclick="showLenderTab('lq-cibc',this)">CIBC</button>
    <button class="ltab" onclick="showLenderTab('lq-edenpark',this)">EdenPark</button>
    <button class="ltab" onclick="showLenderTab('lq-iceberg',this)">Iceberg</button>
    <button class="ltab" onclick="showLenderTab('lq-northlake',this)">NorthLake</button>
    <button class="ltab" onclick="showLenderTab('lq-prefera',this)">Prefera</button>
    <button class="ltab" onclick="showLenderTab('lq-rbc',this)">RBC</button>
    <button class="ltab" onclick="showLenderTab('lq-santander',this)">Santander</button>
    <button class="ltab" onclick="showLenderTab('lq-sda',this)">SDA</button>
    <button class="ltab" onclick="showLenderTab('lq-servus',this)">Servus</button>
    <button class="ltab" onclick="showLenderTab('lq-wsleasing',this)">WS Leasing</button>
    <button class="ltab" onclick="showLenderTab('lq-quickref',this)">📊 Quick Ref</button>
  </div>
  <div id="lender-panels"></div>
</section>

<!-- ═══ COMPARE ALL ═══ -->
<section id="section-compare" class="section">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px;">
      <div>
        <div class="card-title" style="margin:0;border:none;padding:0;">⚡ All-Lender Comparison Engine</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px;">Select a vehicle to instantly rank all 11 lenders — best to worst.</div>
      </div>
      <div style="background:linear-gradient(135deg,rgba(245,158,11,.15),rgba(30,90,246,.15));border:1px solid rgba(245,158,11,.3);color:var(--amber);padding:6px 14px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:1px;">LIVE COMPARISON ENGINE</div>
    </div>
    <div class="compare-input-bar">
      <div class="fgroup" style="margin:0;">
        <label>Select Vehicle (Stock #)</label>
        <select id="compareStock" onchange="runComparison()" style="background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:9px 12px;width:100%;font-family:'Outfit',sans-serif;">
          <option value="">— Choose a vehicle —</option>
        </select>
      </div>
      <div class="fgroup" style="margin:0;">
        <label>Down Payment ($)</label>
        <input type="number" id="compareDown" value="0" oninput="runComparison()" style="background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:9px 12px;width:100%;">
      </div>
      <div class="fgroup" style="margin:0;">
        <label>Trade-in ($)</label>
        <input type="number" id="compareTrade" value="0" oninput="runComparison()" style="background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:9px 12px;width:100%;">
      </div>
      <div class="fgroup" style="margin:0;">
        <label>Add-ons / Fees ($)</label>
        <input type="number" id="compareFees" value="0" oninput="runComparison()" style="background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:9px 12px;width:100%;">
      </div>
    </div>
    <div id="compareVehicleCard" style="display:none;" class="compare-vehicle-card"></div>
    <div id="compareResults" style="display:none;">
      <div class="summary-bar" id="compareSummaryBar"></div>
      <div class="section-label eligible">✅ ELIGIBLE LENDERS <span class="count-pill green" id="eligibleCount"></span></div>
      <div class="compare-grid" id="compareEligible"></div>
      <div class="section-label ineligible" id="ineligibleLabel" style="display:none;">⛔ INELIGIBLE LENDERS <span class="count-pill gray" id="ineligibleCount"></span></div>
      <div class="compare-grid" id="compareIneligible"></div>
    </div>
    <div id="comparePlaceholder" class="compare-placeholder">
      <div class="placeholder-icon">🚗</div>
      <div class="placeholder-title">Select a Vehicle to Begin</div>
      <div style="font-size:13px;">Choose a stock number above to instantly compare all 11 lenders side by side</div>
      <div style="margin-top:14px;font-size:12px;color:var(--primary);">Tip: Use the ⚡ Check All Lenders button from the Deal Desk to auto-populate this screen.</div>
    </div>
  </div>
</section>

<!-- ═══ ANALYTICS ═══ -->
<section id="section-analytics" class="section">
  <div class="mgr-tabs" style="margin-bottom:20px;">
    <button class="mgr-tab active" onclick="showAnalyticsTab('deals',this)">📊 Deal Log</button>
    <button class="mgr-tab" onclick="showAnalyticsTab('stats',this)">📈 Stats</button>
    <button class="mgr-tab" onclick="showAnalyticsTab('crm',this)">👥 CRM</button>
    <button class="mgr-tab" onclick="showAnalyticsTab('target',this)">🎯 Monthly Target</button>
  </div>

  <!-- Deal Log -->
  <div id="atab-deals" class="mgr-content active">
    <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
      <button class="btn btn-success" onclick="logDeal()">➕ Log Current Deal</button>
      <button class="btn btn-ghost" onclick="exportJSON('deals')">💾 Export JSON</button>
      <button class="btn btn-danger btn-sm" onclick="clearAllDeals()">🗑️ Clear All</button>
    </div>
    <div class="table-wrap"><div id="dealLogContainer"></div></div>
  </div>

  <!-- Stats -->
  <div id="atab-stats" class="mgr-content">
    <div class="stat-hero">
      <div class="stat-card"><div class="stat-number" id="statTotal">0</div><div class="stat-label">Total Deals</div></div>
      <div class="stat-card"><div class="stat-number" id="statMonth">0</div><div class="stat-label">This Month</div></div>
      <div class="stat-card"><div class="stat-number" id="statWeek">0</div><div class="stat-label">This Week</div></div>
      <div class="stat-card"><div class="stat-number" id="statToday">0</div><div class="stat-label">Today</div></div>
    </div>
    <div class="card-title" style="margin-bottom:12px;">Product Penetration</div>
    <div class="penetration-grid">
      <div class="pen-card"><div class="pen-pct" id="penVSC">0%</div><div class="pen-label">VSC</div><div class="pen-sub" id="penVSCn">0 of 0</div></div>
      <div class="pen-card"><div class="pen-pct" id="penGAP">0%</div><div class="pen-label">GAP</div><div class="pen-sub" id="penGAPn">0 of 0</div></div>
      <div class="pen-card"><div class="pen-pct" id="penTW">0%</div><div class="pen-label">T&W</div><div class="pen-sub" id="penTWn">0 of 0</div></div>
      <div class="pen-card"><div class="pen-pct" id="penWA">0%</div><div class="pen-label">WA</div><div class="pen-sub" id="penWAn">0 of 0</div></div>
    </div>
    <div class="two-col">
      <div class="card"><div class="card-title">💰 Revenue</div>
        <div class="cline"><span class="cl-label">Average PVR</span><span class="cl-value" id="avgPVR">$0</span></div>
        <div class="cline"><span class="cl-label">Total Backend</span><span class="cl-value" id="totalBackend">$0</span></div>
      </div>
    </div>
  </div>

  <!-- CRM -->
  <div id="atab-crm" class="mgr-content">
    <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="promptAddCRM()">➕ Add Customer</button>
      <button class="btn btn-ghost" onclick="exportJSON('crm')">💾 Export CRM</button>
    </div>
    <div class="table-wrap"><div id="crmContainer"></div></div>
  </div>

  <!-- Monthly Target -->
  <div id="atab-target" class="mgr-content">
    <div class="card" style="max-width:500px;">
      <div class="card-title">🎯 Monthly Target Tracker</div>
      <div class="two-col" style="margin-bottom:14px;">
        <div class="fgroup"><label>Monthly Target (deals)</label><input type="number" id="targetInput" value="30" oninput="updateTarget()"></div>
      </div>
      <div class="stat-hero" style="grid-template-columns:1fr 1fr;">
        <div class="stat-card"><div class="stat-number" id="tDeals">0</div><div class="stat-label">Done</div></div>
        <div class="stat-card"><div class="stat-number" id="tTarget">30</div><div class="stat-label">Target</div></div>
        <div class="stat-card"><div class="stat-number" id="tPct">0%</div><div class="stat-label">Complete</div></div>
        <div class="stat-card"><div class="stat-number" id="tPace">—</div><div class="stat-label">Pace</div></div>
      </div>
      <div style="margin-top:10px;font-size:12px;color:var(--muted);text-align:center;">
        Days left: <strong style="color:var(--amber);" id="tDaysLeft">—</strong> &nbsp;|&nbsp; 
        Needed/day: <strong style="color:var(--primary);" id="tNeedPerDay">—</strong>
      </div>
    </div>
  </div>
</section>

<!-- ═══ MODALS ═══ -->

<!-- Email Modal -->
<div class="modal-overlay" id="emailModal" onclick="closeModalOutside(event,'emailModal')">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('emailModal')">×</button>
    <div class="modal-title">📧 Email Quote</div>
    <div class="two-col">
      <div class="fgroup"><label>Customer Email</label><input type="email" id="emailTo" placeholder="customer@email.com"></div>
      <div class="fgroup"><label>Salesperson Name</label><input type="text" id="salesName" value="Franco Fannin"></div>
    </div>
    <div class="fgroup"><label>Dealership Name</label><input type="text" id="dealerName" value="Automaxx"></div>
    <button class="btn btn-primary btn-full" onclick="generateEmail()" style="margin-bottom:14px;">Generate Email</button>
    <div id="emailPreview" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;white-space:pre-wrap;font-family:monospace;font-size:11px;max-height:350px;overflow-y:auto;color:var(--text);"></div>
    <button class="btn btn-amber btn-sm" style="margin-top:10px;" onclick="copyText('emailPreview')">📋 Copy to Clipboard</button>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal" onclick="closeModalOutside(event,'settingsModal')">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('settingsModal')">×</button>
    <div class="modal-title">⚙️ Settings</div>
    <div class="settings-grid">
      <div class="fgroup"><label>Salesperson Name</label><input type="text" id="setPerson" placeholder="Your Name"></div>
      <div class="fgroup"><label>Dealership Name</label><input type="text" id="setDealer" placeholder="Dealership Name"></div>
      <div class="fgroup"><label>Default Doc Fee ($)</label><input type="number" id="setDocFee" value="998"></div>
      <div class="fgroup"><label>Default GST Rate (%)</label><input type="number" id="setGST" value="5" step="0.1"></div>
      <div class="fgroup"><label>Default APR (%)</label><input type="number" id="setAPR" value="8.99" step="0.01"></div>
      <div class="fgroup"><label>Monthly Deal Target</label><input type="number" id="setTarget" value="30"></div>
    </div>
    <button class="btn btn-primary btn-full" onclick="saveSettings()" style="margin-top:8px;">💾 Save Settings</button>
  </div>
</div>

<!-- Lender Parser Modal -->
<div class="modal-overlay" id="lenderParserModal" onclick="closeModalOutside(event,'lenderParserModal')">
  <div class="modal-box" style="max-width:680px;">
    <button class="modal-close" onclick="closeModal('lenderParserModal')">×</button>
    <div class="modal-title">🏦 Lender Approval Parser</div>

    <!-- PDF Drop Zone -->
    <div id="pdfDropZone"
      style="border:2px dashed var(--border2);border-radius:10px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px;"
      onclick="document.getElementById('pdfFileInput').click()"
      ondrop="handleApprovalDrop(event)"
      ondragover="event.preventDefault();this.style.borderColor='var(--primary)';this.style.background='rgba(30,90,246,.06)'"
      ondragleave="this.style.borderColor='var(--border2)';this.style.background=''">
      <div style="font-size:26px;margin-bottom:6px;">📄</div>
      <div style="font-weight:700;font-size:13px;color:var(--text);">Drop DealerTrack PDF here</div>
      <div style="font-size:11px;color:var(--muted);margin-top:3px;">or click to browse · also accepts pasted text below</div>
      <div id="pdfFileName" style="font-size:11px;color:var(--primary);margin-top:6px;font-weight:600;"></div>
    </div>
    <input type="file" id="pdfFileInput" accept=".pdf" style="display:none;" onchange="handleApprovalFile(event)">

    <!-- Divider -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
      <div style="flex:1;height:1px;background:var(--border);"></div>
      <div style="font-size:10px;color:var(--muted);font-weight:700;letter-spacing:1px;">OR PASTE TEXT</div>
      <div style="flex:1;height:1px;background:var(--border);"></div>
    </div>

    <div class="fgroup">
      <textarea id="lenderText" rows="6"
        placeholder="Paste lender approval text here..."
        style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:12px;font-family:'JetBrains Mono',monospace;font-size:11px;resize:vertical;"></textarea>
    </div>
    <button class="btn btn-primary btn-full" onclick="parseLender()">🔍 Parse Document</button>
    <div id="lenderParseResults" style="margin-top:16px;"></div>
  </div>
</div>

<!-- CSV Import Modal -->
<div class="modal-overlay" id="csvImportModal" onclick="closeModalOutside(event,'csvImportModal')">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('csvImportModal')">×</button>
    <div class="modal-title">📤 Import Inventory CSV</div>
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;font-size:12px;color:var(--muted);">
      Expected columns: <strong style="color:var(--amber);">stock, year, make, model, mileage, price, condition, carfax, type</strong><br>
      Any column order is fine. Headers must be in row 1.
    </div>
    <div class="fgroup"><label>Paste CSV Content</label><textarea id="csvText" rows="12" placeholder="stock,year,make,model,mileage,price,condition,carfax,type&#10;AM24036,2023,JEEP,COMPASS,69200,35980,Average,0,4x4" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:12px;font-family:monospace;font-size:11px;resize:vertical;"></textarea></div>
    <button class="btn btn-amber btn-full" onclick="importCSV()">Import & Replace Inventory</button>
  </div>
</div>


<!-- ═══ SARAH AI ═══ -->
<section id="section-sarah" class="section">

  <!-- Sarah Header Bar -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
    <div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:4px;background:linear-gradient(90deg,#06b6d4,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">SARAH AI</div>
      <div style="font-size:11px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;">SMS Outreach · Conversations · Voice · Analytics</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="hbtn" onclick="loadSarahDashboard()" style="background:rgba(6,182,212,.1);border-color:rgba(6,182,212,.3);color:#06b6d4;">🔄 Refresh</button>
      <button class="hbtn" onclick="exportData('appointments')">📥 Export Appts</button>
      <button class="hbtn" onclick="exportData('callbacks')">📥 Export Callbacks</button>
      <button class="hbtn" onclick="exportData('conversations')">📥 Export Convs</button>
      <button class="hbtn" onclick="exportData('analytics')">📥 Export Analytics</button>
    </div>
  </div>

  <!-- Sarah Stats -->
  <div class="sarah-stat-grid" id="sarah-stats-row">
    <div class="sarah-stat"><div class="sarah-stat-num" id="ss-customers">—</div><div class="sarah-stat-label">Customers</div></div>
    <div class="sarah-stat"><div class="sarah-stat-num" id="ss-conversations">—</div><div class="sarah-stat-label">Conversations</div></div>
    <div class="sarah-stat"><div class="sarah-stat-num" id="ss-messages">—</div><div class="sarah-stat-label">Messages</div></div>
    <div class="sarah-stat"><div class="sarah-stat-num" id="ss-appointments">—</div><div class="sarah-stat-label">Appointments</div></div>
    <div class="sarah-stat"><div class="sarah-stat-num" id="ss-callbacks">—</div><div class="sarah-stat-label">Callbacks</div></div>
  </div>

  <!-- Sarah Tabs -->
  <div class="mgr-tabs" style="margin-bottom:16px;">
    <button class="mgr-tab active" onclick="showSarahTab('conversations',this)">💬 Conversations</button>
    <button class="mgr-tab" onclick="showSarahTab('appointments',this)">📅 Appointments</button>
    <button class="mgr-tab" onclick="showSarahTab('callbacks',this)">📞 Callbacks</button>
    <button class="mgr-tab" onclick="showSarahTab('launch',this)">🚀 Launch SMS</button>
    <button class="mgr-tab" onclick="showSarahTab('bulk',this)">📋 Bulk SMS</button>
    <button class="mgr-tab" onclick="showSarahTab('voice',this)">🔊 Voice</button>
    <button class="mgr-tab" onclick="showSarahTab('sarahanalytics',this)">📊 Analytics</button>
    <button class="mgr-tab" onclick="showSarahTab('voicemails',this);loadVoicemails()">📬 Voicemails</button>
  </div>

  <!-- ── Conversations Tab ── -->
  <div id="stab-conversations" class="mgr-content active">
    <div style="display:flex;gap:8px;margin-bottom:14px;align-items:center;flex-wrap:wrap;">
      <input type="text" id="convSearch" placeholder="🔍 Search name or phone..." oninput="filterConversations()" style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:8px 12px;font-size:12px;min-width:200px;">
      <select id="convStatusFilter" onchange="filterConversations()" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:8px 10px;font-size:12px;">
        <option value="all">All Status</option>
        <option value="active">Active</option>
        <option value="converted">Converted</option>
        <option value="stopped">Stopped</option>
      </select>
      <button class="btn btn-primary btn-sm" onclick="loadSarahDashboard()">🔄 Refresh</button>
    </div>
    <div id="conversationList" style="max-height:600px;overflow-y:auto;">
      <div style="text-align:center;padding:40px;color:var(--muted);">Loading conversations...</div>
    </div>
  </div>

  <!-- ── Appointments Tab ── -->
  <div id="stab-appointments" class="mgr-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <div style="font-size:12px;color:var(--muted);">Customers who booked an appointment through Sarah</div>
      <button class="btn btn-primary btn-sm" onclick="loadSarahDashboard()">🔄 Refresh</button>
    </div>
    <div id="appointmentsList" style="max-height:600px;overflow-y:auto;">
      <div style="text-align:center;padding:40px;color:var(--muted);">Loading appointments...</div>
    </div>
  </div>

  <!-- ── Callbacks Tab ── -->
  <div id="stab-callbacks" class="mgr-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <div style="font-size:12px;color:var(--muted);">Customers who requested a callback</div>
      <button class="btn btn-primary btn-sm" onclick="loadSarahDashboard()">🔄 Refresh</button>
    </div>
    <div id="callbacksList" style="max-height:600px;overflow-y:auto;">
      <div style="text-align:center;padding:40px;color:var(--muted);">Loading callbacks...</div>
    </div>
  </div>

  <!-- ── Launch SMS Tab ── -->
  <div id="stab-launch" class="mgr-content">
    <div class="card" style="max-width:600px;">
      <div class="card-title">🚀 Launch Sarah — Send Outreach SMS</div>
      <div class="fgroup">
        <label>Phone Number</label>
        <input type="tel" id="launchPhone" class="phone-fmt" placeholder="(587) 000-0000" oninput="formatPhoneInput(this)">
      </div>
      <div class="fgroup">
        <label>Opening Message</label>
        <textarea id="launchMessage" rows="4" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:10px;font-size:13px;font-family:'Outfit',sans-serif;resize:vertical;">Hi! 👋 I'm Sarah from the dealership. I wanted to reach out and see if you're interested in finding your perfect vehicle. What type of car are you looking for? (Reply STOP to opt out)</textarea>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:10px;" id="launchCharCount">0 characters</div>
      <button class="btn btn-primary btn-full" id="launchSendBtn" onclick="sendLaunchSMS()">🚀 Send Message</button>
      <div id="launchResult" style="display:none;margin-top:10px;padding:10px;border-radius:6px;font-size:12px;"></div>
    </div>
    <div class="card" style="max-width:600px;margin-top:0;">
      <div class="card-title amber">📤 Manual Reply to Existing Customer</div>
      <div class="fgroup">
        <label>Customer Phone</label>
        <input type="tel" id="replyPhone" class="phone-fmt" placeholder="(587) 000-0000" oninput="formatPhoneInput(this)">
      </div>
      <div class="fgroup">
        <label>Message</label>
        <textarea id="replyMessage" rows="3" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:10px;font-size:13px;font-family:'Outfit',sans-serif;resize:vertical;" placeholder="Type your reply..."></textarea>
      </div>
      <button class="btn btn-amber btn-full" onclick="sendManualReplyForm()">📤 Send Reply</button>
      <div id="replyResult" style="display:none;margin-top:10px;padding:10px;border-radius:6px;font-size:12px;"></div>
    </div>
  </div>

  <!-- ── Bulk SMS Tab ── -->
  <div id="stab-bulk" class="mgr-content">
    <div class="two-col" style="align-items:start;">
      <div>
        <div class="card">
          <div class="card-title">📋 Upload CSV List</div>
          <div class="bulk-zone" id="bulkDropZone" onclick="document.getElementById('csvFileInput').click()" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            <div style="font-size:28px;margin-bottom:8px;">📄</div>
            <div style="font-weight:700;color:var(--text);">Drop CSV here or click to browse</div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">Format: Name, Phone (one per row)</div>
          </div>
          <input type="file" id="csvFileInput" accept=".csv" style="display:none;" onchange="handleFileSelect(event)">
          <div id="contactPreview" style="display:none;margin-top:12px;">
            <div style="font-size:12px;font-weight:700;color:var(--green);margin-bottom:6px;" id="contactCountDisplay"></div>
            <div id="contactList" style="font-size:11px;color:var(--muted);max-height:150px;overflow-y:auto;"></div>
            <div id="csvErrors" style="margin-top:8px;"></div>
          </div>
        </div>
        <div class="card" id="campaignForm" style="display:none;">
          <div class="card-title green">📝 Campaign Setup</div>
          <div class="fgroup"><label>Campaign Name</label><input type="text" id="campaignName" placeholder="March Follow-Up 2025"></div>
          <div class="fgroup">
            <label>Message Template <span style="color:var(--muted);font-size:10px;">— must include {name}</span></label>
            <textarea id="messageTemplate" rows="4" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:10px;font-size:13px;font-family:'Outfit',sans-serif;resize:vertical;" oninput="document.getElementById('charCount').textContent=this.value.length">Hi {name}! 👋 This is Sarah from First Financial. We have some great vehicles in stock — are you still looking? (Reply STOP to opt out)</textarea>
            <div style="font-size:11px;color:var(--muted);text-align:right;margin-top:4px;"><span id="charCount">0</span> characters</div>
          </div>
          <button class="btn btn-primary btn-full" onclick="launchBulkCampaign()">🚀 Launch Campaign</button>
        </div>
      </div>
      <div>
        <div class="card" id="progressTracker" style="display:none;">
          <div class="card-title">📊 Campaign Progress</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;text-align:center;">
            <div style="background:var(--surface2);border-radius:6px;padding:10px;"><div style="font-size:22px;font-weight:800;color:var(--green);" id="sentCount">0</div><div style="font-size:10px;color:var(--muted);text-transform:uppercase;">Sent</div></div>
            <div style="background:var(--surface2);border-radius:6px;padding:10px;"><div style="font-size:22px;font-weight:800;color:var(--amber);" id="pendingCount">0</div><div style="font-size:10px;color:var(--muted);text-transform:uppercase;">Pending</div></div>
            <div style="background:var(--surface2);border-radius:6px;padding:10px;"><div style="font-size:22px;font-weight:800;color:var(--red);" id="failedCount">0</div><div style="font-size:10px;color:var(--muted);text-transform:uppercase;">Failed</div></div>
          </div>
          <div class="bulk-progress"><div class="bulk-progress-bar" id="progressBar" style="width:0%"></div></div>
          <div style="font-size:11px;color:var(--muted);text-align:center;margin-top:4px;" id="progressText">Ready</div>
        </div>
        <div class="card">
          <div class="card-title amber">⚙️ Bulk Controls</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn btn-primary btn-full" onclick="checkBulkStatus()">📊 Check Status</button>
            <button class="btn btn-amber btn-full" onclick="pauseBulkSMS()">⏸️ Pause</button>
            <button class="btn btn-ghost btn-full" onclick="resumeBulkSMS()">▶️ Resume</button>
            <button class="btn btn-ghost btn-full" onclick="wipeBulkMessages()" style="border-color:rgba(245,158,11,.3);color:var(--amber);">🗑️ Wipe Queue</button>
            <button class="btn btn-full" onclick="emergencyStopBulk()" style="background:var(--red);color:white;border-color:var(--red);font-weight:800;">🚨 EMERGENCY STOP</button>
          </div>
          <div id="bulkStatusDisplay" style="display:none;margin-top:12px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Voice Tab ── -->
  <div id="stab-voice" class="mgr-content">
    <div style="background:rgba(6,182,212,.07);border:1px solid rgba(6,182,212,.2);border-radius:8px;padding:12px 16px;margin-bottom:16px;font-size:12px;color:#06b6d4;">
      <strong>📋 One-time Twilio setup for inbound calls:</strong><br>
      Twilio console → Phone Numbers → your number → Voice → A call comes in → Webhook<br>
      Set to: <code style="background:rgba(0,0,0,.2);padding:2px 6px;border-radius:4px;font-size:11px;">POST https://firstfin.up.railway.app/api/voice/inbound</code>
    </div>
    <div class="two-col" style="align-items:start;">
      <div class="card">
        <div class="card-title">📵 Single Voicemail Drop</div>
        <div class="two-col">
          <div class="fgroup"><label>Phone Number</label><input type="tel" id="vd_phone" class="phone-fmt" placeholder="(587) 000-0000" oninput="formatPhoneInput(this)"></div>
          <div class="fgroup"><label>Customer Name</label><input type="text" id="vd_name" placeholder="First Name"></div>
        </div>
        <div class="fgroup">
          <label>Message Script <span style="color:var(--muted);font-size:10px;">(use {name} for customer's name)</span></label>
          <textarea id="vd_message" rows="4" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:10px;font-size:13px;font-family:'Outfit',sans-serif;resize:vertical;">Hi {name}, this is calling from First Financial. We have some great vehicles in stock right now and I would love to find you something perfect. Give us a call back or just reply to this number by text. Talk soon!</textarea>
        </div>
        <button class="btn btn-primary btn-full" onclick="sendVoiceDrop()">📞 Send Voicemail Drop</button>
        <div id="voiceDropResult" style="display:none;margin-top:10px;padding:10px;border-radius:6px;font-size:12px;"></div>
      </div>
      <div class="card">
        <div class="card-title">📋 Bulk Voice Campaign</div>
        <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:6px;padding:10px;margin-bottom:12px;font-size:11px;color:var(--amber);">⚡ Pulls from CRM. Each call spaced 10 seconds apart to avoid carrier flags. Customer can press 1 to connect live.</div>
        <div class="fgroup">
          <label>Message Script <span style="color:var(--muted);font-size:10px;">(use {name})</span></label>
          <textarea id="vc_message" rows="4" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:10px;font-size:13px;font-family:'Outfit',sans-serif;resize:vertical;">Hi {name}, this is calling from First Financial with a special offer just for you. Reply to this number by text or press 1 to connect with us now. Thanks!</textarea>
        </div>
        <div class="fgroup">
          <label>Target CRM Status</label>
          <select id="vc_status" onchange="updateVCCount()" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:9px;">
            <option value="Lead">Lead</option>
            <option value="Contacted">Contacted</option>
            <option value="Test Drive">Test Drive</option>
            <option value="Negotiating">Negotiating</option>
            <option value="all">All Statuses</option>
          </select>
        </div>
        <div id="vcTargetCount" style="font-size:11px;color:var(--muted);margin-bottom:10px;"></div>
        <button class="btn btn-amber btn-full" onclick="sendVoiceCampaign()">🚀 Launch Voice Campaign</button>
      </div>
    </div>
  </div>

  <!-- ── Analytics Tab ── -->
  <div id="stab-sarahanalytics" class="mgr-content">
    <div class="insight-grid">
      <div class="insight-card" style="background:linear-gradient(135deg,rgba(30,90,246,.2),rgba(30,90,246,.08));border:1px solid rgba(30,90,246,.3);">
        <div class="insight-label" style="color:rgba(255,255,255,.6);">Conversion Rate</div>
        <div class="insight-big" style="color:var(--primary);" id="sa-convRate">—</div>
        <div class="insight-sub" id="sa-convDetail" style="color:var(--muted);">—</div>
      </div>
      <div class="insight-card" style="background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(16,185,129,.06));border:1px solid rgba(16,185,129,.3);">
        <div class="insight-label" style="color:rgba(255,255,255,.6);">Response Rate</div>
        <div class="insight-big" style="color:var(--green);" id="sa-respRate">—</div>
        <div class="insight-sub" id="sa-respDetail" style="color:var(--muted);">—</div>
      </div>
      <div class="insight-card" style="background:linear-gradient(135deg,rgba(245,158,11,.15),rgba(245,158,11,.06));border:1px solid rgba(245,158,11,.3);">
        <div class="insight-label" style="color:rgba(255,255,255,.6);">Avg Msgs/Conv</div>
        <div class="insight-big" style="color:var(--amber);" id="sa-avgMsg">—</div>
        <div class="insight-sub" style="color:var(--muted);">per conversation</div>
      </div>
      <div class="insight-card" style="background:linear-gradient(135deg,rgba(139,92,246,.15),rgba(139,92,246,.06));border:1px solid rgba(139,92,246,.3);">
        <div class="insight-label" style="color:rgba(255,255,255,.6);">This Week</div>
        <div class="insight-big" style="color:#8b5cf6;" id="sa-weekConv">—</div>
        <div class="insight-sub" id="sa-weekDetail" style="color:var(--muted);">—</div>
      </div>
    </div>
    <div class="two-col">
      <div class="card">
        <div class="card-title">🚗 Top Vehicle Types</div>
        <div id="sa-topVehicles" style="font-size:12px;color:var(--muted);">Loading...</div>
      </div>
      <div class="card">
        <div class="card-title green">💰 Budget Distribution</div>
        <div id="sa-budgetDist" style="font-size:12px;color:var(--muted);">Loading...</div>
      </div>
    </div>

  <!-- ── Voicemails Tab ── -->
  <div id="stab-voicemails" class="mgr-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;">
      <div style="font-size:12px;color:var(--muted);">Inbound voicemails with auto-transcription. Requires Twilio inbound webhook configured.</div>
      <button class="btn btn-primary btn-sm" onclick="loadVoicemails()">🔄 Refresh</button>
    </div>
    <div id="voicemailsList" style="max-height:600px;overflow-y:auto;">
      <div style="text-align:center;padding:40px;color:var(--muted);">Click Refresh to load voicemails.</div>
    </div>
  </div>

</section>

<!-- ═══ PRESENTATION OVERLAY ═══ -->
<div id="presentationOverlay">
  <button class="pres-close" onclick="closePresentation()">✕ ESC to Close</button>
  <div class="pres-dealership" id="presDealer">FIRST FINANCIAL</div>
  <div class="pres-vehicle" id="presVehicle">YOUR VEHICLE</div>
  <div class="pres-sub" id="presSub">Professional Financing Available</div>
  <div class="pres-payment-ladder" id="presPaymentLadder"></div>
  <div class="pres-footer" id="presFooter">All payments include applicable taxes. OAC — Subject to credit approval.</div>
</div>

<!-- ═══ PRINT WORKSHEET (hidden, print-only) ═══ -->
<div id="printWorksheet">
  <div class="pw-header">
    <div class="pw-title" id="pw-dealer-name">FIRST FINANCIAL</div>
    <div class="pw-sub">VEHICLE PURCHASE & FINANCING WORKSHEET</div>
    <div style="font-size:9px;margin-top:6px;" id="pw-date"></div>
  </div>
  <div class="pw-grid">
    <div class="pw-section">
      <div class="pw-section-title">🚘 Vehicle</div>
      <div class="pw-row"><span>Description</span><strong id="pw-desc">—</strong></div>
      <div class="pw-row"><span>Stock #</span><strong id="pw-stock">—</strong></div>
      <div class="pw-row"><span>VIN (Last 8)</span><strong id="pw-vin">—</strong></div>
      <div class="pw-row"><span>Odometer</span><strong id="pw-km">—</strong></div>
      <div class="pw-row"><span>Condition</span><strong id="pw-cond">—</strong></div>
    </div>
    <div class="pw-section">
      <div class="pw-section-title">👤 Customer</div>
      <div class="pw-row"><span>Name</span><strong id="pw-name">—</strong></div>
      <div class="pw-row"><span>Phone</span><strong id="pw-phone">—</strong></div>
      <div class="pw-row"><span>Email</span><strong id="pw-email">—</strong></div>
    </div>
  </div>
  <div class="pw-section" style="margin-bottom:12px;">
    <div class="pw-section-title">💰 Financial Summary</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;">
      <div class="pw-row"><span>Selling Price</span><strong id="pw-price">—</strong></div>
      <div class="pw-row"><span>Doc Fee</span><strong id="pw-doc">—</strong></div>
      <div class="pw-row"><span>Trade Allowance</span><strong id="pw-trade">—</strong></div>
      <div class="pw-row"><span>Trade Payoff</span><strong id="pw-payoff">—</strong></div>
      <div class="pw-row"><span>GST</span><strong id="pw-gst">—</strong></div>
      <div class="pw-row"><span>APR</span><strong id="pw-apr">—</strong></div>
    </div>
  </div>
  <div class="pw-otd"><div style="font-size:10px;font-weight:700;letter-spacing:2px;color:#666;margin-bottom:4px;">TOTAL OUT-THE-DOOR</div><div class="pw-otd-amount" id="pw-otd">—</div></div>
  <div class="pw-section" style="margin-bottom:12px;">
    <div class="pw-section-title">📋 Payment Options</div>
    <div id="pw-payment-grid"></div>
  </div>
  <div class="pw-section" style="margin-bottom:12px;">
    <div class="pw-section-title">🛡️ F&I Protection Package</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;">
      <div class="pw-row"><span>Vehicle Service Contract</span><strong id="pw-vsc">—</strong></div>
      <div class="pw-row"><span>GAP Insurance</span><strong id="pw-gap">—</strong></div>
      <div class="pw-row"><span>Tire & Wheel</span><strong id="pw-tw">—</strong></div>
      <div class="pw-row"><span>Wear Appearance</span><strong id="pw-wa">—</strong></div>
    </div>
  </div>
  <div class="pw-sig">
    <div><div class="pw-sig-line">Customer Signature / Date</div></div>
    <div><div class="pw-sig-line">Sales Representative / Date</div></div>
  </div>
  <div class="pw-disclaimer">Payments are estimates. Actual rate and terms subject to lender approval. All prices in CAD. GST included. Additional fees may apply. This worksheet does not constitute a binding agreement.</div>
</div>

<!-- ═══ LENDER RATE EDITOR MODAL ═══ -->
<div class="modal-overlay" id="lenderRateModal" onclick="closeModalOutside(event,'lenderRateModal')">
  <div class="modal-box" style="max-width:800px;">
    <button class="modal-close" onclick="closeModal('lenderRateModal')">×</button>
    <div class="modal-title">✏️ Lender Rate Editor</div>
    <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.3);border-radius:6px;padding:10px;margin-bottom:16px;font-size:11px;color:var(--amber);">
      ⚠️ Changes are saved locally to this device. Hard-limit lenders use these for eligibility checks. Credit-based lenders (CIBC, RBC) use only Max LTV.
    </div>
    <div class="lre-grid" id="lenderRateEditorGrid"></div>
    <div style="display:flex;gap:10px;margin-top:16px;">
      <button class="btn btn-primary" onclick="saveLenderRates()">💾 Save All Changes</button>
      <button class="btn btn-ghost" onclick="resetLenderRates()">↩️ Reset to Defaults</button>
    </div>
  </div>
</div>

<div id="toast">✅ Saved!</div>

<script src="/js/api-client.js"></script>
<script>
// ═══════════════════════════════════════════════════════
// FIRST-FIN DEALER PLATFORM v1.0
// Unified: Dealer Desk + AutoLend + CRM + Analytics
// ═══════════════════════════════════════════════════════

// ── SETTINGS ──────────────────────────────────────────
let settings = JSON.parse(localStorage.getItem('ffSettings') || '{}');
settings = {salesName:'Franco Fannin',dealerName:'Automaxx',docFee:998,gst:5,apr:8.99,target:30,...settings};
let dealLog = JSON.parse(localStorage.getItem('ffDealLog') || '[]');
let crmData  = JSON.parse(localStorage.getItem('ffCRM')     || '[]');

// ── INVENTORY DATA (loaded from cloud) ────────────────
let inventory = [];

// ── LENDER DATA ─────────────────────────────────────────
const lenders = {
  autocapital:{name:"AUTOCAPITAL CANADA",phone:"855-646-0534",web:"autocapitalcanada.ca",minYear:2015,maxMileage:195000,maxCarfax:7500,maxLTV:175,hard:true,
    programs:[
      {tier:"Tier 1 — Prime",rate:"13.49%",fico:"680+",minYear:2025,maxMile:"Unlimited",maxCfx:"$0",maxLtv:"175%"},
      {tier:"Tier 2 — Standard",rate:"14.49%",fico:"620–679",minYear:2024,maxMile:"Unlimited",maxCfx:"$2,500",maxLtv:"175%"},
      {tier:"Tier 3 — Good",rate:"15.99%",fico:"590–619",minYear:2023,maxMile:"195,000",maxCfx:"$5,000",maxLtv:"165%"},
      {tier:"Tier 4 — Fair",rate:"17.99%",fico:"560–589",minYear:2022,maxMile:"195,000",maxCfx:"$5,000",maxLtv:"165%"},
      {tier:"Tier 5 — Poor",rate:"21.49%",fico:"540–559",minYear:2020,maxMile:"195,000",maxCfx:"$7,500",maxLtv:"150%"},
      {tier:"Tier 6 — Subprime",rate:"23.49%",fico:"<540",minYear:2015,maxMile:"195,000",maxCfx:"$7,500",maxLtv:"150%"}
    ]},
  cibc:{name:"CIBC AUTO FINANCE",phone:"1-855-598-1856",web:"cibc.com/auto",minYear:2015,maxMileage:null,maxCarfax:null,maxLTV:96,hard:false,
    programs:[
      {tier:"Chequing Acct Program",rate:"6.36%",fico:"N/A",minYear:2019,maxMile:"Credit-based",maxCfx:"Credit-based",maxLtv:"96%"},
      {tier:"2023–2026 Vehicles",rate:"7.29%–9.49%",fico:"Various",minYear:2023,maxMile:"Credit-based",maxCfx:"Credit-based",maxLtv:"96%"},
      {tier:"2018–2022 Vehicles",rate:"7.29%–9.49%",fico:"Various",minYear:2018,maxMile:"Credit-based",maxCfx:"Credit-based",maxLtv:"84%"},
      {tier:"Newcomers Program",rate:"Varies",fico:"No history",minYear:2015,maxMile:"Credit-based",maxCfx:"Credit-based",maxLtv:"96%"}
    ]},
  edenpark:{name:"EDENPARK",phone:"1-855-366-8667",web:"edenparkfinancial.ca",minYear:2015,maxMileage:180000,maxCarfax:7500,maxLTV:140,hard:true,
    programs:[
      {tier:"Tier A",rate:"11.99%",fico:"640+",minYear:2020,maxMile:"180,000",maxCfx:"$5,000",maxLtv:"140%"},
      {tier:"Tier B",rate:"15.99%",fico:"600–639",minYear:2017,maxMile:"180,000",maxCfx:"$7,500",maxLtv:"135%"},
      {tier:"Tier C",rate:"19.99%",fico:"560–599",minYear:2016,maxMile:"180,000",maxCfx:"$7,500",maxLtv:"130%"},
      {tier:"Tier D",rate:"23.99%",fico:"<560",minYear:2015,maxMile:"170,000",maxCfx:"$7,500",maxLtv:"125%"}
    ]},
  iceberg:{name:"ICEBERG FINANCE",phone:"855-694-0960",web:"icebergfinance.ca",minYear:2012,maxMileage:180000,maxCarfax:6500,maxLTV:140,hard:true,
    programs:[
      {tier:"Tier 1",rate:"12.99%",fico:"640+",minYear:2018,maxMile:"150,000",maxCfx:"$3,000",maxLtv:"140%"},
      {tier:"Tier 2",rate:"17.99%",fico:"600–639",minYear:2015,maxMile:"170,000",maxCfx:"$5,000",maxLtv:"135%"},
      {tier:"Tier 3",rate:"22.99%",fico:"560–599",minYear:2013,maxMile:"180,000",maxCfx:"$6,500",maxLtv:"130%"},
      {tier:"Tier 4",rate:"31.99%",fico:"<560",minYear:2012,maxMile:"180,000",maxCfx:"$6,500",maxLtv:"125%"}
    ]},
  northlake:{name:"NORTHLAKE FINANCIAL",phone:"1-888-652-5320",web:"northlakefinancial.ca",minYear:2003,maxMileage:300000,maxCarfax:7500,maxLTV:140,hard:true,
    programs:[
      {tier:"Standard",rate:"10.99%–16.99%",fico:"No min",minYear:2015,maxMile:"200,000",maxCfx:"$5,000",maxLtv:"140%"},
      {tier:"Extended",rate:"17.99%–22.99%",fico:"No min",minYear:2003,maxMile:"300,000",maxCfx:"$7,500",maxLtv:"130%"}
    ]},
  prefera:{name:"PREFERA FINANCE",phone:"1-844-734-3577",web:"preferafinance.ca",minYear:2015,maxMileage:200000,maxCarfax:5000,maxLTV:170,hard:true,
    programs:[
      {tier:"Tier A",rate:"16.95%",fico:"620+",minYear:2018,maxMile:"150,000",maxCfx:"$2,500",maxLtv:"170%"},
      {tier:"Tier B",rate:"21.95%",fico:"580–619",minYear:2016,maxMile:"175,000",maxCfx:"$3,500",maxLtv:"160%"},
      {tier:"Tier C",rate:"25.95%",fico:"550–579",minYear:2015,maxMile:"200,000",maxCfx:"$5,000",maxLtv:"150%"},
      {tier:"Tier D",rate:"30.95%",fico:"<550",minYear:2015,maxMile:"200,000",maxCfx:"$5,000",maxLtv:"140%"}
    ]},
  rbc:{name:"RBC AUTO FINANCE",phone:"1-888-529-6999",web:"rbcautofinance.ca",minYear:2015,maxMileage:null,maxCarfax:null,maxLTV:96,hard:false,
    programs:[
      {tier:"Prime Program",rate:"5.79%–7.99%",fico:"720+",minYear:2019,maxMile:"Credit-based",maxCfx:"Credit-based",maxLtv:"96%"},
      {tier:"Standard Program",rate:"7.99%–9.99%",fico:"650–719",minYear:2015,maxMile:"Credit-based",maxCfx:"Credit-based",maxLtv:"90%"}
    ]},
  santander:{name:"SANTANDER CONSUMER",phone:"1-888-222-4227",web:"santanderconsumerusa.com",minYear:2015,maxMileage:160000,maxCarfax:6000,maxLTV:150,hard:true,
    programs:[
      {tier:"Tier 1",rate:"9.99%–14.99%",fico:"650+",minYear:2018,maxMile:"120,000",maxCfx:"$3,000",maxLtv:"150%"},
      {tier:"Tier 2",rate:"15.99%–21.99%",fico:"600–649",minYear:2016,maxMile:"140,000",maxCfx:"$4,500",maxLtv:"140%"},
      {tier:"Tier 3",rate:"22.99%–29.99%",fico:"<600",minYear:2015,maxMile:"160,000",maxCfx:"$6,000",maxLtv:"130%"}
    ]},
  sda:{name:"SDA FINANCE",phone:"1-800-731-2345",web:"sdafinance.ca",minYear:2012,maxMileage:250000,maxCarfax:8000,maxLTV:135,hard:true,
    programs:[
      {tier:"Standard",rate:"15.99%–24.99%",fico:"No min",minYear:2012,maxMile:"250,000",maxCfx:"$8,000",maxLtv:"135%"}
    ]},
  servus:{name:"SERVUS CREDIT UNION",phone:"1-877-378-8728",web:"servus.ca",minYear:2015,maxMileage:180000,maxCarfax:5000,maxLTV:100,hard:true,
    programs:[
      {tier:"Prime",rate:"6.50%–8.99%",fico:"700+",minYear:2018,maxMile:"150,000",maxCfx:"$3,000",maxLtv:"100%"},
      {tier:"Near Prime",rate:"9.99%–14.99%",fico:"640–699",minYear:2015,maxMile:"180,000",maxCfx:"$5,000",maxLtv:"95%"}
    ]},
  wsleasing:{name:"WS LEASING",phone:"1-888-975-3273",web:"wsleasing.ca",minYear:2018,maxMileage:120000,maxCarfax:3000,maxLTV:100,hard:true,
    programs:[
      {tier:"Lease Program A",rate:"7.99%–11.99%",fico:"680+",minYear:2020,maxMile:"100,000",maxCfx:"$2,000",maxLtv:"100%"},
      {tier:"Lease Program B",rate:"12.99%–16.99%",fico:"640–679",minYear:2018,maxMile:"120,000",maxCfx:"$3,000",maxLtv:"95%"}
    ]}
};

// ── MATH HELPERS ──────────────────────────────────────
function PMT(rate,nper,pv){if(rate===0)return Math.abs(pv/nper);return Math.abs(pv*(rate*Math.pow(1+rate,nper))/(Math.pow(1+rate,nper)-1));}
function PV(rate,nper,pmt){if(rate===0)return pmt*nper;return pmt*((1-Math.pow(1+rate,-nper))/rate);}
const $f = n => '$'+Number(n).toLocaleString('en-CA',{minimumFractionDigits:2,maximumFractionDigits:2});
const $i = n => '$'+Math.round(n).toLocaleString('en-CA');

// ── NAVIGATION ────────────────────────────────────────
function showSection(id, btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('section-'+id).classList.add('active');
  if(btn) btn.classList.add('active');
  if(id==='analytics') refreshAllAnalytics();
}

// ── INVENTORY INIT ────────────────────────────────────
function initInventory(){
  const sel = document.getElementById('stockNum');
  const cmpSel = document.getElementById('compareStock');
  
  // Clear existing options so they don't duplicate when cloud data loads
  sel.innerHTML = '<option value="">— Select Stock # —</option>';
  cmpSel.innerHTML = '<option value="">— Choose a vehicle —</option>';

  inventory.forEach(v=>{
    const label = `${v.stock} — ${v.year} ${v.make} ${v.model} ($${v.price.toLocaleString()})`;
    sel.innerHTML += `<option value="${v.stock}">${label}</option>`;
    cmpSel.innerHTML += `<option value="${v.stock}">${label}</option>`;
  });
  renderInventory(inventory);
}

function renderInventory(list){
  document.getElementById('invCount').textContent = `${list.length} vehicles`;
  const tbody = document.getElementById('inventoryBody');
  tbody.innerHTML = list.map(v=>`
    <tr onclick="sendToDeal('${v.stock}')">
      <td><strong style="color:var(--amber);">${v.stock}</strong></td>
      <td>${v.year}</td>
      <td>${v.make}</td>
      <td>${v.model}</td>
      <td style="color:var(--muted);">${v.type||''}</td>
      <td>${v.mileage.toLocaleString()} km</td>
      <td><strong style="color:var(--green);">$${v.price.toLocaleString()}</strong></td>
      <td><span class="badge badge-${v.condition.toLowerCase()}">${v.condition}</span></td>
      <td><button class="btn btn-primary btn-sm" onclick="event.stopPropagation();sendToDeal('${v.stock}')">Use in Deal</button></td>
    </tr>`).join('');
}

function filterInventory(){
  const q = document.getElementById('invSearch').value.toLowerCase();
  const filtered = inventory.filter(v=>
    v.stock.toLowerCase().includes(q)||v.make.toLowerCase().includes(q)||
    v.model.toLowerCase().includes(q)||String(v.year).includes(q)||
    String(v.price).includes(q)||v.condition.toLowerCase().includes(q)
  );
  renderInventory(filtered);
}

function sendToDeal(stock){
  const v = inventory.find(x=>x.stock===stock);
  if(!v) return;
  document.getElementById('stockNum').value = stock;
  document.getElementById('vehicleDesc').value = `${v.year} ${v.make} ${v.model}`;
  document.getElementById('vehicleType').value = v.type||'';
  document.getElementById('odometer').value = v.mileage;
  document.getElementById('condition').value = v.condition;
  document.getElementById('sellingPrice').value = v.price;
  document.getElementById('docFee').value = settings.docFee;
  calculate();
  showSection('deal', document.querySelector('.nav-btn'));
  document.querySelector('.nav-btn').classList.add('active');
  toast(`✅ Loaded: ${v.year} ${v.make} ${v.model}`);
}

function loadVehicleFromStock(){
  const stock = document.getElementById('stockNum').value;
  if(stock) sendToDeal(stock);
}

// ── DEAL DESK CALCULATIONS ────────────────────────────
function calculate(){
  const price  = parseFloat(document.getElementById('sellingPrice').value)||0;
  const doc    = parseFloat(document.getElementById('docFee').value)||0;
  const tAllow = parseFloat(document.getElementById('tradeAllow').value)||0;
  const tPayoff= parseFloat(document.getElementById('tradePayoff').value)||0;
  const apr    = parseFloat(document.getElementById('apr').value)||0;
  const gst    = parseFloat(document.getElementById('gstRate').value)||5;

  const netTrade = tAllow - tPayoff;
  const gstAmt   = (price + doc - netTrade) * (gst/100);
  const otd      = price + doc - netTrade + gstAmt;

  const finalDown = parseFloat(document.getElementById('finalDown').value)||0;

  document.getElementById('gstAmount').value = $f(gstAmt);
  document.getElementById('totalOTD').textContent = $f(otd);

  // Update final down / finance amount summary boxes
  const finAmt = Math.max(0, otd - finalDown);
  const fdEl = document.getElementById('finalDownDisplay');
  const faEl = document.getElementById('financeAmountDisplay');
  if(fdEl) fdEl.textContent = '$' + finalDown.toLocaleString();
  if(faEl) faEl.textContent = '$' + Math.round(finAmt).toLocaleString();

  const mr = apr/100/12;
  const downs = [0,2000,5000];
  const terms = [48,60,72,84];
  let html = '';
  // Highlight the row matching finalDown if it matches one of the preset rows
  downs.forEach(down=>{
    const isChosen = finalDown > 0 && Math.abs(down - finalDown) < 1;
    html += `<tr${isChosen?' style="background:rgba(245,158,11,.08);"':''}>`;
    html += `<td><strong style="color:var(--text);">$${down.toLocaleString()}</strong></td>`;
    terms.forEach(t=>{
      const fin = otd - down;
      const pmt = PMT(mr,t,-fin);
      html += `<td class="payment-val">${$f(pmt)}</td>`;
    });
    html += '</tr>';
  });
  // Final down row — shows chosen deal structure payment
  if(finalDown > 0 && ![0,2000,5000].includes(finalDown)){
    html += `<tr style="background:rgba(245,158,11,.1);outline:1px solid rgba(245,158,11,.3);">`;
    html += `<td><strong style="color:var(--amber);">$${finalDown.toLocaleString()} ★</strong></td>`;
    [48,60,72,84].forEach(t=>{
      const fin = Math.max(0, otd - finalDown);
      const pmt = PMT(mr,t,-fin);
      html += `<td class="payment-val" style="color:var(--amber);font-weight:800;">${$f(pmt)}</td>`;
    });
    html += '</tr>';
  }
  html += `<tr>
    <td><input type="number" id="customDown" placeholder="Custom $" style="width:100%;padding:7px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-weight:700;text-align:center;" oninput="calcCustom()"></td>
    <td class="payment-val" id="c48">—</td><td class="payment-val" id="c60">—</td>
    <td class="payment-val" id="c72">—</td><td class="payment-val" id="c84">—</td>
  </tr>`;
  document.getElementById('paymentGrid').innerHTML = html;

  const vsc = parseFloat(document.getElementById('vscPrice').value)||0;
  const gap = parseFloat(document.getElementById('gapPrice').value)||0;
  const tw  = parseFloat(document.getElementById('twPrice').value)||0;
  const wa  = parseFloat(document.getElementById('waPrice').value)||0;

  const b72 = PMT(mr,72,-otd);
  document.getElementById('basePayment72').textContent = $f(b72);
  document.getElementById('withGap').textContent = $f(b72+(gap/72));
  document.getElementById('withGapVsc').textContent = $f(b72+(gap/72)+(vsc/72));
  document.getElementById('withAllProtection').textContent = $f(b72+(gap/72)+(vsc/72)+(tw/72));
  document.getElementById('fullProtection').textContent = $f(b72+(gap/72)+(vsc/72)+(tw/72)+(wa/72));

  document.getElementById('vscImpact').textContent = '+'+$f(vsc/72)+'/mo';
  document.getElementById('gapImpact').textContent = '+'+$f(gap/72)+'/mo';
  document.getElementById('twImpact').textContent  = '+'+$f(tw/72)+'/mo';
  document.getElementById('waImpact').textContent  = '+'+$f(wa/72)+'/mo';

  calculateProfit();
  calculateReserve();
  calculateSubprime();
  calculatePTI();
}

function calcCustom(){
  const down = parseFloat(document.getElementById('customDown').value)||0;
  const price  = parseFloat(document.getElementById('sellingPrice').value)||0;
  const doc    = parseFloat(document.getElementById('docFee').value)||0;
  const tAllow = parseFloat(document.getElementById('tradeAllow').value)||0;
  const tPayoff= parseFloat(document.getElementById('tradePayoff').value)||0;
  const apr    = parseFloat(document.getElementById('apr').value)||0;
  const gst    = parseFloat(document.getElementById('gstRate').value)||5;
  const netTrade = tAllow - tPayoff;
  const gstAmt   = (price + doc - netTrade) * (gst/100);
  const otd      = price + doc - netTrade + gstAmt;
  const mr = apr/100/12;
  const fin = otd - down;
  [48,60,72,84].forEach(t=>{
    const el = document.getElementById('c'+t);
    if(el) el.textContent = fin>0?$f(PMT(mr,t,-fin)):'—';
  });
}

function calculateProfit(){
  const price = parseFloat(document.getElementById('sellingPrice').value)||0;
  const acv   = parseFloat(document.getElementById('unitAcv').value)||0;
  const recon = parseFloat(document.getElementById('recon').value)||0;
  const pack  = parseFloat(document.getElementById('lotPack').value)||0;
  const totalCost = acv+recon+pack;
  const front = price - totalCost;
  const vscP = (parseFloat(document.getElementById('vscPrice').value)||0)-(parseFloat(document.getElementById('vscCost').value)||0);
  const gapP = (parseFloat(document.getElementById('gapPrice').value)||0)-(parseFloat(document.getElementById('gapCost').value)||0);
  const twP  = (parseFloat(document.getElementById('twPrice').value)||0)-(parseFloat(document.getElementById('twCost').value)||0);
  const waP  = (parseFloat(document.getElementById('waPrice').value)||0)-(parseFloat(document.getElementById('waCost').value)||0);
  const total = front+vscP+gapP+twP+waP+500;
  document.getElementById('totalCost').textContent  = $i(totalCost);
  document.getElementById('frontGross').textContent = $i(front);
  document.getElementById('vscProfit').textContent  = $i(vscP);
  document.getElementById('gapProfit').textContent  = $i(gapP);
  document.getElementById('twProfit').textContent   = $i(twP);
  document.getElementById('waProfit').textContent   = $i(waP);
  document.getElementById('totalGross').textContent = 'TOTAL GROSS: '+$i(total);
  document.getElementById('fePercent').textContent  = total?((front/total)*100).toFixed(1)+'%':'0%';
  document.getElementById('bePercent').textContent  = total?(((total-front)/total)*100).toFixed(1)+'%':'0%';
  document.getElementById('pvr').textContent        = $i(total);
}

function calculateReserve(){
  const contract = parseFloat(document.getElementById('contractRate').value)||0;
  const buy      = parseFloat(document.getElementById('buyRate').value)||0;
  const split    = parseFloat(document.getElementById('bankSplit').value)||75;
  const term     = parseFloat(document.getElementById('reserveTerm').value)||72;
  const price    = parseFloat(document.getElementById('sellingPrice').value)||0;
  const spread   = contract - buy;
  const reserve  = (price*(spread/100)*(term/12))*(split/100);
  document.getElementById('rateSpread').textContent   = spread.toFixed(2)+'%';
  document.getElementById('reserveProfit').textContent= $i(reserve);
}

function calculateSubprime(){
  const advance = parseFloat(document.getElementById('subAdvance').value)||0;
  const nada    = parseFloat(document.getElementById('subNada').value)||0;
  const ltv     = nada>0?((advance/nada)*100).toFixed(1)+'%':'N/A';
  document.getElementById('dealLTV').textContent = ltv;
}

function calculatePTI(){
  const income   = parseFloat(document.getElementById('monthlyIncome').value)||0;
  const existing = parseFloat(document.getElementById('existingPayments').value)||0;
  const ptiLimit = parseFloat(document.getElementById('ptiLimit').value)||20;
  const price    = parseFloat(document.getElementById('sellingPrice').value)||0;
  const doc      = parseFloat(document.getElementById('docFee').value)||0;
  const tAllow   = parseFloat(document.getElementById('tradeAllow').value)||0;
  const tPayoff  = parseFloat(document.getElementById('tradePayoff').value)||0;
  const apr      = parseFloat(document.getElementById('apr').value)||0;
  const gst      = parseFloat(document.getElementById('gstRate').value)||5;
  const netTrade = tAllow-tPayoff;
  const gstAmt   = (price+doc-netTrade)*(gst/100);
  const otd      = price+doc-netTrade+gstAmt;
  const mr       = apr/100/12;
  const payment  = PMT(mr,72,-otd);
  const totalPayments = payment+existing;
  const pti = income>0?((totalPayments/income)*100):0;
  document.getElementById('ptiResult').textContent = pti.toFixed(1)+'%';
  const status = pti<=ptiLimit?'✅ PASS':'⚠️ EXCEEDS LIMIT';
  document.getElementById('ptiStatus').textContent = status;
  document.getElementById('ptiStatus').style.color = pti<=ptiLimit?'var(--green)':'var(--red)';
}

function assessRisk(){
  const score = parseInt(document.getElementById('creditScore').value)||0;
  const risk = document.getElementById('refiRisk');
  const resStatus = document.getElementById('reserveStatus');
  if(score>=750){risk.textContent='🟢 LOW';risk.style.color='var(--green)';resStatus.textContent='🔒 SECURE';resStatus.style.color='var(--green)';}
  else if(score>=700){risk.textContent='🟡 MODERATE';risk.style.color='var(--amber)';resStatus.textContent='⚠️ WATCH';resStatus.style.color='var(--amber)';}
  else if(score>=650){risk.textContent='🟠 ELEVATED';risk.style.color='var(--amber)';resStatus.textContent='⚠️ AT RISK';resStatus.style.color='var(--amber)';}
  else{risk.textContent='🔴 HIGH';risk.style.color='var(--red)';resStatus.textContent='🚨 CHARGEBACKS';resStatus.style.color='var(--red)';}
}

function calculateTrade(){
  const acv   = parseFloat(document.getElementById('acv').value)||0;
  const adj   = parseFloat(document.getElementById('conditionAdj').value)||0;
  const safety= parseFloat(document.getElementById('safetyInspect').value)||0;
  const recon = parseFloat(document.getElementById('reconditionCost').value)||0;
  const totalRecon = safety+recon+adj;
  const adjACV = acv-totalRecon;
  const tAllow  = parseFloat(document.getElementById('tradeAllow').value)||0;
  const tPayoff = parseFloat(document.getElementById('tradePayoff').value)||0;
  const equity  = tAllow-tPayoff;
  document.getElementById('totalRecon').value = $f(totalRecon);
  document.getElementById('adjustedACV').value= $f(adjACV);
  document.getElementById('tradeEquity').value= $f(equity);
  document.getElementById('tradeEquity').style.color= equity>=0?'var(--green)':'var(--red)';
}

// ── MANAGER TABS ──────────────────────────────────────
function showMgrTab(id,btn){
  document.querySelectorAll('.mgr-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.mgr-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('mgr-'+id).classList.add('active');
  if(btn) btn.classList.add('active');
}

// ── QUICK TOOLS ───────────────────────────────────────
function quickCalc(){
  const a=parseFloat(document.getElementById('toolAmount').value)||0;
  const r=parseFloat(document.getElementById('toolRate').value)||0;
  const t=parseInt(document.getElementById('toolTerm').value)||72;
  document.getElementById('quickResult').textContent = $f(PMT(r/100/12,t,-a))+' / month';
}
function reverseCalc(){
  const pmt=parseFloat(document.getElementById('revPayment').value)||0;
  const r=parseFloat(document.getElementById('revRate').value)||0;
  const t=parseInt(document.getElementById('revTerm').value)||72;
  document.getElementById('reverseResult').textContent = 'Max: '+$f(PV(r/100/12,t,pmt));
}
function calcMargin(){
  const cost=parseFloat(document.getElementById('mCost').value)||0;
  const sell=parseFloat(document.getElementById('mSell').value)||0;
  const profit=sell-cost;
  const pct=sell>0?((profit/sell)*100).toFixed(1):0;
  document.getElementById('marginResult').textContent = $i(profit)+' profit — '+pct+'%';
}

// ── BRIDGE: DEAL DESK → COMPARE ───────────────────────
function bridgeToCompare(){
  const stock = document.getElementById('stockNum').value;
  if(!stock){toast('⚠️ Select a vehicle stock number first');return;}
  const down  = parseFloat(document.getElementById('tradeAllow').value)||0;
  const fees  = parseFloat(document.getElementById('docFee').value)||0;
  document.getElementById('compareStock').value = stock;
  document.getElementById('compareDown').value  = down;
  document.getElementById('compareFees').value  = fees;
  showSection('compare', document.querySelectorAll('.nav-btn')[3]);
  runComparison();
  toast('⚡ Lender comparison loaded!');
}

// ── LENDER SECTION INIT ───────────────────────────────
function initLenderPanels(){
  const container = document.getElementById('lender-panels');
  Object.entries(lenders).forEach(([lid,l])=>{
    const warnNote = !l.hard?`<div class="warning-box">ℹ️ ${l.name} uses a credit profile-based approval. Mileage and Carfax limits may vary based on full application review.</div>`:'';
    const html = `
    <div id="lq-${lid}" class="lcontent ${lid==='autocapital'?'active':''}">
      <div class="lender-header-box">
        <div class="lender-name-big">${l.name}</div>
        <div class="lender-contact-row">
          <div>📞 <span>${l.phone}</span></div>
          <div>🌐 <span>${l.web}</span></div>
          <div>Max LTV: <span>${l.maxLTV}%</span></div>
          ${l.maxMileage?`<div>Max Mileage: <span>${l.maxMileage.toLocaleString()} km</span></div>`:''}
          ${l.maxCarfax?`<div>Max Carfax: <span>$${l.maxCarfax.toLocaleString()}</span></div>`:''}
        </div>
      </div>
      ${warnNote}
      <table class="programs-table">
        <thead><tr><th>Program / Tier</th><th>Rate</th><th>Min FICO</th><th>Min Year</th><th>Max Mileage</th><th>Max Carfax</th><th>Max LTV</th></tr></thead>
        <tbody>${l.programs.map(p=>`<tr><td><strong>${p.tier}</strong></td><td style="color:var(--amber);">${p.rate}</td><td>${p.fico}</td><td>${p.minYear}</td><td>${p.maxMile}</td><td>${p.maxCfx}</td><td>${p.maxLtv}</td></tr>`).join('')}</tbody>
      </table>
      <div class="checker-box">
        <div class="checker-title">🔍 Vehicle Approval Checker</div>
        <div class="fgroup">
          <label>Select Vehicle</label>
          <select id="chk-stock-${lid}" onchange="checkLenderApproval('${lid}')" style="background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:9px 12px;width:100%;font-family:'Outfit',sans-serif;">
            <option value="">— Select a vehicle —</option>
            ${inventory.map(v=>`<option value="${v.stock}">${v.stock} — ${v.year} ${v.make} ${v.model} ($${v.price.toLocaleString()})</option>`).join('')}
          </select>
        </div>
        <div id="chk-results-${lid}"></div>
        <div id="chk-ltv-${lid}" style="display:none;">
          <div class="ltv-result-box" style="margin-top:14px;">
            <div style="font-weight:700;font-size:13px;margin-bottom:12px;color:var(--amber);">💰 LTV Calculator</div>
            <div class="three-col">
              <div class="fgroup"><label>Down Payment ($)</label><input type="number" id="ltv-down-${lid}" value="0" oninput="calcLTV('${lid}')"></div>
              <div class="fgroup"><label>Trade-in ($)</label><input type="number" id="ltv-trade-${lid}" value="0" oninput="calcLTV('${lid}')"></div>
              <div class="fgroup"><label>Add-ons ($)</label><input type="number" id="ltv-fees-${lid}" value="0" oninput="calcLTV('${lid}')"></div>
            </div>
            <div id="ltv-out-${lid}"></div>
          </div>
        </div>
      </div>
    </div>`;
    container.innerHTML += html;
  });

  // Quick Ref panel
  container.innerHTML += `
  <div id="lq-quickref" class="lcontent">
    <div class="card-title" style="margin-bottom:16px;">📊 Quick Reference — All Lenders</div>
    <div class="warning-box">⚠️ CIBC & RBC use rate-based programs without hard mileage/Carfax limits. WS Leasing is a lease program. Data verified January 2026.</div>
    <div class="table-wrap"><table class="qr-table">
      <thead><tr><th>Lender</th><th>Best For</th><th>Min Year</th><th>Max Mileage</th><th>Max Carfax</th><th>Max LTV</th><th>Rate Range</th><th>Phone</th></tr></thead>
      <tbody>
        <tr><td><strong>AutoCapital</strong></td><td>Subprime/Bad Credit</td><td>2015</td><td>195,000 km</td><td>$7,500</td><td>175%</td><td>13.49%–23.49%</td><td>855-646-0534</td></tr>
        <tr><td><strong>CIBC</strong></td><td>Prime/Good Credit</td><td>2015</td><td>Credit-based</td><td>Credit-based</td><td>96%</td><td>6.36%–9.49%</td><td>1-855-598-1856</td></tr>
        <tr><td><strong>EdenPark</strong></td><td>Flexible/Subprime</td><td>2015</td><td>180,000 km</td><td>$7,500</td><td>140%</td><td>11.99%–23.99%</td><td>1-855-366-8667</td></tr>
        <tr><td><strong>Iceberg</strong></td><td>Deep Subprime</td><td>2012</td><td>180,000 km</td><td>$6,500</td><td>140%</td><td>12.99%–31.99%</td><td>855-694-0960</td></tr>
        <tr><td><strong>NorthLake</strong></td><td>No FICO Min</td><td>2003</td><td>300,000 km</td><td>$7,500</td><td>140%</td><td>10.99%–22.99%</td><td>1-888-652-5320</td></tr>
        <tr><td><strong>Prefera</strong></td><td>Standard Credit</td><td>2015</td><td>200,000 km</td><td>$5,000</td><td>170%</td><td>16.95%–30.95%</td><td>1-844-734-3577</td></tr>
        <tr><td><strong>RBC</strong></td><td>Prime/Excellent</td><td>2015</td><td>Credit-based</td><td>Credit-based</td><td>96%</td><td>5.79%–9.99%</td><td>1-888-529-6999</td></tr>
        <tr><td><strong>Santander</strong></td><td>Mid-range Credit</td><td>2015</td><td>160,000 km</td><td>$6,000</td><td>150%</td><td>9.99%–29.99%</td><td>1-888-222-4227</td></tr>
        <tr><td><strong>SDA</strong></td><td>Deep Subprime</td><td>2012</td><td>250,000 km</td><td>$8,000</td><td>135%</td><td>15.99%–24.99%</td><td>1-800-731-2345</td></tr>
        <tr><td><strong>Servus CU</strong></td><td>Local/Member</td><td>2015</td><td>180,000 km</td><td>$5,000</td><td>100%</td><td>6.50%–14.99%</td><td>1-877-378-8728</td></tr>
        <tr><td><strong>WS Leasing</strong></td><td>Lease Program</td><td>2018</td><td>120,000 km</td><td>$3,000</td><td>100%</td><td>7.99%–16.99%</td><td>1-888-975-3273</td></tr>
      </tbody>
    </table></div>
  </div>`;
}

function showLenderTab(id, btn){
  document.querySelectorAll('.lcontent').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.ltab').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(btn) btn.classList.add('active');
}

// ── APPROVAL CHECKER ──────────────────────────────────
function checkLenderApproval(lid){
  const stock = document.getElementById(`chk-stock-${lid}`).value;
  const resDiv = document.getElementById(`chk-results-${lid}`);
  const ltvDiv = document.getElementById(`chk-ltv-${lid}`);
  if(!stock){resDiv.innerHTML='';ltvDiv.style.display='none';return;}
  const v = inventory.find(x=>x.stock===stock);
  const l = lenders[lid];
  const vHTML = `<div class="v-details-grid">
    <div class="vd-item"><div class="vd-label">Stock #</div><div class="vd-value" style="color:var(--amber);">${v.stock}</div></div>
    <div class="vd-item"><div class="vd-label">Year</div><div class="vd-value">${v.year}</div></div>
    <div class="vd-item"><div class="vd-label">Make</div><div class="vd-value">${v.make}</div></div>
    <div class="vd-item"><div class="vd-label">Model</div><div class="vd-value">${v.model}</div></div>
    <div class="vd-item"><div class="vd-label">Mileage</div><div class="vd-value">${v.mileage.toLocaleString()} km</div></div>
    <div class="vd-item"><div class="vd-label">Price</div><div class="vd-value" style="color:var(--green);">$${v.price.toLocaleString()}</div></div>
    <div class="vd-item"><div class="vd-label">Carfax</div><div class="vd-value">$${v.carfax.toLocaleString()}</div></div>
    <div class="vd-item"><div class="vd-label">Condition</div><div class="vd-value">${v.condition}</div></div>
  </div>`;

  if(l.hard){
    const yearOk  = v.year    >= l.minYear;
    const mileOk  = l.maxMileage ? v.mileage <= l.maxMileage : true;
    const cfxOk   = l.maxCarfax  ? v.carfax  <= l.maxCarfax  : true;
    const approved = yearOk && mileOk && cfxOk;
    const decClass = approved?'decision-approved':'decision-rejected';
    const decText  = approved?'✅ VEHICLE ELIGIBLE':'❌ NOT ELIGIBLE';
    resDiv.innerHTML = vHTML+`
      <div class="val-row"><div><div class="val-req">Min Year Required</div><div class="val-sub">Requires ${l.minYear} — Vehicle is ${v.year}</div></div><span class="status-pill ${yearOk?'pill-pass':'pill-fail'}">${yearOk?'✓ PASS':'✗ FAIL'}</span></div>
      <div class="val-row"><div><div class="val-req">Max Mileage</div><div class="val-sub">Limit ${l.maxMileage?l.maxMileage.toLocaleString():'N/A'} km — Vehicle ${v.mileage.toLocaleString()} km</div></div><span class="status-pill ${mileOk?'pill-pass':'pill-fail'}">${mileOk?'✓ PASS':'✗ FAIL'}</span></div>
      <div class="val-row"><div><div class="val-req">Max Carfax Damage</div><div class="val-sub">Limit ${l.maxCarfax?'$'+l.maxCarfax.toLocaleString():'N/A'} — Vehicle $${v.carfax.toLocaleString()}</div></div><span class="status-pill ${cfxOk?'pill-pass':'pill-fail'}">${cfxOk?'✓ PASS':'✗ FAIL'}</span></div>
      <div class="decision-box ${decClass}">${decText}</div>`;
    ltvDiv.style.display = approved?'block':'none';
    if(approved){
      document.getElementById(`ltv-down-${lid}`).value=0;
      document.getElementById(`ltv-trade-${lid}`).value=0;
      document.getElementById(`ltv-fees-${lid}`).value=0;
      calcLTV(lid);
    }
  } else {
    resDiv.innerHTML = vHTML+`
      <div class="val-row"><div><div class="val-req">Approval Method</div><div class="val-sub">Full credit profile review required</div></div><span class="status-pill pill-na">Credit-Based</span></div>
      <div class="decision-box decision-credit">ℹ️ APPROVAL BASED ON FULL CREDIT PROFILE</div>`;
    ltvDiv.style.display = 'block';
    document.getElementById(`ltv-down-${lid}`).value=0;
    document.getElementById(`ltv-trade-${lid}`).value=0;
    document.getElementById(`ltv-fees-${lid}`).value=0;
    calcLTV(lid);
  }
}

function calcLTV(lid){
  const stock = document.getElementById(`chk-stock-${lid}`).value;
  if(!stock) return;
  const v    = inventory.find(x=>x.stock===stock);
  const l    = lenders[lid];
  const down = parseFloat(document.getElementById(`ltv-down-${lid}`).value)||0;
  const trade= parseFloat(document.getElementById(`ltv-trade-${lid}`).value)||0;
  const fees = parseFloat(document.getElementById(`ltv-fees-${lid}`).value)||0;
  const totalCost = v.price + fees;
  const finance   = totalCost - down - trade;
  const ltvPct    = (finance/v.price)*100;
  const maxLoan   = (v.price*l.maxLTV)/100;
  const ok        = ltvPct <= l.maxLTV;
  const barW      = Math.min((ltvPct/l.maxLTV)*100,100);
  const barClass  = ltvPct<=l.maxLTV*0.8?'ltv-ok':ltvPct<=l.maxLTV?'ltv-warn':'ltv-over';
  document.getElementById(`ltv-out-${lid}`).innerHTML = `
    <div class="cline"><span class="cl-label">Vehicle Price</span><span class="cl-value">${$f(v.price)}</span></div>
    <div class="cline"><span class="cl-label">Add-ons/Fees</span><span class="cl-value">+${$f(fees)}</span></div>
    <div class="cline"><span class="cl-label">Down Payment</span><span class="cl-value">-${$f(down)}</span></div>
    <div class="cline"><span class="cl-label">Trade-in</span><span class="cl-value">-${$f(trade)}</span></div>
    <div class="cline" style="border-top:2px solid var(--border2);margin-top:6px;padding-top:10px;"><span class="cl-label" style="font-size:15px;">Amount to Finance</span><span class="cl-value" style="font-size:16px;color:var(--amber);">${$f(finance)}</span></div>
    <div class="cline"><span class="cl-label">Your LTV</span><span class="cl-value" style="color:${ok?'var(--green)':'var(--red)'};">${ltvPct.toFixed(2)}% ${ok?'✓':'⚠️'}</span></div>
    <div class="cline"><span class="cl-label">Max Loan Amount</span><span class="cl-value" style="color:var(--green);">${$f(maxLoan)}</span></div>
    <div class="ltv-bar-wrap"><div class="ltv-bar ${barClass}" style="width:${barW}%"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px;"><span>0%</span><span style="color:${ok?'var(--green)':'var(--red)'};font-weight:700;">${ltvPct.toFixed(1)}% of ${l.maxLTV}% max</span><span>${l.maxLTV}%</span></div>
    <div class="decision-box ${ok?'decision-approved':'decision-rejected'}" style="margin-top:10px;">${ok?'✅ LTV WITHIN LIMITS':'⚠️ LTV EXCEEDED — Increase down or reduce advance'}</div>`;
}

// ── COMPARE ALL LENDERS ENGINE ─────────────────────────
function runComparison(){
  const stock = document.getElementById('compareStock').value;
  const down  = parseFloat(document.getElementById('compareDown').value)||0;
  const trade = parseFloat(document.getElementById('compareTrade').value)||0;
  const fees  = parseFloat(document.getElementById('compareFees').value)||0;
  const ph    = document.getElementById('comparePlaceholder');
  const res   = document.getElementById('compareResults');
  const vCard = document.getElementById('compareVehicleCard');
  if(!stock){ph.style.display='block';res.style.display='none';vCard.style.display='none';return;}
  const v = inventory.find(x=>x.stock===stock);
  if(!v) return;
  ph.style.display='none';vCard.style.display='block';res.style.display='block';
  vCard.innerHTML = `
    <div style="font-size:10px;opacity:.6;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;">Selected Vehicle</div>
    <div style="font-size:20px;font-weight:800;margin-bottom:12px;">${v.year} ${v.make} ${v.model}</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px;">
      ${[['Stock',v.stock],['Mileage',v.mileage.toLocaleString()+' km'],['Price','$'+v.price.toLocaleString()],['Condition',v.condition],['Carfax','$'+v.carfax.toLocaleString()],['Type',v.type||'—']].map(([k,val])=>`<div style="background:rgba(255,255,255,.08);border-radius:6px;padding:8px;"><div style="font-size:10px;opacity:.6;text-transform:uppercase;margin-bottom:4px;">${k}</div><div style="font-weight:700;">${val}</div></div>`).join('')}
    </div>`;
  const eligible=[],ineligible=[];
  const amountToFinance = v.price + fees - down - trade;
  Object.entries(lenders).forEach(([lid,l])=>{
    const r = {lid,l,atf:amountToFinance};
    const ltvPct = (amountToFinance/v.price)*100;
    const maxLoan = (v.price*l.maxLTV)/100;
    const ltvOk  = ltvPct<=l.maxLTV;
    const rates   = l.programs.map(p=>p.rate).join(' / ');
    r.ltvPct=ltvPct;r.maxLoan=maxLoan;r.ltvOk=ltvOk;r.rates=rates;r.maxLTV=l.maxLTV;
    if(l.hard){
      const yearOk = v.year>=l.minYear;
      const mileOk = l.maxMileage?v.mileage<=l.maxMileage:true;
      const cfxOk  = l.maxCarfax?v.carfax<=l.maxCarfax:true;
      r.type='hard';r.yearOk=yearOk;r.mileOk=mileOk;r.cfxOk=cfxOk;
      r.approved = yearOk&&mileOk&&cfxOk;
      (r.approved?eligible:ineligible).push(r);
    } else {
      r.type='credit';r.approved=null;
      eligible.push(r);
    }
  });
  eligible.sort((a,b)=>{if(a.type===b.type)return a.maxLTV-b.maxLTV;return a.type==='hard'?-1:1;});
  document.getElementById('compareSummaryBar').innerHTML = `
    <div class="sum-pill sum-green">✅ ${eligible.length} Eligible</div>
    <div class="sum-pill sum-red">⛔ ${ineligible.length} Ineligible</div>
    <div class="sum-pill sum-blue">💰 To Finance: ${$f(amountToFinance)}</div>`;
  document.getElementById('eligibleCount').textContent = eligible.length;
  document.getElementById('compareEligible').innerHTML = eligible.map(r=>buildLenderCard(r,v,false)).join('');
  const inelLabel = document.getElementById('ineligibleLabel');
  if(ineligible.length>0){
    inelLabel.style.display='flex';
    document.getElementById('ineligibleCount').textContent = ineligible.length;
    document.getElementById('compareIneligible').innerHTML = ineligible.map(r=>buildLenderCard(r,v,true)).join('');
  } else {
    inelLabel.style.display='none';
    document.getElementById('compareIneligible').innerHTML='';
  }
}

function buildLenderCard(r,v,isIneligible){
  const l = r.l;
  if(isIneligible){
    const reasons=[];
    if(!r.yearOk) reasons.push(`Year ${v.year} < Min ${l.minYear}`);
    if(!r.mileOk) reasons.push(`Mileage ${v.mileage.toLocaleString()} km > Max ${l.maxMileage.toLocaleString()} km`);
    if(!r.cfxOk)  reasons.push(`Carfax $${v.carfax.toLocaleString()} > Max $${l.maxCarfax.toLocaleString()}`);
    return `<div class="lender-card ineligible"><div class="lc-header ineligible"><span class="lc-name">${l.name}</span><span class="lc-check">✗</span></div>
      <div class="lc-body">${reasons.map(rs=>`<div class="fail-reason">⛔ ${rs}</div>`).join('')}
      <div class="lc-row" style="margin-top:8px;"><span class="lc-lbl">Rate Range</span><span class="lc-val">${r.rates}</span></div></div></div>`;
  }
  const isCredit = r.type==='credit';
  const barW = Math.min((r.ltvPct/r.maxLTV)*100,100);
  const barClass = r.ltvPct<=r.maxLTV*0.8?'ltv-ok':r.ltvPct<=r.maxLTV?'ltv-warn':'ltv-over';
  return `<div class="lender-card ${isCredit?'credit-based':''}">
    <div class="lc-header ${isCredit?'credit':'eligible'}"><span class="lc-name">${l.name}</span><span class="lc-check">${isCredit?'ℹ️':'✓'}</span></div>
    <div class="lc-body">
      ${isCredit?`<div style="font-size:11px;background:rgba(30,90,246,.15);color:var(--primary);padding:5px 10px;border-radius:5px;margin-bottom:8px;font-weight:700;">Credit Profile Decision</div>`:''}
      <div class="lc-row"><span class="lc-lbl">Rate Range</span><span class="lc-val blue">${r.rates}</span></div>
      <div class="lc-row"><span class="lc-lbl">Max LTV</span><span class="lc-val">${r.maxLTV}%</span></div>
      <div class="lc-row"><span class="lc-lbl">Max Loan</span><span class="lc-val green">${$f(r.maxLoan)}</span></div>
      <div class="lc-row"><span class="lc-lbl">Your LTV</span><span class="lc-val ${r.ltvOk?'green':'red'}">${r.ltvPct.toFixed(1)}% ${r.ltvOk?'✓':'⚠️'}</span></div>
      <div class="lc-row"><span class="lc-lbl">Amount to Finance</span><span class="lc-val">${$f(r.atf)}</span></div>
      <div class="ltv-bar-wrap"><div class="ltv-bar ${barClass}" style="width:${barW}%"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:10px;margin-top:3px;color:var(--muted);"><span>0%</span><span style="color:${r.ltvOk?'var(--green)':'var(--red)'};">${r.ltvPct.toFixed(1)}% / ${r.maxLTV}%</span><span>${r.maxLTV}%</span></div>
    </div></div>`;
}

// ── SAVE / LOAD ───────────────────────────────────────
function getVal(id){const e=document.getElementById(id);return e?e.value:'';}
function setVal(id,v){const e=document.getElementById(id);if(e&&v!=null)e.value=v;}
function getDealData(){
  return {
    ts:new Date().toISOString(),
    vehicle:{stock:getVal('stockNum'),desc:getVal('vehicleDesc'),vin:getVal('vin'),km:getVal('odometer'),condition:getVal('condition'),type:getVal('vehicleType')},
    financial:{price:getVal('sellingPrice'),finalDown:getVal('finalDown')||'0',doc:getVal('docFee'),tAllow:getVal('tradeAllow'),tPayoff:getVal('tradePayoff'),apr:getVal('apr'),gst:getVal('gstRate')},
    products:{vscPrice:getVal('vscPrice'),vscCost:getVal('vscCost'),gapPrice:getVal('gapPrice'),gapCost:getVal('gapCost'),twPrice:getVal('twPrice'),twCost:getVal('twCost'),waPrice:getVal('waPrice'),waCost:getVal('waCost')},
    customer:{name:getVal('custName'),phone:getVal('custPhone'),email:getVal('custEmail'),beacon:getVal('creditScore'),income:getVal('monthlyIncome')},
    costs:{acv:getVal('unitAcv'),recon:getVal('recon'),pack:getVal('lotPack')}
  };
}
function saveDeal(){
  const d = getDealData();
  localStorage.setItem('ffCurrentDeal',JSON.stringify(d));
  toast('💾 Deal saved!');
  return d;
}
function loadDeal(){
  const s = localStorage.getItem('ffCurrentDeal');
  if(!s){toast('❌ No saved deal');return;}
  const d = JSON.parse(s);
  const v = d.vehicle||{};const f = d.financial||{};const p = d.products||{};const c = d.customer||{};const co = d.costs||{};
  setVal('stockNum',v.stock);setVal('vehicleDesc',v.desc);setVal('vin',v.vin);setVal('odometer',v.km);setVal('condition',v.condition);setVal('vehicleType',v.type);
  setVal('sellingPrice',f.price);setVal('docFee',f.doc);setVal('tradeAllow',f.tAllow);setVal('tradePayoff',f.tPayoff);setVal('apr',f.apr);setVal('gstRate',f.gst);
  setVal('vscPrice',p.vscPrice);setVal('vscCost',p.vscCost);setVal('gapPrice',p.gapPrice);setVal('gapCost',p.gapCost);setVal('twPrice',p.twPrice);setVal('twCost',p.twCost);setVal('waPrice',p.waPrice);setVal('waCost',p.waCost);
  setVal('custName',c.name);setVal('custPhone',c.phone);setVal('custEmail',c.email);setVal('creditScore',c.beacon);setVal('monthlyIncome',c.income);
  setVal('unitAcv',co.acv);setVal('recon',co.recon);setVal('lotPack',co.pack);
  calculate();toast('📂 Deal loaded!');
}

// ── EMAIL ──────────────────────────────────────────────
function generateEmail(){
  const d = getDealData();const v=d.vehicle;const f=d.financial;const p=d.products;const c=d.customer;
  const person = getVal('salesName')||settings.salesName;
  const dealer = getVal('dealerName')||settings.dealerName;
  const price=parseFloat(f.price)||0,doc=parseFloat(f.doc)||0,tAllow=parseFloat(f.tAllow)||0,tPayoff=parseFloat(f.tPayoff)||0;
  const apr=parseFloat(f.apr)||6.99,gst=parseFloat(f.gst)||5;
  const netTrade=tAllow-tPayoff;
  const gstAmt=(price+doc-netTrade)*(gst/100);
  const otd=price+doc-netTrade+gstAmt;
  const vsc=parseFloat(p.vscPrice)||0,gap=parseFloat(p.gapPrice)||0,tw=parseFloat(p.twPrice)||0,wa=parseFloat(p.waPrice)||0;
  const mr=apr/100/12;
  const pmt72=$f(PMT(mr,72,-(otd+vsc+gap+tw+wa)));
  const pmt84=$f(PMT(mr,84,-(otd+vsc+gap+tw+wa)));
  const email = `Subject: Your ${v.desc} Quote — ${dealer}

Dear ${c.name||'Valued Customer'},

Thank you for your visit to ${dealer}! Here is a summary of your personalized vehicle quote:

VEHICLE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
${v.desc}${v.stock?' | Stock #'+v.stock:''}${v.km?' | '+parseInt(v.km).toLocaleString()+' km':''}

FINANCING SUMMARY
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Selling Price:        ${$f(price)}
Documentation Fee:    ${$f(doc)}
${netTrade!==0?`Trade Equity:         ${$f(netTrade)}\n`:''}GST (${gst}%):${' '.repeat(Math.max(1,14-String(gst).length))}${$f(gstAmt)}
Total Out-the-Door:   ${$f(otd)}

PROTECTION PACKAGE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
${vsc>0?`Vehicle Service Contract: ${$f(vsc)}\n`:''}${gap>0?`GAP Insurance:            ${$f(gap)}\n`:''}${tw>0?`Tire & Wheel Protection:  ${$f(tw)}\n`:''}${wa>0?`Wear Appearance:          ${$f(wa)}\n`:''}
ESTIMATED PAYMENTS @ ${apr}% APR
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
72 Month:   ${pmt72} / month
84 Month:   ${pmt84} / month

This quote is valid for 7 days. Ready to move forward? Reply to this email or call us directly.

Warmly,
${person}
${dealer}

─────────────────────────────────────
*Payments are estimates. Actual rate and terms subject to credit approval. GST included. Additional fees may apply.*`;
  document.getElementById('emailPreview').textContent = email;
}

function copyText(id){
  const txt = document.getElementById(id).textContent;
  navigator.clipboard.writeText(txt).then(()=>toast('📋 Copied!'));
}

// ── LENDER APPROVAL PARSER — DealerTrack Edition ──────────────────

// PDF file handlers
function handleApprovalDrop(e){
  e.preventDefault();
  e.currentTarget.style.borderColor = 'var(--border2)';
  e.currentTarget.style.background  = '';
  const file = e.dataTransfer.files[0];
  if(file && file.type === 'application/pdf') loadApprovalPDF(file);
  else toast('⚠️ Please drop a PDF file');
}
function handleApprovalFile(e){
  const file = e.target.files[0];
  if(file) loadApprovalPDF(file);
}

async function loadApprovalPDF(file){
  const nameEl = document.getElementById('pdfFileName');
  const textEl = document.getElementById('lenderText');
  if(nameEl) nameEl.textContent = '⏳ Reading ' + file.name + '...';
  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let fullText = '';
    for(let i = 1; i <= pdf.numPages; i++){
      const page    = await pdf.getPage(i);
      const content = await page.getTextContent();
      fullText += content.items.map(item => item.str).join(' ') + '\n';
    }
    textEl.value = fullText;
    if(nameEl) nameEl.textContent = '✅ ' + file.name + ' loaded — click Parse';
    toast('✅ PDF loaded — click Parse Document');
  } catch(e){
    if(nameEl) nameEl.textContent = '❌ Could not read PDF';
    toast('❌ PDF read error: ' + e.message);
    console.error('PDF parse error:', e);
  }
}

function parseLender(){
  const txt    = document.getElementById('lenderText').value;
  const resDiv = document.getElementById('lenderParseResults');
  if(!txt.trim()){
    resDiv.innerHTML = '<div class="warning-box">Drop a PDF or paste approval text first.</div>';
    return;
  }

  // ── DealerTrack-specific extraction ────────────────────────────
  const p = {};

  // Status — the most important field
  const statusM = txt.match(/this deal.{0,10}status is\s+([A-Z ]+?)(?:\s{2,}|Deal #|$)/i);
  if(statusM) p.status = statusM[1].trim();

  // Customer name
  const custM = txt.match(/Customer Name[:\s]+([A-Z][A-Z\s\-]+?)(?:Co-Applicant|Last Modified|\n|  )/i);
  if(custM) p.customerName = custM[1].trim();

  // Lender
  const lenderM = txt.match(/Lender[:\s]+([A-Za-z][A-Za-z\s&,]+?)(?:Lender Reference|Status|\n|  )/i)
                || txt.match(/Lender:\s*([A-Za-z][A-Za-z\s&,]+)/i);
  if(lenderM) p.lender = lenderM[1].replace(/Contract Type.*$/i,'').trim();

  // Lender reference
  const refM = txt.match(/Lender Reference #[:\s]+(\d+)/i);
  if(refM) p.lenderRef = refM[1];

  // Amount financed
  const amtM = txt.match(/Amount\s*Financed[:\s]*\$?([\d,]+\.?\d*)/i);
  if(amtM) p.amountFinanced = amtM[1].replace(/,/g,'');

  // Rate
  const rateM = txt.match(/Annual Interest Rate[:\s]*(\d+\.?\d*)/i)
              || txt.match(/rate as low as\s*(\d+\.?\d*)%/i)
              || txt.match(/(?:rate|apr)[:\s]*(\d+\.?\d*)%/i);
  if(rateM) p.rate = rateM[1];

  // Term
  const termM = txt.match(/Term of Borrowing[:\s]*(\d+)/i)
              || txt.match(/(?:term)[:\s]*(\d+)\s*(?:month|mo)/i);
  if(termM) p.term = termM[1];

  // Payment
  const pmtM = txt.match(/Installment Payment[:\s]*\$?([\d,]+\.?\d*)/i)
             || txt.match(/Max(?:imum)?\s*[Pp]ayment[:\s]*\$?([\d,]+)/i);
  if(pmtM) p.payment = pmtM[1].replace(/,/g,'');

  // Payment frequency
  const freqM = txt.match(/Payment Frequency[:\s]*(Bi-Weekly|Monthly|Weekly|Bi-weekly)/i);
  if(freqM) p.payFreq = freqM[1];

  // Down payment
  const downM = txt.match(/Down Payment[:\s]*\$?([\d,]+\.?\d*)/i);
  if(downM) p.downPayment = downM[1].replace(/,/g,'');

  // LTV
  const ltvM = txt.match(/(\d+)%\s*max\s*LTV/i) || txt.match(/LTV[:\s]*(\d+)%/i);
  if(ltvM) p.ltv = ltvM[1];

  // Tier
  const tierM = txt.match(/Tier\s*(\d+)/i);
  if(tierM) p.tier = tierM[1];

  // VIN
  const vinM = txt.match(/VIN#[:\s]*([A-HJ-NPR-Z0-9]{17})/i);
  if(vinM) p.vin = vinM[1];

  // Vehicle model
  const modelM = txt.match(/Model[:\s]*(20\d{2}[^\n]+?)(?:VIN|Odometer|  |\n)/i);
  if(modelM) p.vehicle = modelM[1].trim();

  // Key conditions — grab the deal-specific conditions block
  const condM = txt.match(/DEAL SPECIFIC CONDITIONS[^*]*(.*?)(?:\*{3,}\s*STANDARD|$)/is);
  if(condM) {
    const rawCond = condM[1].replace(/\d{4}-\d{2}-\d{2}.*?\n/g,'').trim();
    p.conditions = rawCond.substring(0, 400).trim();
  }

  // ── Render results ────────────────────────────────────────────
  const statusColor = {
    'APPROVED':             { bg:'rgba(16,185,129,.12)', border:'rgba(16,185,129,.3)', text:'var(--green)',  icon:'✅' },
    'CONDITIONAL APPROVAL': { bg:'rgba(245,158,11,.1)',  border:'rgba(245,158,11,.3)', text:'var(--amber)', icon:'⚠️' },
    'DECLINED':             { bg:'rgba(239,68,68,.1)',   border:'rgba(239,68,68,.3)',  text:'var(--red)',   icon:'❌' }
  };
  const sc = statusColor[p.status] || { bg:'rgba(30,90,246,.08)', border:'var(--border2)', text:'var(--primary)', icon:'🔍' };

  const row = (label, val, color='') =>
    val ? `<div class="cline"><span class="cl-label">${label}</span><span class="cl-value" ${color?`style="color:${color}"`:''}>${val}</span></div>` : '';

  let html = `<div style="background:${sc.bg};border:2px solid ${sc.border};border-radius:10px;padding:18px;">`;

  // Status banner
  html += `<div style="font-size:15px;font-weight:800;color:${sc.text};margin-bottom:14px;letter-spacing:.5px;">${sc.icon} ${p.status || 'PARSED'}</div>`;

  // Core fields
  if(p.lender)       html += row('Lender', p.lender);
  if(p.customerName) html += row('Customer', p.customerName);
  if(p.lenderRef)    html += row('Lender Ref #', p.lenderRef);
  if(p.vehicle)      html += row('Vehicle', p.vehicle);
  if(p.vin)          html += row('VIN', `<span style="font-family:monospace;">${p.vin}</span>`);

  html += `<div style="border-top:1px solid ${sc.border};margin:10px 0;"></div>`;

  if(p.amountFinanced) html += row('Amount Financed', `$${parseFloat(p.amountFinanced).toLocaleString('en-CA',{minimumFractionDigits:2})}`, 'var(--green)');
  if(p.rate)           html += row('Interest Rate', `${p.rate}%`, 'var(--amber)');
  if(p.term)           html += row('Term', `${p.term} months`);
  if(p.payment)        html += row('Approved Payment', `$${parseFloat(p.payment).toLocaleString()} / ${p.payFreq||'month'}`, 'var(--primary)');
  if(p.downPayment)    html += row('Down Payment', `$${parseFloat(p.downPayment).toLocaleString()}`);
  if(p.ltv)            html += row('Max LTV', `${p.ltv}%`);
  if(p.tier)           html += row('Tier', `Tier ${p.tier}`);

  // Conditions block
  if(p.conditions){
    html += `<div style="margin-top:12px;background:rgba(0,0,0,.15);border-radius:6px;padding:10px;">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:6px;">Deal Conditions</div>
      <div style="font-size:11px;color:var(--text);line-height:1.6;white-space:pre-wrap;">${escapeHtml(p.conditions)}</div>
    </div>`;
  }

  if(p.status !== 'DECLINED'){
    html += `<button class="btn btn-primary btn-full" style="margin-top:14px;" onclick='applyParsed(${JSON.stringify(p)})'>✅ Apply to Deal Desk</button>`;
  }

  html += `</div>`;
  resDiv.innerHTML = html;
  toast(p.status === 'APPROVED' ? '✅ Approved!' : p.status === 'DECLINED' ? '❌ Declined' : '⚠️ Conditional');
}

function applyParsed(p){
  if(p.rate)           setVal('apr', p.rate);
  if(p.term)           setVal('term', p.term);
  if(p.customerName)   setVal('custName', p.customerName);
  if(p.downPayment)    setVal('finalDown', p.downPayment);
  if(p.vin)            setVal('vin', p.vin);
  if(p.vehicle)        setVal('vehicleDesc', p.vehicle);
  calculate();
  closeModal('lenderParserModal');
  showSection('deal');
  document.querySelectorAll('.nav-btn').forEach(b => {
    b.classList.toggle('active', b.id === 'nav-deal' || b.getAttribute('onclick')?.includes("'deal'"));
  });
  toast('✅ Approval applied to Deal Desk!');
}

// ── SETTINGS ──────────────────────────────────────────
function saveSettings(){
  settings.salesName = getVal('setPerson')||settings.salesName;
  settings.dealerName= getVal('setDealer')||settings.dealerName;
  settings.docFee    = parseFloat(getVal('setDocFee'))||settings.docFee;
  settings.gst       = parseFloat(getVal('setGST'))||settings.gst;
  settings.apr       = parseFloat(getVal('setAPR'))||settings.apr;
  settings.target    = parseInt(getVal('setTarget'))||settings.target;
  localStorage.setItem('ffSettings',JSON.stringify(settings));
  setVal('docFee',settings.docFee);setVal('gstRate',settings.gst);setVal('apr',settings.apr);
  document.getElementById('targetInput').value=settings.target;
  closeModal('settingsModal');toast('⚙️ Settings saved!');
  calculate();
}

// ── CRM ───────────────────────────────────────────────
function addToCRM(){
  const d = getDealData();const c=d.customer;const v=d.vehicle;
  if(!c.name){toast('⚠️ Enter customer name first');return;}
  const customer={id:Date.now(),date:new Date().toLocaleDateString('en-CA'),name:c.name,phone:c.phone,email:c.email,vehicle:`${v.desc}`.trim()||'Not specified',stock:v.stock,beacon:c.beacon,status:'Lead'};
  crmData.unshift(customer);
  localStorage.setItem('ffCRM',JSON.stringify(crmData));
  toast('✅ Added to CRM!');
}
function promptAddCRM(){
  const name=prompt('Customer Name:');if(!name)return;
  const phone=prompt('Phone:')||'';const email=prompt('Email:')||'';
  crmData.unshift({id:Date.now(),date:new Date().toLocaleDateString('en-CA'),name,phone,email,vehicle:'Not specified',stock:'',beacon:'',status:'Lead'});
  localStorage.setItem('ffCRM',JSON.stringify(crmData));
  renderCRM();toast('✅ Customer added!');
}
function renderCRM(){
  const container=document.getElementById('crmContainer');
  if(!crmData.length){container.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);">No customers in CRM yet.</div>';return;}
  container.innerHTML=`<table class="data-table"><thead><tr><th>Date</th><th>Name</th><th>Phone</th><th>Email</th><th>Vehicle</th><th>Beacon</th><th>Status</th><th>Action</th></tr></thead><tbody>
  ${crmData.map(c=>`<tr>
    <td>${c.date}</td><td><strong>${c.name}</strong></td><td>${c.phone||'—'}</td><td>${c.email||'—'}</td>
    <td>${c.vehicle}${c.stock?' ('+c.stock+')':''}</td><td>${c.beacon||'—'}</td>
    <td><select class="crm-status" onchange="updateCRM(${c.id},this.value)" style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);padding:4px 8px;font-family:'Outfit',sans-serif;">
      ${['Lead','Contacted','Test Drive','Negotiating','Sold','Lost'].map(s=>`<option ${c.status===s?'selected':''}>${s}</option>`).join('')}
    </select></td>
    <td><button class="btn btn-danger btn-sm" onclick="deleteCRM(${c.id})">Del</button></td>
  </tr>`).join('')}
  </tbody></table>`;
}
function updateCRM(id,status){const c=crmData.find(x=>x.id===id);if(c){c.status=status;localStorage.setItem('ffCRM',JSON.stringify(crmData));}}
function deleteCRM(id){if(!confirm('Delete?'))return;crmData=crmData.filter(c=>c.id!==id);localStorage.setItem('ffCRM',JSON.stringify(crmData));renderCRM();}

// ── DEAL LOG ──────────────────────────────────────────
function logDeal(){
  const d=getDealData();
  const now=new Date();
  const p=d.products;
  const pvr=(parseFloat(p.vscPrice)||0)+(parseFloat(p.gapPrice)||0)+(parseFloat(p.twPrice)||0)+(parseFloat(p.waPrice)||0);
  d.loggedAt=now.toLocaleDateString('en-CA');d.loggedTime=now.toLocaleTimeString('en-CA');
  d.loggedMonth=now.getMonth();d.loggedYear=now.getFullYear();d.loggedDay=now.toDateString();
  d.id=Date.now();d.pvr=pvr;
  dealLog.unshift(d);
  localStorage.setItem('ffDealLog',JSON.stringify(dealLog));
  toast('📊 Deal logged!');
  refreshAllAnalytics();
  renderScenarios();
}
function renderDealLog(){
  const c=document.getElementById('dealLogContainer');
  if(!dealLog.length){c.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);">No deals logged yet. Use the LOG THIS DEAL button from the Deal Desk.</div>';return;}
  c.innerHTML=`<table class="data-table"><thead><tr><th>Date</th><th>Vehicle</th><th>Stock #</th><th>Products</th><th>PVR</th><th>Actions</th></tr></thead><tbody>
  ${dealLog.slice(0,100).map(d=>{
    const v=d.vehicle||{};const p=d.products||{};
    const prods=[];
    if(parseFloat(p.vscPrice||0)>0)prods.push('VSC');
    if(parseFloat(p.gapPrice||0)>0)prods.push('GAP');
    if(parseFloat(p.twPrice||0)>0)prods.push('T&W');
    if(parseFloat(p.waPrice||0)>0)prods.push('WA');
    return `<tr>
      <td>${d.loggedAt||'?'}<br><small style="color:var(--muted);">${d.loggedTime||''}</small></td>
      <td><strong>${v.desc||''}</strong></td>
      <td style="color:var(--amber);">${v.stock||'—'}</td>
      <td>${prods.join(', ')||'<span style="color:var(--muted);">None</span>'}</td>
      <td><strong style="color:var(--green);">$${(d.pvr||0).toLocaleString()}</strong></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteLog(${d.id})">Del</button></td>
    </tr>`;
  }).join('')}
  </tbody></table>`;
}
function deleteLog(id){if(!confirm('Delete?'))return;dealLog=dealLog.filter(d=>d.id!==id);localStorage.setItem('ffDealLog',JSON.stringify(dealLog));refreshAllAnalytics();}
function clearAllDeals(){if(!confirm('⚠️ Clear ALL '+dealLog.length+' logged deals?'))return;dealLog=[];localStorage.setItem('ffDealLog','[]');refreshAllAnalytics();toast('🗑️ Cleared');}

function refreshAllAnalytics(){
  renderDealLog();renderCRM();
  const now=new Date();const today=now.toDateString();const m=now.getMonth();const y=now.getFullYear();
  const sw=new Date(now);sw.setDate(now.getDate()-now.getDay());sw.setHours(0,0,0,0);
  let td=0,wk=0,mo=0,vscN=0,gapN=0,twN=0,waN=0,totPVR=0;
  dealLog.forEach(d=>{
    if(d.loggedDay===today)td++;
    if(new Date(d.ts)>=sw)wk++;
    if(d.loggedMonth===m&&d.loggedYear===y)mo++;
    const p=d.products||{};
    if(parseFloat(p.vscPrice||0)>0)vscN++;
    if(parseFloat(p.gapPrice||0)>0)gapN++;
    if(parseFloat(p.twPrice||0)>0)twN++;
    if(parseFloat(p.waPrice||0)>0)waN++;
    totPVR+=(d.pvr||0);
  });
  const tot=dealLog.length;
  ['statTotal','statMonth','statWeek','statToday'].forEach((id,i)=>document.getElementById(id).textContent=[tot,mo,wk,td][i]);
  const pct=n=>tot?((n/tot)*100).toFixed(1)+'%':'0%';
  document.getElementById('penVSC').textContent=pct(vscN);document.getElementById('penVSCn').textContent=`${vscN} of ${tot}`;
  document.getElementById('penGAP').textContent=pct(gapN);document.getElementById('penGAPn').textContent=`${gapN} of ${tot}`;
  document.getElementById('penTW').textContent=pct(twN);document.getElementById('penTWn').textContent=`${twN} of ${tot}`;
  document.getElementById('penWA').textContent=pct(waN);document.getElementById('penWAn').textContent=`${waN} of ${tot}`;
  document.getElementById('avgPVR').textContent=tot?$i(totPVR/tot):'$0';
  document.getElementById('totalBackend').textContent=$i(totPVR);
  updateTarget(mo);
}

function showAnalyticsTab(id,btn){
  document.querySelectorAll('#section-analytics .mgr-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('#section-analytics .mgr-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('atab-'+id).classList.add('active');
  if(btn)btn.classList.add('active');
}

function updateTarget(dealsThisMonth){
  const target=parseInt(document.getElementById('targetInput').value)||settings.target;
  const now=new Date();
  if(dealsThisMonth===undefined){
    const m=now.getMonth(),y=now.getFullYear();
    dealsThisMonth=dealLog.filter(d=>d.loggedMonth===m&&d.loggedYear===y).length;
  }
  const pct=target?((dealsThisMonth/target)*100).toFixed(1)+'%':'0%';
  const daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
  const dayOfMonth=now.getDate();
  const daysLeft=daysInMonth-dayOfMonth;
  const needed=Math.max(0,target-dealsThisMonth);
  const neededPD=daysLeft>0?(needed/daysLeft).toFixed(1):0;
  const expected=(dayOfMonth/daysInMonth)*target;
  let pace='—';
  if(dealsThisMonth>=target)pace='🎉 Hit!';
  else if(dealsThisMonth>=expected*1.1)pace='🚀 Ahead';
  else if(dealsThisMonth>=expected*0.9)pace='✅ On Track';
  else pace='⚠️ Behind';
  document.getElementById('tDeals').textContent=dealsThisMonth;
  document.getElementById('tTarget').textContent=target;
  document.getElementById('tPct').textContent=pct;
  document.getElementById('tPace').textContent=pace;
  document.getElementById('tDaysLeft').textContent=daysLeft;
  document.getElementById('tNeedPerDay').textContent=neededPD;
}

// ── CSV IMPORT ─────────────────────────────────────────
function importCSV(){
  const txt=document.getElementById('csvText').value.trim();
  if(!txt){toast('⚠️ Paste CSV content first');return;}
  const lines=txt.split('\n');
  if(lines.length<2){toast('⚠️ Need at least header + 1 data row');return;}
  const headers=lines[0].split(',').map(h=>h.trim().toLowerCase());
  const idx=k=>headers.indexOf(k);
  const imported=[];
  for(let i=1;i<lines.length;i++){
    if(!lines[i].trim())continue;
    const cols=lines[i].split(',').map(c=>c.trim());
    imported.push({
      stock:cols[idx('stock')]||'',year:parseInt(cols[idx('year')])||0,make:cols[idx('make')]||'',
      model:cols[idx('model')]||'',mileage:parseInt(cols[idx('mileage')])||0,price:parseFloat(cols[idx('price')])||0,
      condition:cols[idx('condition')]||'Average',carfax:parseFloat(cols[idx('carfax')])||0,type:cols[idx('type')]||''
    });
  }
  if(!imported.length){toast('❌ No valid rows found');return;}
  inventory.length=0;imported.forEach(v=>inventory.push(v));
  initInventory(); // Re-runs the dropdown population
  // Sync imported inventory to cloud
  if(window.FF && FF.isLoggedIn) FF.apiFetch('/api/desk/inventory/bulk',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({vehicles:imported})}).catch(()=>{});
  closeModal('csvImportModal');toast(`✅ Imported ${imported.length} vehicles!`);
}

// ── EXPORT ────────────────────────────────────────────
function exportJSON(type){
  const data=type==='deals'?dealLog:crmData;
  const name=`firstfin-${type}-${new Date().toISOString().split('T')[0]}.json`;
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();
  URL.revokeObjectURL(a.href);toast('💾 Exported!');
}

// ── MODALS ────────────────────────────────────────────
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function closeModalOutside(e,id){if(e.target===document.getElementById(id))closeModal(id);}

// ── DARK / LIGHT MODE ─────────────────────────────────
function toggleDarkMode(){
  const isLight = document.body.classList.toggle('light-mode');
  const btn = document.getElementById('darkModeBtn');
  btn.textContent = isLight ? '🌙 Dark Mode' : '☀️ Light Mode';
  localStorage.setItem('ffTheme', isLight ? 'light' : 'dark');
  toast(isLight ? '☀️ Switched to Light Mode' : '🌙 Switched to Dark Mode');
}

// ── TOAST ─────────────────────────────────────────────
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

// ── KEYBOARD SHORTCUTS ────────────────────────────────
document.addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey)){
    if(e.key==='s'){e.preventDefault();saveDeal();}
    if(e.key==='l'){e.preventDefault();loadDeal();}
    if(e.key==='p'){e.preventDefault();window.print();}
  }
});


// ═══════════════════════════════════════════════════════════════════
// SARAH AI — ALL DASHBOARD FUNCTIONS (same-origin, no config needed)
// ═══════════════════════════════════════════════════════════════════

// ── Session admin token (prompted once, remembered in-session) ────
let _adminToken = null;
function getAdminToken(){
  if(_adminToken) return _adminToken;
  const t = prompt('🔒 Admin Token Required\nEnter your ADMIN_TOKEN:','');
  if(!t||!t.trim()){ toast('❌ Cancelled'); return null; }
  _adminToken = t.trim(); return _adminToken;
}
function clearAdminToken(){ _adminToken = null; }

async function adminFetch(url, options={}){
  const token = getAdminToken();
  if(!token) return null;
  const sep = url.includes('?')?'&':'?';
  const res = await fetch(url + sep + 'token=' + encodeURIComponent(token), options);
  if(res.status===403){ clearAdminToken(); toast('❌ Wrong token'); return null; }
  return await res.json();
}

// ── Tab switcher ──────────────────────────────────────────────────
function showSarahTab(id, btn){
  document.querySelectorAll('#section-sarah .mgr-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('#section-sarah .mgr-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('stab-'+id).classList.add('active');
  if(btn) btn.classList.add('active');
}

// ── Load all dashboard data ───────────────────────────────────────
let allConversations = [];

async function loadSarahDashboard(){
  try {
    // Stats
    const stats = await fetch('/api/dashboard').then(r=>r.json());
    document.getElementById('ss-customers').textContent     = stats.stats.totalCustomers;
    document.getElementById('ss-conversations').textContent = stats.stats.totalConversations;
    document.getElementById('ss-messages').textContent      = stats.stats.totalMessages;
    document.getElementById('ss-appointments').textContent  = stats.stats.totalAppointments;
    document.getElementById('ss-callbacks').textContent     = stats.stats.totalCallbacks;

    // Analytics
    try {
      const an = await fetch('/api/analytics').then(r=>r.json());
      if(!an.error){
        document.getElementById('sa-convRate').textContent   = an.conversionRate + '%';
        document.getElementById('sa-convDetail').textContent = an.totalConverted + ' of ' + an.totalConversations + ' convs';
        document.getElementById('sa-respRate').textContent   = an.responseRate + '%';
        document.getElementById('sa-respDetail').textContent = an.totalResponded + ' customers replied';
        document.getElementById('sa-avgMsg').textContent     = an.avgMessages;
        document.getElementById('sa-weekConv').textContent   = an.weekConversations;
        document.getElementById('sa-weekDetail').textContent = an.weekConverted + ' converted this week';

        const topV = an.topVehicles.length
          ? an.topVehicles.map((v,i)=>`<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);"><span>${i+1}. ${v.vehicle_type||'Unknown'}</span><span style="color:var(--primary);font-weight:700;">${v.count}</span></div>`).join('')
          : '<div style="padding:8px;color:var(--muted);">No data yet</div>';
        document.getElementById('sa-topVehicles').innerHTML = topV;

        const bdist = an.budgetDist.length
          ? an.budgetDist.map(b=>`<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);"><span>${b.budget}</span><span style="color:var(--green);font-weight:700;">${b.count}</span></div>`).join('')
          : '<div style="padding:8px;color:var(--muted);">No data yet</div>';
        document.getElementById('sa-budgetDist').innerHTML = bdist;
      }
    } catch(e){ console.warn('Analytics load error', e); }

    // Conversations
    allConversations = await fetch('/api/conversations').then(r=>r.json());
    renderConversations(allConversations);

    // Appointments
    renderAppointments(stats.recentAppointments || []);

    // Callbacks
    renderCallbacks(stats.recentCallbacks || []);

    toast('✅ Sarah data refreshed');
  } catch(e){
    console.error('Sarah load error:', e);
    toast('❌ Could not load Sarah data: ' + e.message);
  }
}

// ── Conversations ─────────────────────────────────────────────────
function filterConversations(){
  const q      = (document.getElementById('convSearch')?.value||'').toLowerCase();
  const status = document.getElementById('convStatusFilter')?.value||'all';
  const filtered = allConversations.filter(c=>{
    if(status!=='all' && c.status !== status) return false;
    if(q){
      const hay = [(c.customer_phone||''),(c.customer_name||'')].join(' ').toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
  renderConversations(filtered);
}

function renderConversations(convs){
  const el = document.getElementById('conversationList');
  if(!el) return;
  if(!convs.length){ el.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);">No conversations found.</div>'; return; }
  el.innerHTML = convs.map(c=>{
    const cleanPhone = (c.customer_phone||'').replace(/[^0-9]/g,'');
    const statusBadge = `<span class="conv-badge badge-${c.status||'active'}">${c.status||'active'}</span>`;
    const vehicle = c.vehicle_type ? `🚗 ${c.vehicle_type}` : '';
    const budget  = c.budget       ? ` · 💰 ${c.budget}`    : '';
    const msgs    = c.message_count? ` · 💬 ${c.message_count} msgs` : '';
    // Show voice activity indicator if last message was a call/voicemail
    const lastMsg = c.last_message || '';
    const hasVoice = lastMsg.startsWith('📞')||lastMsg.startsWith('📬')||lastMsg.startsWith('📵');
    const voiceTag = hasVoice ? ` · ${lastMsg.split('|')[0].trim()}` : '';
    return `<div class="conv-item" id="convitem-${cleanPhone}">
      <div class="conv-header" onclick="toggleConversation('${c.customer_phone}','${cleanPhone}')">
        <div class="conv-avatar">👤</div>
        <div class="conv-info">
          <div class="conv-name">${c.customer_name||'Unknown'} ${statusBadge}</div>
          <div class="conv-phone">${c.customer_phone||''}</div>
          <div class="conv-meta">${vehicle}${budget}${msgs}${voiceTag} · Stage: ${c.stage||'—'}</div>
        </div>
        <div class="conv-right">
          <span class="conv-time">${c.updated_at?new Date(c.updated_at).toLocaleDateString():''}</span>
          <div style="display:flex;gap:6px;">
            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();loadConvToDeskCRM('${c.customer_phone}','${c.customer_name||''}','${c.vehicle_type||''}')">→ Desk</button>
            <button class="btn btn-ghost btn-sm" style="color:var(--red);border-color:rgba(239,68,68,.3);" onclick="event.stopPropagation();deleteConversation('${c.customer_phone}')">✕</button>
          </div>
        </div>
      </div>
      <div class="conv-thread" id="thread-${cleanPhone}"></div>
    </div>`;
  }).join('');
}

async function toggleConversation(phone, cleanPhone){
  const thread = document.getElementById('thread-'+cleanPhone);
  if(!thread) return;
  if(thread.classList.contains('open')){ thread.classList.remove('open'); return; }
  thread.innerHTML = '<div style="padding:10px;color:var(--muted);font-size:12px;">Loading...</div>';
  thread.classList.add('open');
  try {
    const data = await fetch('/api/conversation/'+encodeURIComponent(phone)).then(r=>r.json());
    if(data.error||!data.messages?.length){ thread.innerHTML='<div style="padding:10px;color:var(--muted);font-size:12px;">No messages yet.</div>'; return; }
    const inputId = 'ri-'+cleanPhone, btnId = 'rb-'+cleanPhone;
    thread.innerHTML = data.messages.map(m=>`
      <div class="msg-bubble ${m.role}">
        <div class="msg-role">${m.role==='user'?'👤 Customer':'🤖 Sarah AI'}</div>
        <div style="color:var(--text);line-height:1.5;white-space:pre-wrap;">${escapeHtml(m.content)}</div>
        <div class="msg-time">${new Date(m.created_at).toLocaleString()}</div>
      </div>`).join('') +
      `<div class="reply-bar">
        <input type="text" class="reply-input-field" id="${inputId}" placeholder="Reply to this customer..." onkeypress="if(event.key==='Enter'){event.preventDefault();sendThreadReply('${phone}','${inputId}','${btnId}');}">
        <button class="btn btn-primary" id="${btnId}" onclick="sendThreadReply('${phone}','${inputId}','${btnId}')">Send</button>
      </div>`;
    thread.scrollTop = thread.scrollHeight;
  } catch(e){ thread.innerHTML='<div style="padding:10px;color:var(--red);font-size:12px;">Error loading messages</div>'; }
}

async function sendThreadReply(phone, inputId, btnId){
  const input = document.getElementById(inputId);
  const btn   = document.getElementById(btnId);
  const msg   = input?.value?.trim();
  if(!msg) return;
  btn.disabled=true; btn.textContent='...';
  try {
    const token = getAdminToken(); if(!token){ btn.disabled=false;btn.textContent='Send';return; }
    const res = await fetch('/api/manual-reply',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({phone,message:msg,token})
    }).then(r=>r.json());
    if(res.success){ input.value=''; toast('✅ Reply sent!'); }
    else toast('❌ '+res.error);
  } catch(e){ toast('❌ '+e.message); }
  btn.disabled=false; btn.textContent='Send';
}

async function deleteConversation(phone){
  if(!confirm('Delete this entire conversation? This cannot be undone.')) return;
  try {
    const res = await fetch('/api/conversation/'+encodeURIComponent(phone),{method:'DELETE'}).then(r=>r.json());
    if(res.success){ toast('✅ Conversation deleted'); loadSarahDashboard(); }
    else toast('❌ '+res.error);
  } catch(e){ toast('❌ '+e.message); }
}

function loadConvToDeskCRM(phone, name, vehicle){
  setVal('custName', name||'');
  setVal('custPhone', phone.replace('+1',''));
  if(vehicle) setVal('vehicleDesc', vehicle);
  showSection('deal');
  toast('✅ '+( name||phone)+' loaded into Deal Desk!');
}

// ── Appointments ──────────────────────────────────────────────────
function renderAppointments(apts){
  const el = document.getElementById('appointmentsList');
  if(!el) return;
  if(!apts.length){ el.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);">No appointments yet.</div>'; return; }
  el.innerHTML = apts.map(a=>`
    <div class="appt-card">
      <div class="appt-top" onclick="document.getElementById('aptd-${a.id}').classList.toggle('open')">
        <div>
          <div class="appt-name">🗓️ ${escapeHtml(a.customer_name||'Unknown')} — ${escapeHtml(a.datetime||'TBD')}</div>
          <div class="appt-vehicle">🚗 ${escapeHtml(a.vehicle_type||'—')} · ${a.customer_phone}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();loadConvToDeskCRM('${a.customer_phone}','${escapeHtml(a.customer_name||'')}','${escapeHtml(a.vehicle_type||'')}')">→ Desk</button>
          <button class="btn btn-ghost btn-sm" style="color:var(--red);border-color:rgba(239,68,68,.3);" onclick="event.stopPropagation();deleteAppointment(${a.id})">✕</button>
        </div>
      </div>
      <div class="appt-detail" id="aptd-${a.id}">
        <span class="detail-label">Name:</span> <span class="detail-val">${escapeHtml(a.customer_name||'—')}</span> &nbsp;·&nbsp;
        <span class="detail-label">Phone:</span> <span class="detail-val">${a.customer_phone}</span><br>
        <span class="detail-label">Vehicle:</span> <span class="detail-val">${escapeHtml(a.vehicle_type||'—')}</span> &nbsp;·&nbsp;
        <span class="detail-label">Budget:</span> <span class="detail-val">${escapeHtml(a.budget||'—')}${a.budget_amount?' ($'+parseInt(a.budget_amount).toLocaleString()+')':''}</span><br>
        <span class="detail-label">Date/Time:</span> <span class="detail-val">${escapeHtml(a.datetime||'—')}</span><br>
        <span class="detail-label">Booked:</span> <span class="detail-val">${new Date(a.created_at).toLocaleString()}</span>
      </div>
    </div>`).join('');
}

async function deleteAppointment(id){
  if(!confirm('Delete this appointment?')) return;
  const res = await fetch('/api/appointment/'+id,{method:'DELETE'}).then(r=>r.json());
  if(res.success){ toast('✅ Deleted'); loadSarahDashboard(); }
  else toast('❌ '+res.error);
}

// ── Callbacks ─────────────────────────────────────────────────────
function renderCallbacks(cbs){
  const el = document.getElementById('callbacksList');
  if(!el) return;
  if(!cbs.length){ el.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);">No callback requests yet.</div>'; return; }
  el.innerHTML = cbs.map(c=>`
    <div class="appt-card" style="border-left:3px solid var(--amber);">
      <div class="appt-top" onclick="document.getElementById('cbd-${c.id}').classList.toggle('open')">
        <div>
          <div class="appt-name">📞 ${escapeHtml(c.customer_name||'Unknown')} — ${escapeHtml(c.datetime||'Anytime')}</div>
          <div class="appt-vehicle" style="color:var(--amber);">🚗 ${escapeHtml(c.vehicle_type||'—')} · ${c.customer_phone}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();loadConvToDeskCRM('${c.customer_phone}','${escapeHtml(c.customer_name||'')}','${escapeHtml(c.vehicle_type||'')}')">→ Desk</button>
          <button class="btn btn-ghost btn-sm" style="color:var(--red);border-color:rgba(239,68,68,.3);" onclick="event.stopPropagation();deleteCallback(${c.id})">✕</button>
        </div>
      </div>
      <div class="appt-detail" id="cbd-${c.id}">
        <span class="detail-label">Name:</span> <span class="detail-val">${escapeHtml(c.customer_name||'—')}</span> &nbsp;·&nbsp;
        <span class="detail-label">Phone:</span> <span class="detail-val">${c.customer_phone}</span><br>
        <span class="detail-label">Vehicle:</span> <span class="detail-val">${escapeHtml(c.vehicle_type||'—')}</span> &nbsp;·&nbsp;
        <span class="detail-label">Budget:</span> <span class="detail-val">${escapeHtml(c.budget||'—')}</span><br>
        <span class="detail-label">Preferred Time:</span> <span class="detail-val">${escapeHtml(c.datetime||'—')}</span>
      </div>
    </div>`).join('');
}

async function deleteCallback(id){
  if(!confirm('Delete this callback request?')) return;
  const res = await fetch('/api/callback/'+id,{method:'DELETE'}).then(r=>r.json());
  if(res.success){ toast('✅ Deleted'); loadSarahDashboard(); }
  else toast('❌ '+res.error);
}

// ── Launch SMS ────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded',()=>{
  const lm = document.getElementById('launchMessage');
  if(lm) lm.addEventListener('input',()=>{ const cc=document.getElementById('launchCharCount'); if(cc) cc.textContent=lm.value.length+' characters'; });
});

function formatPhoneInput(el){
  let d = el.value.replace(/[^0-9]/g,'');
  if(d.startsWith('1')) d=d.slice(1);
  d = d.slice(0,10);
  let out='';
  if(d.length>0) out='('+d.slice(0,3);
  if(d.length>=4) out+=') '+d.slice(3,6);
  if(d.length>=7) out+='-'+d.slice(6,10);
  el.value=out;
}

function phoneInputToE164(input){
  const d = input.replace(/[^0-9]/g,'');
  if(d.length===10) return '+1'+d;
  if(d.length===11&&d.startsWith('1')) return '+'+d;
  return null;
}

async function sendLaunchSMS(){
  const phone = phoneInputToE164(document.getElementById('launchPhone')?.value||'');
  const msg   = document.getElementById('launchMessage')?.value?.trim();
  const btn   = document.getElementById('launchSendBtn');
  const res   = document.getElementById('launchResult');
  if(!phone){ toast('⚠️ Invalid phone number'); return; }
  if(!msg){ toast('⚠️ Enter a message'); return; }
  btn.disabled=true; btn.textContent='⏳ Sending...';
  res.style.display='none';
  try {
    const data = await fetch('/api/start-sms',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({phone,message:msg})
    }).then(r=>r.json());
    if(data.success){
      res.style.cssText='display:block;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:6px;padding:10px;font-size:12px;color:var(--green);';
      res.textContent='✅ SMS sent to '+phone;
      document.getElementById('launchPhone').value='';
    } else throw new Error(data.error||'Failed');
  } catch(e){
    res.style.cssText='display:block;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:6px;padding:10px;font-size:12px;color:var(--red);';
    res.textContent='❌ '+e.message;
  }
  btn.disabled=false; btn.textContent='🚀 Send Message';
}

async function sendManualReplyForm(){
  const phone = phoneInputToE164(document.getElementById('replyPhone')?.value||'');
  const msg   = document.getElementById('replyMessage')?.value?.trim();
  const res   = document.getElementById('replyResult');
  if(!phone){ toast('⚠️ Invalid phone number'); return; }
  if(!msg){ toast('⚠️ Enter a message'); return; }
  const token = getAdminToken(); if(!token) return;
  try {
    const data = await fetch('/api/manual-reply',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({phone,message:msg,token})
    }).then(r=>r.json());
    if(data.success){
      res.style.cssText='display:block;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:6px;padding:10px;font-size:12px;color:var(--green);';
      res.textContent='✅ Reply sent to '+phone;
      document.getElementById('replyMessage').value='';
    } else throw new Error(data.error||'Failed');
  } catch(e){
    res.style.cssText='display:block;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:6px;padding:10px;font-size:12px;color:var(--red);';
    res.textContent='❌ '+e.message;
  }
}

// ── Bulk SMS ──────────────────────────────────────────────────────
let parsedContacts = [];

function handleDragOver(e){ e.preventDefault(); document.getElementById('bulkDropZone').classList.add('drag-over'); }
function handleDragLeave(){ document.getElementById('bulkDropZone').classList.remove('drag-over'); }
function handleFileDrop(e){
  e.preventDefault();
  handleDragLeave();
  const file = e.dataTransfer.files[0];
  if(file) parseCSVFile(file);
}
function handleFileSelect(e){ const file = e.target.files[0]; if(file) parseCSVFile(file); }

function parseCSVFile(file){
  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.split('\n');
    const contacts=[], errors=[], seen=new Set();
    const BLACKLIST=['2899688778','12899688778'];
    let start=0;
    if(lines[0]&&lines[0].toLowerCase().includes('name')) start=1;
    for(let i=start;i<lines.length;i++){
      const line=lines[i].trim(); if(!line) continue;
      const parts=line.split(',');
      if(parts.length<2){ errors.push('Row '+(i+1)+': Missing data'); continue; }
      const name=parts[0].trim().replace(/"/g,'');
      const raw=parts[1].trim().replace(/"/g,'');
      const d=raw.replace(/[^0-9]/g,'');
      let phone=d;
      if(d.length===10) phone='+1'+d;
      else if(d.length===11&&d.startsWith('1')) phone='+'+d;
      if(!phone.startsWith('+1')||phone.length!==12){ errors.push('Row '+(i+1)+': Invalid phone'); continue; }
      if(BLACKLIST.some(b=>phone.includes(b))){ errors.push('Row '+(i+1)+': Blacklisted'); continue; }
      if(seen.has(phone)){ errors.push('Row '+(i+1)+': Duplicate'); continue; }
      seen.add(phone); contacts.push({name,phone});
    }
    if(!contacts.length){ toast('⚠️ No valid contacts in file'); return; }
    parsedContacts=contacts;
    const preview=document.getElementById('contactPreview');
    const countEl=document.getElementById('contactCountDisplay');
    const listEl=document.getElementById('contactList');
    const errEl=document.getElementById('csvErrors');
    if(countEl) countEl.textContent='✅ '+contacts.length+' valid contacts loaded';
    if(listEl) listEl.innerHTML=contacts.slice(0,8).map(c=>'<div style="padding:2px 0;font-size:11px;">✓ '+escapeHtml(c.name)+' — '+c.phone+'</div>').join('')+(contacts.length>8?'<div style="font-size:11px;color:var(--muted);">...and '+(contacts.length-8)+' more</div>':'');
    if(errEl) errEl.innerHTML=errors.length?'<div style="font-size:11px;color:var(--amber);margin-top:6px;">⚠️ '+errors.length+' skipped</div>':'';
    if(preview) preview.style.display='block';
    document.getElementById('campaignForm').style.display='block';
    toast('✅ '+contacts.length+' contacts ready');
  };
  reader.readAsText(file);
}

async function launchBulkCampaign(){
  const name = document.getElementById('campaignName')?.value?.trim();
  const tmpl = document.getElementById('messageTemplate')?.value?.trim();
  if(!name){ toast('⚠️ Enter a campaign name'); return; }
  if(!tmpl){ toast('⚠️ Enter a message template'); return; }
  if(!tmpl.includes('{name}')){ toast('⚠️ Template must include {name}'); return; }
  if(!parsedContacts.length){ toast('⚠️ Upload a CSV first'); return; }
  if(!confirm('Launch "'+name+'" to '+parsedContacts.length+' contacts?')) return;
  try {
    const res = await fetch('/api/bulk-sms/create-campaign',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({campaignName:name,messageTemplate:tmpl,contacts:parsedContacts})
    }).then(r=>r.json());
    if(res.success){
      document.getElementById('campaignForm').style.display='none';
      document.getElementById('progressTracker').style.display='block';
      toast('✅ Launched! '+res.messageCount+' messages (~'+res.estimatedTime+' min)');
      trackBulkProgress(name);
    } else toast('❌ '+res.error);
  } catch(e){ toast('❌ '+e.message); }
}

let _progressTimer=null;
function trackBulkProgress(name){
  updateBulkProgress(name);
  if(_progressTimer) clearInterval(_progressTimer);
  _progressTimer=setInterval(()=>updateBulkProgress(name),3000);
}

async function updateBulkProgress(name){
  try {
    const s = await fetch('/api/bulk-sms/campaign/'+encodeURIComponent(name)).then(r=>r.json());
    document.getElementById('sentCount').textContent    = s.sent;
    document.getElementById('pendingCount').textContent = s.pending;
    document.getElementById('failedCount').textContent  = s.failed;
    const pct = s.total>0?Math.round((parseInt(s.sent)/parseInt(s.total))*100):0;
    document.getElementById('progressBar').style.width  = pct+'%';
    const done = parseInt(s.pending)===0;
    document.getElementById('progressText').textContent = done?'✅ Complete! '+s.sent+' sent':'Sending... ('+s.sent+'/'+s.total+')';
    if(done&&_progressTimer){ clearInterval(_progressTimer); _progressTimer=null; }
  } catch(e){ console.error('Progress error',e); }
}

async function checkBulkStatus(){
  try {
    const d = await fetch('/api/bulk-status').then(r=>r.json());
    const display=document.getElementById('bulkStatusDisplay');
    const running = d.processorRunning;
    const paused  = d.paused;
    let html = '<div style="font-size:13px;font-weight:700;margin-bottom:10px;">Processor: ';
    html += running?(paused?'<span style="color:var(--amber);">⏸️ PAUSED</span>':'<span style="color:var(--green);">🟢 RUNNING</span>'):'<span style="color:var(--red);">🔴 STOPPED</span>';
    html += '</div>';
    if(d.stats?.length){
      d.stats.forEach(s=>{
        const em = s.status==='sent'?'✅':s.status==='failed'?'❌':s.status==='cancelled'?'🚫':'⏳';
        html+=`<div style="font-size:12px;padding:4px 0;">${em} <strong>${s.status.toUpperCase()}</strong>: ${s.count}</div>`;
      });
    } else { html+='<div style="font-size:12px;color:var(--green);">✓ Queue empty</div>'; }
    display.innerHTML=html; display.style.display='block';
  } catch(e){ toast('❌ '+e.message); }
}

async function pauseBulkSMS(){
  const d=await adminFetch('/api/bulk-sms/pause'); if(!d) return;
  if(d.success){ toast('⏸️ Bulk SMS paused'); checkBulkStatus(); } else toast('❌ '+d.error);
}
async function resumeBulkSMS(){
  const d=await adminFetch('/api/bulk-sms/resume'); if(!d) return;
  if(d.success){ toast('▶️ Bulk SMS resumed'); checkBulkStatus(); } else toast('❌ '+d.error);
}
async function emergencyStopBulk(){
  if(!confirm('🚨 EMERGENCY STOP — Cancel ALL pending messages?')) return;
  const d=await adminFetch('/api/emergency-stop-bulk'); if(!d) return;
  if(d.success){ toast('🚨 Emergency stop! '+d.cancelled+' messages cancelled'); checkBulkStatus(); }
}
async function wipeBulkMessages(){
  if(!confirm('⚠️ Wipe ALL bulk messages from queue? This cannot be undone.')) return;
  const d=await adminFetch('/api/wipe-bulk'); if(!d) return;
  if(d.success){ toast('🗑️ Queue wiped ('+d.wiped+' messages)'); checkBulkStatus(); }
}

// ── Voice (uses Sarah's new voice API routes) ─────────────────────
async function sendVoiceDrop(){
  const phone        = phoneInputToE164(document.getElementById('vd_phone')?.value||'');
  const customerName = document.getElementById('vd_name')?.value||'there';
  const message      = document.getElementById('vd_message')?.value||'';
  const res          = document.getElementById('voiceDropResult');
  if(!phone){ toast('⚠️ Invalid phone'); return; }
  const token=getAdminToken(); if(!token) return;
  try {
    const d = await fetch('/api/voice/drop-v2',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({phone,customerName,message,token})
    }).then(r=>r.json());
    if(d.success){
      res.style.cssText='display:block;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:6px;padding:10px;font-size:12px;color:var(--green);';
      res.textContent='✅ Drop sent! Natural pacing active. Call SID: '+d.callSid;
    } else throw new Error(d.error||'Failed');
  } catch(e){
    res.style.cssText='display:block;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:6px;padding:10px;font-size:12px;color:var(--red);';
    res.textContent='❌ '+e.message;
  }
}

function updateVCCount(){
  const s=(document.getElementById('vc_status')||{}).value||'Lead';
  const count=crmData.filter(c=>c.phone&&(s==='all'||c.status===s)).length;
  const el=document.getElementById('vcTargetCount');
  if(el) el.textContent=count+' CRM contacts will receive this call';
}

async function sendVoiceCampaign(){
  const message = document.getElementById('vc_message')?.value;
  const status  = (document.getElementById('vc_status')||{}).value||'Lead';
  const contacts= crmData.filter(c=>c.phone&&(status==='all'||c.status===status)).map(c=>({name:c.name||'there',phone:c.phone}));
  if(!contacts.length){ toast('⚠️ No CRM contacts match that filter'); return; }
  if(!message){ toast('⚠️ Enter a message script'); return; }
  if(!confirm('Send voice drops to '+contacts.length+' contacts?')) return;
  const token=getAdminToken(); if(!token) return;
  try {
    const d = await fetch('/api/voice/campaign',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contacts,message,delaySeconds:10,token})
    }).then(r=>r.json());
    if(d.success) toast('📞 Voice campaign launched — '+d.scheduled+' calls queued!');
    else toast('❌ '+d.error);
  } catch(e){ toast('❌ '+e.message); }
}

// ── Exports ───────────────────────────────────────────────────────
function exportData(type){
  const token=getAdminToken(); if(!token) return;
  const a=document.createElement('a');
  a.href='/api/export/'+type+'?token='+encodeURIComponent(token);
  a.download=type+'_'+new Date().toISOString().split('T')[0]+'.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

// ── Deal funded → follow-up SMS  (called from logDeal) ────────────
async function sendDealFundedFollowup(phone, customerName, vehicleDesc){
  if(!phone) return;
  const token=getAdminToken(); if(!token) return;
  try {
    await fetch('/api/deal-funded',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({phone,customerName,vehicleDesc,token,dealership:settings.dealerName||'First Financial'})
    });
    console.log('✅ Deal follow-up SMS triggered for',phone);
  } catch(e){ console.warn('Follow-up SMS failed (non-critical):', e.message); }
}

// ── HTML escape helper ────────────────────────────────────────────
function escapeHtml(str){
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Auto-refresh Sarah every 30 seconds when on Sarah tab
setInterval(()=>{
  if(document.getElementById('section-sarah')?.classList.contains('active')){
    loadSarahDashboard();
  }
}, 30000);



// ── Unified timeline message renderer ────────────────────────────
function renderTimelineMessage(m) {
  const content = m.content || '';
  const time    = m.created_at ? new Date(m.created_at).toLocaleString() : '';

  // ── Voice events — special pills ─────────────────────────────
  if (content.startsWith('📞') || content.startsWith('📬') || content.startsWith('📵')) {
    let icon = '📞', label = '', color = 'var(--primary)', bg = 'rgba(30,90,246,.08)', border = 'rgba(30,90,246,.2)';

    if (content.includes('VOICEMAIL')) {
      icon = '📬'; color = 'var(--amber)'; bg = 'rgba(245,158,11,.08)'; border = 'rgba(245,158,11,.2)';
      // Extract transcript if present
      const txMatch = content.match(/transcript:\s*"(.+)"$/s);
      const durMatch = content.match(/duration:(\d+s)/);
      label = (durMatch ? durMatch[1] + ' voicemail' : 'Voicemail');
      const tx = txMatch ? txMatch[1] : null;
      return `<div style="display:flex;justify-content:center;margin:8px 0;">
        <div style="background:${bg};border:1px solid ${border};border-radius:8px;padding:8px 14px;max-width:90%;text-align:center;">
          <div style="font-size:11px;font-weight:700;color:${color};">${icon} ${label}</div>
          ${tx ? `<div style="font-size:11px;color:var(--text);margin-top:4px;font-style:italic;">"${escapeHtml(tx.substring(0,120))}${tx.length>120?'...':''}"</div>` : ''}
          <div style="font-size:10px;color:var(--muted);margin-top:3px;">${time}</div>
        </div>
      </div>`;
    }

    if (content.includes('VOICE_DROP')) {
      icon = '📵'; color = '#8b5cf6'; bg = 'rgba(139,92,246,.08)'; border = 'rgba(139,92,246,.2)';
      label = content.includes('CALLBACK') ? 'Called back — connected' : 'Voicemail drop sent';
    } else if (content.includes('CALL_INBOUND')) {
      const statusMatch = content.match(/status:(\w+)/);
      const status = statusMatch ? statusMatch[1] : 'inbound';
      const durMatch = content.match(/duration:(\d+s)/);
      const statusLabels = {
        connecting: 'Called in — forwarded to you',
        voicemail_requested: 'Called in — went to voicemail',
        text_back_requested: 'Called in — requested text back',
        completed: 'Call completed' + (durMatch ? ' ' + durMatch[1] : ''),
        'no-answer': 'Called — no answer',
        busy: 'Called — line busy',
        failed: 'Call failed'
      };
      label = statusLabels[status] || 'Inbound call';
    } else if (content.includes('CALL_COMPLETE')) {
      const statusMatch = content.match(/status:(.+)$/);
      label = 'Call ended — ' + (statusMatch ? statusMatch[1] : '');
    }

    return `<div style="display:flex;justify-content:center;margin:8px 0;">
      <div style="background:${bg};border:1px solid ${border};border-radius:8px;padding:7px 16px;text-align:center;">
        <div style="font-size:11px;font-weight:700;color:${color};">${icon} ${label}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px;">${time}</div>
      </div>
    </div>`;
  }

  // ── Regular SMS message ───────────────────────────────────────
  const isUser = m.role === 'user';
  return `<div class="msg-bubble ${m.role}">
    <div class="msg-role">${isUser ? '👤 Customer' : '🤖 Sarah AI'}</div>
    <div style="color:var(--text);line-height:1.5;white-space:pre-wrap;">${escapeHtml(content)}</div>
    <div class="msg-time">${time}</div>
  </div>`;
}

// ── Voicemails ────────────────────────────────────────────────────
async function loadVoicemails(){
  const el = document.getElementById('voicemailsList');
  if(!el) return;
  el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);">Loading...</div>';
  try {
    const token = getAdminToken(); if(!token){ el.innerHTML='<div style="padding:20px;color:var(--muted);">Token required.</div>'; return; }
    const data  = await fetch('/api/voicemails?token='+encodeURIComponent(token)).then(r=>r.json());
    if(!data.success) throw new Error(data.error);
    if(!data.voicemails.length){
      el.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);">No voicemails yet. Once your Twilio number is configured for inbound calls, voicemails will appear here.</div>';
      return;
    }
    el.innerHTML = data.voicemails.map(v => {
      const caller  = (v.caller_phone||'').replace('+1','');
      const date    = v.created_at ? new Date(v.created_at).toLocaleString() : '—';
      const dur     = v.duration   ? v.duration+'s' : '—';
      const hasRec  = v.recording_url && v.recording_url.length > 10;
      const hasTx   = v.transcript  && v.transcript.length > 3;
      return `<div class="appt-card" style="border-left:3px solid var(--primary);">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
          <div>
            <div style="font-weight:700;font-size:13px;">📬 ${caller} <span style="color:var(--muted);font-weight:400;font-size:11px;">${date} · ${dur}</span></div>
            ${hasTx
              ? `<div style="font-size:12px;color:var(--text);margin-top:6px;line-height:1.5;background:var(--surface2);padding:10px;border-radius:6px;border-left:3px solid var(--amber);">"${escapeHtml(v.transcript)}"</div>`
              : '<div style="font-size:11px;color:var(--muted);margin-top:4px;">⏳ Transcript pending...</div>'
            }
          </div>
          <div style="display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap;">
            ${hasRec ? `<a href="${v.recording_url}" target="_blank" class="btn btn-primary btn-sm">▶ Listen</a>` : ''}
            <button class="btn btn-ghost btn-sm" onclick="loadConvToDeskCRM('+1${caller}','','')">→ Desk</button>
          </div>
        </div>
      </div>`;
    }).join('');
  } catch(e){
    el.innerHTML = '<div style="padding:20px;color:var(--red);">❌ '+e.message+'</div>';
  }
}


// ── Mobile hamburger menu ─────────────────────────────────────────
function toggleMobileMenu(){
  const menu    = document.getElementById('mobileMenu');
  const overlay = document.getElementById('mobileOverlay');
  const btn     = document.getElementById('hamburgerBtn');
  const isOpen  = menu.classList.contains('open');
  if(isOpen){ closeMobileMenu(); }
  else {
    menu.classList.add('open');
    overlay.classList.add('open');
    btn.classList.add('open');
    document.body.style.overflow = 'hidden'; // prevent scroll behind
  }
}

function closeMobileMenu(){
  document.getElementById('mobileMenu')?.classList.remove('open');
  document.getElementById('mobileOverlay')?.classList.remove('open');
  document.getElementById('hamburgerBtn')?.classList.remove('open');
  document.body.style.overflow = '';
}

function mobileNav(section){
  closeMobileMenu();
  showSection(section);
  // Scroll to top so you see the section from the start
  window.scrollTo({top:0, behavior:'smooth'});
  // Update active state in mobile menu
  document.querySelectorAll('.mobile-nav-btn').forEach(b=>{
    b.classList.remove('active');
    if(b.getAttribute('onclick')?.includes("'"+section+"'")) b.classList.add('active');
  });
}

// Close menu on ESC key
document.addEventListener('keydown', e => {
  if(e.key === 'Escape') closeMobileMenu();
});

// ── INIT ─────────────────────────────────────────────
document.addEventListener('DOMContentLoaded',()=>{
  applyLenderRateOverrides();
  initInventory();
  initLenderPanels();
  // Restore theme
  if(localStorage.getItem('ffTheme')==='light'){
    document.body.classList.add('light-mode');
    document.getElementById('darkModeBtn').textContent = '🌙 Dark Mode';
  }
  // Apply settings defaults
  setVal('docFee',settings.docFee);
  setVal('gstRate',settings.gst);
  setVal('apr',settings.apr);
  setVal('targetInput',settings.target);
  // Populate settings modal
  setVal('setPerson',settings.salesName);
  setVal('setDealer',settings.dealerName);
  setVal('setDocFee',settings.docFee);
  setVal('setGST',settings.gst);
  setVal('setAPR',settings.apr);
  setVal('setTarget',settings.target);
  calculate();
  refreshAllAnalytics();
  console.log('%c✅ FIRST-FIN DEALER PLATFORM v1.0 LOADED','background:#1e5af6;color:white;padding:10px 20px;font-size:14px;font-weight:bold;border-radius:5px;');
  console.log('%c🚗 Inventory: '+inventory.length+' vehicles | 🏦 Lenders: '+Object.keys(lenders).length,'color:#f59e0b;font-size:12px;');
});

// ═══════════════════════════════════════════════════════════════
// v1.1 ADDITIONS: Presentation, Beacon Badges, Trade Carry,
//                 Scenarios, Rate Compare, Commission, Print,
//                 Lender Rate Editor
// ═══════════════════════════════════════════════════════════════

// ── LENDER RATE EDITOR ───────────────────────────────────────
// Load any locally-saved overrides on top of defaults
function applyLenderRateOverrides(){
  const saved = JSON.parse(localStorage.getItem('ffLenderRates') || '{}');
  Object.entries(saved).forEach(([lid, overrides]) => {
    if(lenders[lid]) Object.assign(lenders[lid], overrides);
  });
}

function buildLenderRateEditor(){
  const grid = document.getElementById('lenderRateEditorGrid');
  grid.innerHTML = '';
  Object.entries(lenders).forEach(([lid, l]) => {
    grid.innerHTML += `
    <div class="lre-card">
      <div class="lre-name">${l.name}</div>
      <div class="lre-row">
        <div class="fgroup"><label>Min Year</label><input type="number" id="lre_${lid}_minYear" value="${l.minYear}" style="background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:7px;width:100%;"></div>
        <div class="fgroup"><label>Max LTV (%)</label><input type="number" id="lre_${lid}_maxLTV" value="${l.maxLTV}" style="background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:7px;width:100%;"></div>
      </div>
      ${l.hard ? `<div class="lre-row">
        <div class="fgroup"><label>Max Mileage (km)</label><input type="number" id="lre_${lid}_maxMileage" value="${l.maxMileage||''}" style="background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:7px;width:100%;"></div>
        <div class="fgroup"><label>Max Carfax ($)</label><input type="number" id="lre_${lid}_maxCarfax" value="${l.maxCarfax||''}" style="background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:7px;width:100%;"></div>
      </div>` : '<div style="font-size:11px;color:var(--muted);padding:4px 0;">Credit-based — no hard vehicle limits</div>'}
    </div>`;
  });
}

function saveLenderRates(){
  const overrides = {};
  Object.keys(lenders).forEach(lid => {
    const o = {};
    const minYr = document.getElementById(`lre_${lid}_minYear`);
    const maxLTV = document.getElementById(`lre_${lid}_maxLTV`);
    const maxMile = document.getElementById(`lre_${lid}_maxMileage`);
    const maxCfx = document.getElementById(`lre_${lid}_maxCarfax`);
    if(minYr) { o.minYear = parseInt(minYr.value)||lenders[lid].minYear; lenders[lid].minYear = o.minYear; }
    if(maxLTV) { o.maxLTV = parseInt(maxLTV.value)||lenders[lid].maxLTV; lenders[lid].maxLTV = o.maxLTV; }
    if(maxMile) { o.maxMileage = parseInt(maxMile.value)||lenders[lid].maxMileage; lenders[lid].maxMileage = o.maxMileage; }
    if(maxCfx) { o.maxCarfax = parseInt(maxCfx.value)||lenders[lid].maxCarfax; lenders[lid].maxCarfax = o.maxCarfax; }
    overrides[lid] = o;
  });
  localStorage.setItem('ffLenderRates', JSON.stringify(overrides));
  closeModal('lenderRateModal');
  toast('✅ Lender rates saved & active!');
}

function resetLenderRates(){
  if(!confirm('Reset all lender rates to defaults?')) return;
  localStorage.removeItem('ffLenderRates');
  location.reload();
}

// ── PRESENTATION MODE ─────────────────────────────────────────
function openPresentation(){
  const desc  = getVal('vehicleDesc') || 'Your Vehicle';
  const stock = getVal('stockNum');
  const km    = getVal('odometer');
  const type  = getVal('vehicleType');
  const apr   = parseFloat(getVal('apr'))||0;
  const dealer= settings.dealerName || 'FIRST FINANCIAL';

  const price    = parseFloat(getVal('sellingPrice'))||0;
  const doc      = parseFloat(getVal('docFee'))||0;
  const tAllow   = parseFloat(getVal('tradeAllow'))||0;
  const tPayoff  = parseFloat(getVal('tradePayoff'))||0;
  const gst      = parseFloat(getVal('gstRate'))||5;
  const vsc      = parseFloat(getVal('vscPrice'))||0;
  const gap      = parseFloat(getVal('gapPrice'))||0;
  const tw       = parseFloat(getVal('twPrice'))||0;
  const wa       = parseFloat(getVal('waPrice'))||0;
  const netTrade = tAllow - tPayoff;
  const gstAmt   = (price + doc - netTrade) * (gst/100);
  const otd      = price + doc - netTrade + gstAmt;
  const products = vsc + gap + tw + wa;
  const finance  = otd + products;
  const mr       = apr / 100 / 12;

  document.getElementById('presDealer').textContent = dealer.toUpperCase();
  document.getElementById('presVehicle').textContent = desc.toUpperCase();
  const subParts = [];
  if(stock) subParts.push('Stock #' + stock);
  if(km)    subParts.push(parseInt(km).toLocaleString() + ' km');
  if(type)  subParts.push(type);
  document.getElementById('presSub').textContent = subParts.join('  ·  ') || 'Professional Financing Available';

  const downs = [
    {label:'No Money Down', down: 0},
    {label:'$2,000 Down',   down: 2000},
    {label:'$5,000 Down',   down: 5000},
  ];
  const terms = [60, 72, 84];

  // Show 72 month no-money-down as featured card, others around it
  const finalDown = parseFloat(document.getElementById('finalDown')?.value)||0;
  let cardsHTML = '';
  const featured_term = 72;
  [60, 72, 84].forEach(term => {
    const fin = Math.max(0, finance - finalDown);
    const pmt = PMT(mr, term, -fin);
    const featured = term === featured_term;
    cardsHTML += `
    <div class="pres-pmt-card ${featured?'featured':''}">
      <div class="pres-term">${term} MONTHS</div>
      <div class="pres-amount">${$f(pmt)}</div>
      <div class="pres-monthly">/month</div>
      ${finalDown>0?`<div class="pres-down-note">$${finalDown.toLocaleString()} down</div>`:'<div class="pres-obo">No money down</div>'}
    </div>`;
  });

  document.getElementById('presPaymentLadder').innerHTML = cardsHTML;
  document.getElementById('presentationOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closePresentation(){
  document.getElementById('presentationOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

// ESC to close presentation
document.addEventListener('keydown', e => {
  if(e.key === 'Escape') closePresentation();
});

// ── BEACON LENDER MATCH BADGES ────────────────────────────────
function runBeaconMatch(){
  const beacon = parseInt(getVal('creditScore')) || 0;
  const stock  = getVal('stockNum');
  const row    = document.getElementById('beaconLenderRow');
  const badges = document.getElementById('beaconBadges');

  if(!beacon){ toast('⚠️ Enter a Beacon score first'); return; }
  if(!stock){  toast('⚠️ Select a vehicle first'); return; }

  const v = inventory.find(x => x.stock === stock);
  row.style.display = 'block';
  badges.innerHTML = '';

  Object.entries(lenders).forEach(([lid, l]) => {
    // Determine eligibility label and style
    let label, cls;

    if(!l.hard){
      // Credit-based lenders
      if(l.name.includes('RBC') || l.name.includes('CIBC')){
        if(beacon >= 700){ label = l.name.split(' ')[0] + ' ✓'; cls = 'bln-green'; }
        else if(beacon >= 650){ label = l.name.split(' ')[0] + ' ~'; cls = 'bln-amber'; }
        else{ label = l.name.split(' ')[0] + ' ✕'; cls = 'bln-red'; }
      } else {
        label = l.name.split(' ')[0] + ' ℹ️'; cls = 'bln-blue';
      }
    } else {
      // Hard limit lenders — check vehicle + beacon
      const vehicleOk = v && (v.year >= l.minYear) &&
        (l.maxMileage ? v.mileage <= l.maxMileage : true) &&
        (l.maxCarfax  ? v.carfax  <= l.maxCarfax  : true);

      const shortName = l.name.split(' ')[0];
      if(!vehicleOk){ label = shortName + ' ✕ Vehicle'; cls = 'bln-red'; }
      else {
        // Rough beacon tier matching
        const minFico = l.programs.length ? parseInt(l.programs[0].fico) || 0 : 0;
        if(beacon >= 640){ label = shortName + ' ✓'; cls = 'bln-green'; }
        else if(beacon >= 580){ label = shortName + ' ~'; cls = 'bln-amber'; }
        else if(l.name.includes('NorthLake') || l.name.includes('SDA') || l.name.includes('Iceberg')){
          label = shortName + ' ✓ SubP'; cls = 'bln-amber';
        } else { label = shortName + ' ✕'; cls = 'bln-red'; }
      }
    }

    badges.innerHTML += `<span class="bln-badge ${cls}">${label}</span>`;
  });
}

// Also auto-run on beacon score change
const origAssessRisk = assessRisk;
assessRisk = function(){
  origAssessRisk();
  const beacon = parseInt(getVal('creditScore')) || 0;
  const stock  = getVal('stockNum');
  if(beacon >= 300 && stock) runBeaconMatch();
};

// ── TRADE EQUITY AUTO-CARRY ───────────────────────────────────
function carryTradeEquity(){
  const acv     = parseFloat(getVal('acv')) || 0;
  const adj     = parseFloat(getVal('conditionAdj')) || 0;
  const safety  = parseFloat(getVal('safetyInspect')) || 0;
  const recon   = parseFloat(getVal('reconditionCost')) || 0;
  const tPayoff = parseFloat(getVal('tradePayoff')) || 0;
  const adjustedACV = acv - (adj + safety + recon);
  // Set trade allowance to adjusted ACV and payoff stays as-is
  document.getElementById('tradeAllow').value = Math.max(0, adjustedACV).toFixed(0);
  calculateTrade();
  calculate();
  toast('✅ Trade ACV applied to Deal Structure!');
}

// ── DEAL SCENARIOS A / B / C ─────────────────────────────────
let scenarios = JSON.parse(localStorage.getItem('ffScenarios') || '[null,null,null]');

function renderScenarios(){
  scenarios.forEach((sc, i) => {
    const card    = document.getElementById('sc' + i);
    const dataEl  = document.getElementById('sc' + i + 'data');
    const badge   = document.getElementById('sc' + i + 'badge');
    const labelEl = document.getElementById('sc' + i + 'label');
    if(sc){
      const v = sc.vehicle || {};
      const f = sc.financial || {};
      const p = sc.products  || {};
      const vsc = parseFloat(p.vscPrice)||0, gap = parseFloat(p.gapPrice)||0,
            tw  = parseFloat(p.twPrice)||0,  wa  = parseFloat(p.waPrice)||0;
      const price   = parseFloat(f.price)||0;
      const apr_val = parseFloat(f.apr)||0;
      const doc_val = parseFloat(f.doc)||0;
      const tA      = parseFloat(f.tAllow)||0;
      const tP      = parseFloat(f.tPayoff)||0;
      const gst_v   = parseFloat(f.gst)||5;
      const netTr   = tA - tP;
      const gstA    = (price + doc_val - netTr) * (gst_v/100);
      const otd     = price + doc_val - netTr + gstA;
      const products= vsc + gap + tw + wa;
      const mr      = apr_val / 100 / 12;
      const pmt72   = PMT(mr, 72, -(otd + products));
      const prods   = [vsc?'VSC':'',gap?'GAP':'',tw?'T&W':'',wa?'WA':''].filter(Boolean);
      if(sc.label) labelEl.value = sc.label;
      dataEl.innerHTML = `<span class="sc-payment">${$f(pmt72)}<span style="font-size:12px;font-weight:400;">/mo</span></span>
        <strong>${v.desc||'—'}</strong><br>
        Price: ${$f(price)} · APR: ${apr_val}%<br>
        ${prods.length?'Products: '+prods.join(', '):'No F&I products'}`;
      dataEl.style.fontStyle = 'normal';
      badge.textContent = '✓ Saved';
      badge.style.color = 'var(--green)';
      card.classList.add('has-data');
    } else {
      dataEl.innerHTML = 'No deal saved yet.';
      dataEl.style.fontStyle = 'italic';
      badge.textContent = 'Empty';
      badge.style.color = 'var(--muted)';
      card.classList.remove('has-data');
    }
  });
}

function saveScenario(i){
  const d = getDealData();
  d.label = document.getElementById('sc' + i + 'label').value;
  scenarios[i] = d;
  localStorage.setItem('ffScenarios', JSON.stringify(scenarios));
  renderScenarios();
  toast(`💾 Scenario ${['A','B','C'][i]} saved!`);
}

function loadScenario(i){
  if(!scenarios[i]){ toast('⚠️ No scenario saved in this slot'); return; }
  localStorage.setItem('ffCurrentDeal', JSON.stringify(scenarios[i]));
  loadDeal();
  toast(`📂 Scenario ${['A','B','C'][i]} loaded!`);
}

function clearScenario(i){
  if(!confirm('Clear this scenario?')) return;
  scenarios[i] = null;
  localStorage.setItem('ffScenarios', JSON.stringify(scenarios));
  renderScenarios();
  toast('✕ Cleared');
}

// ── RATE COMPARISON ───────────────────────────────────────────
function updateRateComparison(){
  const price    = parseFloat(getVal('sellingPrice'))||0;
  const doc      = parseFloat(getVal('docFee'))||0;
  const tAllow   = parseFloat(getVal('tradeAllow'))||0;
  const tPayoff  = parseFloat(getVal('tradePayoff'))||0;
  const gst      = parseFloat(getVal('gstRate'))||5;
  const vsc      = parseFloat(getVal('vscPrice'))||0;
  const gap      = parseFloat(getVal('gapPrice'))||0;
  const tw       = parseFloat(getVal('twPrice'))||0;
  const wa       = parseFloat(getVal('waPrice'))||0;
  const buyRate  = parseFloat(document.getElementById('rc_buy')?.value)||0;
  const conRate  = parseFloat(document.getElementById('rc_contract')?.value)||0;
  const maxRate  = parseFloat(document.getElementById('rc_max')?.value)||0;
  const tbody    = document.getElementById('rateCompareBody');
  if(!tbody || !price) return;

  const netTrade = tAllow - tPayoff;
  const gstAmt   = (price + doc - netTrade) * (gst/100);
  const otd      = price + doc - netTrade + gstAmt + vsc + gap + tw + wa;

  const terms = [48, 60, 72, 84];
  let html = '';
  terms.forEach(t => {
    const pBuy = PMT(buyRate/100/12, t, -otd);
    const pCon = PMT(conRate/100/12, t, -otd);
    const pMax = PMT(maxRate/100/12, t, -otd);
    // Reserve estimate: (pCon - pBuy) spread per month
    const reservePerMo = pCon - pBuy;
    html += `<tr>
      <td><strong>${t} mo</strong></td>
      <td class="rc-buy">${$f(pBuy)}</td>
      <td class="rc-contract">${$f(pCon)}</td>
      <td class="rc-max">${$f(pMax)}</td>
      <td style="color:var(--green);">+${$f(reservePerMo)}</td>
    </tr>`;
  });
  tbody.innerHTML = html;
}

// ── COMMISSION CALCULATOR ─────────────────────────────────────
function calcCommission(){
  // Pull live profit values from the DOM output fields
  const frontText = document.getElementById('frontGross')?.textContent || '$0';
  const frontGross = parseFloat(frontText.replace(/[$,]/g,'')) || 0;

  const vscP = parseFloat(document.getElementById('vscProfit')?.textContent) || 0;
  const gapP = parseFloat(document.getElementById('gapProfit')?.textContent) || 0;
  const twP  = parseFloat(document.getElementById('twProfit')?.textContent)  || 0;
  const waP  = parseFloat(document.getElementById('waProfit')?.textContent)  || 0;
  const backGross = vscP + gapP + twP + waP + 500; // +$500 reserve

  const frontPct = parseFloat(getVal('commFrontPct')) / 100 || 0;
  const backPct  = parseFloat(getVal('commBackPct'))  / 100 || 0;
  const flat     = parseFloat(getVal('commFlat'))     || 0;

  const frontComm = Math.max(0, frontGross) * frontPct;
  const backComm  = Math.max(0, backGross)  * backPct;
  const total     = frontComm + backComm + flat;

  document.getElementById('commTotal').textContent = $f(total);
  document.getElementById('commBreakdown').innerHTML =
    `Front (${(frontPct*100).toFixed(0)}% of ${$i(frontGross)}): <strong style="color:var(--text);">${$f(frontComm)}</strong><br>` +
    `Back (${(backPct*100).toFixed(0)}% of ${$i(backGross)}): <strong style="color:var(--text);">${$f(backComm)}</strong>` +
    (flat ? `<br>Flat/Bonus: <strong style="color:var(--text);">${$f(flat)}</strong>` : '');
}

// ── PRINT WORKSHEET ───────────────────────────────────────────
function printWorksheet(){
  // Populate the hidden printWorksheet div
  const v = getVal('vehicleDesc'), stock = getVal('stockNum'), vin = getVal('vin');
  const km = getVal('odometer'), cond = getVal('condition');
  const name = getVal('custName'), phone = getVal('custPhone'), email = getVal('custEmail');
  const price = parseFloat(getVal('sellingPrice'))||0;
  const doc   = parseFloat(getVal('docFee'))||0;
  const tA    = parseFloat(getVal('tradeAllow'))||0;
  const tP    = parseFloat(getVal('tradePayoff'))||0;
  const apr   = parseFloat(getVal('apr'))||0;
  const gst   = parseFloat(getVal('gstRate'))||5;
  const vsc   = parseFloat(getVal('vscPrice'))||0;
  const gap   = parseFloat(getVal('gapPrice'))||0;
  const tw    = parseFloat(getVal('twPrice'))||0;
  const wa    = parseFloat(getVal('waPrice'))||0;
  const netTr = tA - tP;
  const gstA  = (price + doc - netTr) * (gst/100);
  const otd   = price + doc - netTr + gstA;
  const mr    = apr/100/12;

  const setTxt = (id, val) => { const e = document.getElementById(id); if(e) e.textContent = val; };
  setTxt('pw-dealer-name', settings.dealerName || 'FIRST FINANCIAL');
  setTxt('pw-date', new Date().toLocaleDateString('en-CA', {weekday:'long',year:'numeric',month:'long',day:'numeric'}));
  setTxt('pw-desc', v || '—'); setTxt('pw-stock', stock || '—'); setTxt('pw-vin', vin || '—');
  setTxt('pw-km', km ? parseInt(km).toLocaleString()+' km' : '—'); setTxt('pw-cond', cond || '—');
  setTxt('pw-name', name || '—'); setTxt('pw-phone', phone || '—'); setTxt('pw-email', email || '—');
  setTxt('pw-price', $f(price)); setTxt('pw-doc', $f(doc));
  setTxt('pw-trade', $f(tA)); setTxt('pw-payoff', $f(tP));
  setTxt('pw-gst', $f(gstA) + ' (' + gst + '%)'); setTxt('pw-apr', apr + '%');
  setTxt('pw-otd', $f(otd));
  setTxt('pw-vsc', vsc > 0 ? $f(vsc) : '— Not selected');
  setTxt('pw-gap', gap > 0 ? $f(gap) : '— Not selected');
  setTxt('pw-tw',  tw  > 0 ? $f(tw)  : '— Not selected');
  setTxt('pw-wa',  wa  > 0 ? $f(wa)  : '— Not selected');

  // Build print payment grid
  const downs = [0, 2000, 5000];
  const terms = [48, 60, 72, 84];
  let pgHTML = '<div class="pw-payment-grid">';
  // Header row
  pgHTML += '<div class="pw-pg-cell header">Down</div>';
  terms.forEach(t => pgHTML += `<div class="pw-pg-cell header">${t} Months</div>`);
  // Payment rows
  downs.forEach(d => {
    pgHTML += `<div class="pw-pg-cell"><strong>$${d.toLocaleString()}</strong></div>`;
    terms.forEach(t => {
      const pmt = PMT(mr, t, -(otd + vsc + gap + tw + wa - d));
      pgHTML += `<div class="pw-pg-cell payment">${$f(pmt)}</div>`;
    });
  });
  pgHTML += '</div>';
  document.getElementById('pw-payment-grid').innerHTML = pgHTML;

  window.print();
  toast('🖨️ Printing worksheet...');
}

// ── HOOK calculate() to also update Rate Comparison ──────────
const _origCalculate = calculate;
calculate = function(){
  _origCalculate();
  updateRateComparison();
  calcCommission();
};

</script>

<script>
(function(){
  var BRIDGE='http://localhost:5001';
  var dtContacts=[];
  var dtCRMCount=0;
  var dtLogCount=0;
  var dtPollTimer=null;
  var dtOnline=false;

  function dtLog(msg){
    var box=document.getElementById('dt-log');
    if(!box)return;
    var d=document.createElement('div');
    d.className='dt-log-line'+(msg.indexOf('Error')>-1||msg.indexOf('❌')>-1?' err':msg.indexOf('💾')>-1||msg.indexOf('✅')>-1?' ok':'');
    d.textContent=msg;
    box.appendChild(d);
    box.scrollTop=box.scrollHeight;
  }

  function dtSetDot(color,label){
    var dot=document.getElementById('dt-dot');
    var lbl=document.getElementById('dt-bridge-label');
    if(dot)dot.className='dt-dot '+color;
    if(lbl)lbl.textContent=label;
  }

  async function dtPing(){
    try{
      var r=await fetch(BRIDGE+'/ping',{signal:AbortSignal.timeout(2000)});
      var d=await r.json();
      if(d.ok){
        dtOnline=true;
        dtSetDot('green','Bridge connected — ready');
        document.getElementById('dt-btn-start').disabled=false;
        var sb=document.getElementById('dt-setup-box');
        if(sb)sb.style.display='none';
      }
    }catch(e){
      dtOnline=false;
      dtSetDot('red','Bridge offline — run dealertrack_scraper.py first');
      document.getElementById('dt-btn-start').disabled=true;
    }
  }

  async function dtPoll(){
    if(!dtOnline){dtPing();return;}
    try{
      var sr=await fetch(BRIDGE+'/status',{signal:AbortSignal.timeout(2000)});
      var s=await sr.json();
      var pct=s.total_rows>0?Math.round((s.current_row/s.total_rows)*100):0;
      document.getElementById('dt-prog-fill').style.width=pct+'%';
      document.getElementById('dt-prog-pct').textContent=pct+'%';
      document.getElementById('dt-prog-label').textContent=s.total_rows>0?'Row '+s.current_row+' of '+s.total_rows:'Waiting...';
      document.getElementById('dt-prog-msg').textContent=s.status_msg||'';
      document.getElementById('dt-s-total').textContent=s.total_saved||0;
      document.getElementById('dt-s-deals').textContent=s.current_row||0;
      document.getElementById('dt-s-remain').textContent=s.total_rows>0?(s.total_rows-s.current_row):'—';
      document.getElementById('dt-btn-start').disabled=s.running;
      document.getElementById('dt-btn-stop').disabled=!s.running;
      if(s.running){dtSetDot('yellow','Running — Deal #'+(s.current_deal||'...'));}
      else if(s.total_saved>0){dtSetDot('green','Done — '+s.total_saved+' contacts captured');}
      if(s.log&&s.log.length>dtLogCount){s.log.slice(dtLogCount).forEach(function(l){dtLog(l);});dtLogCount=s.log.length;}
      var cr=await fetch(BRIDGE+'/contacts',{signal:AbortSignal.timeout(2000)});
      var contacts=await cr.json();
      if(contacts.length>dtContacts.length){
        var newOnes=contacts.slice(dtContacts.length);
        dtContacts=contacts;
        newOnes.forEach(function(c){
          var empty=document.getElementById('dt-feed-empty');
          if(empty)empty.remove();
          var feed=document.getElementById('dt-feed');
          var row=document.createElement('div');
          row.className='dt-feed-row';
          var name=((c.first_name||'')+' '+(c.last_name||'')).trim()||'Unknown';
          var phone=c.mobile_phone||c.phone||'—';
          var email=c.email||'—';
          var isCo=c.applicant_type==='CO-APPLICANT';
          row.innerHTML='<div><div class="dt-feed-name">'+name+'</div><div class="dt-feed-detail">'+phone+'</div><div class="dt-feed-detail">'+email+'</div></div>'
            +'<span class="dt-badge-src'+(isCo?' dt-badge-co':'')+'">'+(isCo?'CO':'PRIMARY')+'</span>';
          feed.prepend(row);
        });
        document.getElementById('dt-btn-crm').disabled=(dtContacts.length===0);
      }
    }catch(e){
      dtOnline=false;
      dtSetDot('red','Bridge connection lost');
    }
  }

  window.dtStart=async function(){
    try{
      dtLogCount=0;
      document.getElementById('dt-log').innerHTML='';
      var r=await fetch(BRIDGE+'/start',{method:'POST'});
      var d=await r.json();
      if(!d.ok)alert(d.msg);
    }catch(e){alert('Could not reach bridge. Make sure dealertrack_scraper.py is running.');}
  };

  window.dtStop=async function(){
    try{await fetch(BRIDGE+'/stop',{method:'POST'});}catch(e){}
  };

  window.dtClear=async function(){
    if(!confirm('Clear all captured contacts?'))return;
    try{
      await fetch(BRIDGE+'/clear',{method:'POST'});
      dtContacts=[];dtLogCount=0;dtCRMCount=0;
      document.getElementById('dt-feed').innerHTML='<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px;" id="dt-feed-empty">No contacts yet</div>';
      document.getElementById('dt-log').innerHTML='';
      document.getElementById('dt-s-crm').textContent='0';
      document.getElementById('dt-s-total').textContent='0';
      document.getElementById('dt-btn-crm').disabled=true;
    }catch(e){}
  };

  window.dtExportCSV=function(){
    if(!dtContacts.length){alert('No contacts to export yet.');return;}
    var fields=['first_name','last_name','phone','mobile_phone','email','address_no','street_name','city','province','postal_code','deal_number','lender','status','source','captured_at'];
    var rows=[fields.join(',')];
    dtContacts.forEach(function(c){rows.push(fields.map(function(f){return '"'+((c[f]||'').toString().replace(/"/g,'""'))+'"';}).join(','));});
    var a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([rows.join('\n')],{type:'text/csv'}));
    a.download='dt_contacts_'+new Date().toISOString().slice(0,10)+'.csv';
    a.click();
  };

  window.dtPushCRM=function(){
    if(!dtContacts.length){alert('No contacts to push.');return;}
    var pushed=0;
    dtContacts.forEach(function(c){
      var name=((c.first_name||'')+' '+(c.last_name||'')).trim();
      if(!name)return;
      var exists=crmData.some(function(e){return e.name===name&&e.vehicle&&e.vehicle.indexOf('DT Scrape')>-1&&e.vehicle.indexOf(c.deal_number)>-1;});
      if(exists)return;
      crmData.unshift({
        id:Date.now()+Math.random(),
        date:new Date().toLocaleDateString('en-CA'),
        name:name,
        phone:c.mobile_phone||c.phone||'',
        email:c.email||'',
        vehicle:'DT Scrape'+(c.lender?' | '+c.lender:'')+(c.deal_number?' | #'+c.deal_number:''),
        stock:'',
        beacon:'',
        status:'Lead'
      });
      pushed++;
    });
    if(pushed>0){
      localStorage.setItem('ffCRM',JSON.stringify(crmData));
      renderCRM();
      dtCRMCount+=pushed;
      document.getElementById('dt-s-crm').textContent=dtCRMCount;
      var t=document.getElementById('dt-crm-toast');
      t.textContent=pushed+' contacts pushed to CRM!';
      t.style.display='block';
      setTimeout(function(){t.style.display='none';},3000);
      if(typeof toast==='function')toast(pushed+' DT contacts added to CRM!');
    }else{
      if(typeof toast==='function')toast('All contacts already in CRM');
    }
  };

  function dtInit(){
    dtPing();
    if(!dtPollTimer)dtPollTimer=setInterval(dtPoll,1500);
  }

  var _origShow=window.showSection;
  window.showSection=function(id,btn){
    _origShow(id,btn);
    if(id==='dtsync')dtInit();
  };
})();
</script>
</body>
</html>
